<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="漫漫技术路">
<meta property="og:url" content="https://zrysmt.github.io/index.html">
<meta property="og:site_name" content="漫漫技术路">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="漫漫技术路">






  <link rel="canonical" href="https://zrysmt.github.io/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>漫漫技术路</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">漫漫技术路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/09/23/使用React+Three.js封装一个三维地球/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/09/23/使用React+Three.js封装一个三维地球/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">使用React+Three.js 封装一个三维地球</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-09-23 17:43:15" itemprop="dateCreated datePublished" datetime="2017-09-23T17:43:15+08:00">2017-09-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:06:50" itemprop="dateModified" datetime="2018-11-30T11:06:50+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>良久没有写过博客了，最近忙的焦头烂额，忽略了博客，罪过罪过。今天补充一篇，前一段时间研究过的技术，使用React+Three.js 封装一个三维地球，支持鼠标的交互行为。其实也实现了对有坐标的json数据展示在地球上的功能，以后会有补充。</p>
<p><a href="https://github.com/zrysmt/react-threejs-app" target="_blank" rel="noopener">github仓库地址</a>:</p>
<blockquote>
<p><a href="https://github.com/zrysmt/react-threejs-app" target="_blank" rel="noopener">https://github.com/zrysmt/react-threejs-app</a></p>
</blockquote>
<p>整体做完之后的效果图：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/react%2Bthreejs/1.jpg" alt=""><br>废话少说，直接上环境</p>
<h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>使用facebook给出的脚手架工具<a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="noopener">create-react-app</a>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install -g create-react-app</span><br><span class="line"></span><br><span class="line">create-react-app react-threejs-app</span><br><span class="line"><span class="built_in">cd</span> react-threejs-app/</span><br></pre></td></tr></table></figure>
<p>执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure></p>
<p>浏览器会自动打开<code>localhost:3000</code>。</p>
<h2 id="2-背景知识"><a href="#2-背景知识" class="headerlink" title="2.背景知识"></a>2.背景知识</h2><p>Three.js简单来说就是封装了WebGL一些易用的API接口，我们知道只使用WebGL比较低效。具体的关于WebGL的技术给出两篇博客的入口,关于Three.js可以参考文章最后给出的参考阅读部分。</p>
<ul>
<li><a href="https://zrysmt.github.io/2017/05/17/WebGL%E5%9F%BA%E7%A1%80%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B1-%E7%AE%80%E4%BB%8B/">WebGL基础简明教程1-简介</a></li>
<li><a href="https://zrysmt.github.io/2017/05/17/WebGL%E5%9F%BA%E7%A1%80%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B2-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">WebGL基础简明教程2-基础知识</a></li>
</ul>
<p>如果不是很了解WebGL技术也没有关系，不妨现在先看看Three.js创建模型的整体过程。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/react%2Bthreejs/2.png" alt=""></p>
<p>安装需要的库,<code>three</code>是Three.js的库，<code>three-orbitcontrols</code>用来支持鼠标的交互行为的库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i three three-orbitcontrols --save</span><br></pre></td></tr></table></figure></p>
<h2 id="3-一步一个脚印"><a href="#3-一步一个脚印" class="headerlink" title="3.一步一个脚印"></a>3.一步一个脚印</h2><h3 id="3-1-准备一张高清的世界地图"><a href="#3-1-准备一张高清的世界地图" class="headerlink" title="3.1 准备一张高清的世界地图"></a>3.1 准备一张高清的世界地图</h3><p>这里在github仓库中已经给出。</p>
<h3 id="3-2-定义一个组件ThreeMap"><a href="#3-2-定义一个组件ThreeMap" class="headerlink" title="3.2 定义一个组件ThreeMap"></a>3.2 定义一个组件<code>ThreeMap</code></h3><p>在<code>ThreeMap.js</code>定义组件<code>ThreeMap</code>，并且创建改组件的样式<code>ThreeMap.css</code>。css定义三维地球的容器的宽度和高度。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#WebGL-output</span>&#123;</span><br><span class="line">	<span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">	<span class="attribute">height</span>: <span class="number">700px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>并且该组件在<code>App.js</code>引用。</p>
<h3 id="3-3-引入库和样式"><a href="#3-3-引入库和样式" class="headerlink" title="3.3 引入库和样式"></a>3.3 引入库和样式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./ThreeMap.css'</span>;</span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">'three'</span>;</span><br><span class="line"><span class="keyword">import</span> Orbitcontrols <span class="keyword">from</span> <span class="string">'three-orbitcontrols'</span>;</span><br><span class="line"><span class="keyword">import</span> Stats <span class="keyword">from</span> <span class="string">'./common/threejslibs/stats.min.js'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-初始化方法入口和要渲染的虚拟DOM"><a href="#3-4-初始化方法入口和要渲染的虚拟DOM" class="headerlink" title="3.4 初始化方法入口和要渲染的虚拟DOM"></a>3.4 初始化方法入口和要渲染的虚拟DOM</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount()&#123;</span><br><span class="line">	<span class="keyword">this</span>.initThree();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要渲染的虚拟DOM设定好<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">render()&#123;</span><br><span class="line">	<span class="keyword">return</span>(</span><br><span class="line">		&lt;div id=<span class="string">'WebGL-output'</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">	)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-4-initThree方法"><a href="#3-4-initThree方法" class="headerlink" title="3.4 initThree方法"></a>3.4 initThree方法</h3><ul>
<li>创建场景</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> scene;</span><br><span class="line">scene = <span class="keyword">new</span> THREE.Scene();</span><br></pre></td></tr></table></figure>
<ul>
<li>创建Group</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> group;</span><br><span class="line">group = <span class="keyword">new</span> THREE.Group();</span><br><span class="line">scene.add( group );</span><br></pre></td></tr></table></figure>
<ul>
<li>创建相机</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">camera = <span class="keyword">new</span> THREE.PerspectiveCamera( <span class="number">60</span>, width / height, <span class="number">1</span>, <span class="number">2000</span> );</span><br><span class="line">camera.position.x = <span class="number">-10</span>;</span><br><span class="line">camera.position.y = <span class="number">15</span>;</span><br><span class="line">camera.position.z = <span class="number">500</span>;</span><br><span class="line">camera.lookAt( scene.position );</span><br></pre></td></tr></table></figure>
<ul>
<li>相机作为<code>Orbitcontrols</code>的参数，支持鼠标交互</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> orbitControls = <span class="keyword">new</span> Orbitcontrols(camera);</span><br><span class="line">orbitControls.autoRotate = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>添加光源:环境光和点光源</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ambi = <span class="keyword">new</span> THREE.AmbientLight(<span class="number">0x686868</span>); <span class="comment">//环境光</span></span><br><span class="line">scene.add(ambi);</span><br><span class="line"><span class="keyword">let</span> spotLight = <span class="keyword">new</span> THREE.DirectionalLight(<span class="number">0xffffff</span>);  <span class="comment">//点光源</span></span><br><span class="line">spotLight.position.set(<span class="number">550</span>, <span class="number">100</span>, <span class="number">550</span>);  </span><br><span class="line">spotLight.intensity = <span class="number">0.6</span>;</span><br><span class="line">scene.add(spotLight);</span><br></pre></td></tr></table></figure>
<ul>
<li>创建模型和材质</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> loader = <span class="keyword">new</span> THREE.TextureLoader();</span><br><span class="line"><span class="keyword">let</span> planetTexture = <span class="built_in">require</span>(<span class="string">"./assets/imgs/planets/Earth.png"</span>);</span><br><span class="line"></span><br><span class="line">loader.load( planetTexture, <span class="function"><span class="keyword">function</span> (<span class="params"> texture </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> geometry = <span class="keyword">new</span> THREE.SphereGeometry( <span class="number">200</span>, <span class="number">20</span>, <span class="number">20</span> );</span><br><span class="line">	<span class="keyword">let</span> material = <span class="keyword">new</span> THREE.MeshBasicMaterial( &#123; <span class="attr">map</span>: texture, <span class="attr">overdraw</span>: <span class="number">0.5</span> &#125; );</span><br><span class="line">	<span class="keyword">let</span> mesh = <span class="keyword">new</span> THREE.Mesh( geometry, material );</span><br><span class="line">	group.add( mesh );</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<ul>
<li>渲染</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> renderer;</span><br><span class="line">renderer = <span class="keyword">new</span> THREE.WebGLRenderer();</span><br><span class="line">renderer.setClearColor( <span class="number">0xffffff</span> );</span><br><span class="line">renderer.setPixelRatio( <span class="built_in">window</span>.devicePixelRatio );</span><br><span class="line">renderer.setSize( width, height );</span><br><span class="line">container.appendChild( renderer.domElement );</span><br></pre></td></tr></table></figure>
<ul>
<li>增加监控的信息状态</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stats = <span class="keyword">new</span> Stats();</span><br><span class="line">container.appendChild( stats.dom );</span><br></pre></td></tr></table></figure>
<p><strong>将以上封装到<code>init</code>函数中</strong></p>
<ul>
<li>动态渲染，地球自转</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	requestAnimationFrame( animate );</span><br><span class="line">	render();</span><br><span class="line">	stats.update();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	group.rotation.y -= <span class="number">0.005</span>;  <span class="comment">//这行可以控制地球自转</span></span><br><span class="line">	renderer.render( scene, camera );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的顺序是：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">init();</span><br><span class="line">animate();</span><br></pre></td></tr></table></figure></p>
<p>大功告成，一个可交互的三维地球就可以使用了。</p>
<h2 id="4-ThreeMap-js整体代码"><a href="#4-ThreeMap-js整体代码" class="headerlink" title="4.ThreeMap.js整体代码"></a>4.<code>ThreeMap.js</code>整体代码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./ThreeMap.css'</span>;</span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">'three'</span>;</span><br><span class="line"><span class="keyword">import</span> Orbitcontrols <span class="keyword">from</span> <span class="string">'three-orbitcontrols'</span>;</span><br><span class="line"><span class="keyword">import</span> Stats <span class="keyword">from</span> <span class="string">'./common/threejslibs/stats.min.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreeMap</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line"> 	componentDidMount()&#123;</span><br><span class="line">		<span class="keyword">this</span>.initThree();</span><br><span class="line">	&#125;</span><br><span class="line">	initThree()&#123;</span><br><span class="line">		<span class="keyword">let</span> stats;</span><br><span class="line">		<span class="keyword">let</span> camera, scene, renderer;</span><br><span class="line">		<span class="keyword">let</span> group;</span><br><span class="line">		<span class="keyword">let</span> container = <span class="built_in">document</span>.getElementById(<span class="string">'WebGL-output'</span>);</span><br><span class="line">		<span class="keyword">let</span> width = container.clientWidth,height = container.clientHeight;</span><br><span class="line"></span><br><span class="line">		init();</span><br><span class="line">		animate();</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			scene = <span class="keyword">new</span> THREE.Scene();</span><br><span class="line">			group = <span class="keyword">new</span> THREE.Group();</span><br><span class="line">			scene.add( group );</span><br><span class="line"></span><br><span class="line">			camera = <span class="keyword">new</span> THREE.PerspectiveCamera( <span class="number">60</span>, width / height, <span class="number">1</span>, <span class="number">2000</span> );</span><br><span class="line">			camera.position.x = <span class="number">-10</span>;</span><br><span class="line">        	camera.position.y = <span class="number">15</span>;</span><br><span class="line">			camera.position.z = <span class="number">500</span>;</span><br><span class="line">			camera.lookAt( scene.position );</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//控制地球</span></span><br><span class="line">			<span class="keyword">let</span> orbitControls = <span class="keyword">new</span> <span class="comment">/*THREE.OrbitControls*/</span>Orbitcontrols(camera);</span><br><span class="line">        	orbitControls.autoRotate = <span class="literal">false</span>;</span><br><span class="line">        	<span class="comment">// let clock = new THREE.Clock();</span></span><br><span class="line">        	<span class="comment">//光源</span></span><br><span class="line">        	<span class="keyword">let</span> ambi = <span class="keyword">new</span> THREE.AmbientLight(<span class="number">0x686868</span>);</span><br><span class="line">        	scene.add(ambi);</span><br><span class="line"></span><br><span class="line">        	<span class="keyword">let</span> spotLight = <span class="keyword">new</span> THREE.DirectionalLight(<span class="number">0xffffff</span>);</span><br><span class="line">        	spotLight.position.set(<span class="number">550</span>, <span class="number">100</span>, <span class="number">550</span>);</span><br><span class="line">        	spotLight.intensity = <span class="number">0.6</span>;</span><br><span class="line"></span><br><span class="line">        	scene.add(spotLight);</span><br><span class="line">			<span class="comment">// Texture</span></span><br><span class="line">			<span class="keyword">let</span> loader = <span class="keyword">new</span> THREE.TextureLoader();</span><br><span class="line">			<span class="keyword">let</span> planetTexture = <span class="built_in">require</span>(<span class="string">"./assets/imgs/planets/Earth.png"</span>);</span><br><span class="line"></span><br><span class="line">			loader.load( planetTexture, <span class="function"><span class="keyword">function</span> (<span class="params"> texture </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">let</span> geometry = <span class="keyword">new</span> THREE.SphereGeometry( <span class="number">200</span>, <span class="number">20</span>, <span class="number">20</span> );</span><br><span class="line">				<span class="keyword">let</span> material = <span class="keyword">new</span> THREE.MeshBasicMaterial( &#123; <span class="attr">map</span>: texture, <span class="attr">overdraw</span>: <span class="number">0.5</span> &#125; );</span><br><span class="line">				<span class="keyword">let</span> mesh = <span class="keyword">new</span> THREE.Mesh( geometry, material );</span><br><span class="line">				group.add( mesh );</span><br><span class="line">			&#125; );</span><br><span class="line"></span><br><span class="line">			renderer = <span class="keyword">new</span> THREE.WebGLRenderer();</span><br><span class="line">			renderer.setClearColor( <span class="number">0xffffff</span> );</span><br><span class="line">			renderer.setPixelRatio( <span class="built_in">window</span>.devicePixelRatio );</span><br><span class="line">			renderer.setSize( width, height );</span><br><span class="line">			container.appendChild( renderer.domElement );</span><br><span class="line">			stats = <span class="keyword">new</span> Stats();</span><br><span class="line">			container.appendChild( stats.dom );  <span class="comment">//增加状态信息 </span></span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			requestAnimationFrame( animate );</span><br><span class="line">			render();</span><br><span class="line">			stats.update();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;		</span><br><span class="line">			group.rotation.y -= <span class="number">0.005</span>;  <span class="comment">//这行可以控制地球自转</span></span><br><span class="line">			renderer.render( scene, camera );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	render()&#123;</span><br><span class="line">		<span class="keyword">return</span>(</span><br><span class="line">			&lt;div id=<span class="string">'WebGL-output'</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ThreeMap;</span><br></pre></td></tr></table></figure>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="https://zrysmt.github.io/2017/05/17/WebGL%E5%9F%BA%E7%A1%80%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B1-%E7%AE%80%E4%BB%8B/">WebGL基础简明教程1-简介</a></li>
<li><a href="https://zrysmt.github.io/2017/05/17/WebGL%E5%9F%BA%E7%A1%80%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B2-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">WebGL基础简明教程2-基础知识</a></li>
<li><a href="http://www.cnblogs.com/wanbo/p/6754066.html" target="_blank" rel="noopener">图解WebGL&amp;Three.js工作原理</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/06/02/基于WebGL的大数据二三维可视化-uber的deck-gl介绍/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/06/02/基于WebGL的大数据二三维可视化-uber的deck-gl介绍/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">基于WebGL的大数据二三维可视化--uber的deck.gl介绍</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-06-02 18:28:59" itemprop="dateCreated datePublished" datetime="2017-06-02T18:28:59+08:00">2017-06-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:40:53" itemprop="dateModified" datetime="2018-11-30T10:40:53+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>deck.gl是由uber开发并开源出来的基于WebGL的大数据量可视化框架。它具有提供不同类型可视化图层，GPU渲染的高性能，React和Mapbox GL集成，结合地理信息数据（GPS）的特点。下面我们就举两个例子探索一下这个神奇的库。</p>
<h1 id="1-第一站：将源码的例子跑起来"><a href="#1-第一站：将源码的例子跑起来" class="headerlink" title="1.第一站：将源码的例子跑起来"></a>1.第一站：将源码的例子跑起来</h1><p>源码在<a href="https://github.com/uber/deck.gl" target="_blank" rel="noopener">github</a>里，首先克隆出来。</p>
<p>npm 下载，在项目根目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure></p>
<p>(友情提醒，如果npm下载速度比较慢，可以使用淘宝镜像，详细请自行搜索)</p>
<p>下面我们来到例子中，和上不一样在<code>example</code>文件夹下下载安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure></p>
<p>安装成功之后，要申请mapbox的一个key。方法如下：<br>在<a href="https://www.mapbox.com/" target="_blank" rel="noopener">mapbox</a>网站注册后进入<a href="https://www.mapbox.com/studio/account/tokens/" target="_blank" rel="noopener">https://www.mapbox.com/studio/account/tokens/</a>,我们便可以在<code>Default Public Token</code><br>找到我们需要的<code>mapbox key</code>。</p>
<p>在例子文件夹下命令行下输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export MAPBOX_ACCESS_TOKEN=&lt;上面申请到的key&gt;</span><br></pre></td></tr></table></figure></p>
<p>注意：cmd会不认export,可以使用git命令行，或者直接在代码中加入<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//const MAPBOX_TOKEN = process.env.MAPBOX_ACCESS_TOKEN; //改为</span></span><br><span class="line"><span class="keyword">const</span> MAPBOX_TOKEN = <span class="xml"><span class="tag">&lt;<span class="name">上面申请到的key</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>然后执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run start</span><br></pre></td></tr></table></figure></p>
<p>浏览器会自动打开,地址为<code>localhost:3030</code>。</p>
<p>第一例子<code>3d-heatmap</code>,我们看到<br>对应官网上的例子<a href="http://uber.github.io/deck.gl/#/examples/core-layers/hexagon-layer" target="_blank" rel="noopener">http://uber.github.io/deck.gl/#/examples/core-layers/hexagon-layer</a><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/deck.gl/1.jpg" alt=""><br>这是一个<code>HexagonLayer</code>的例子。<br>第二个例子是利用<code>geojson</code><br>对应官网上的例子<a href="http://uber.github.io/deck.gl/#/examples/core-layers/geojson-layer" target="_blank" rel="noopener">http://uber.github.io/deck.gl/#/examples/core-layers/geojson-layer</a><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/deck.gl/2.jpg" alt=""></p>
<h1 id="2-第二站：先拿一个例子看看"><a href="#2-第二站：先拿一个例子看看" class="headerlink" title="2.第二站：先拿一个例子看看"></a>2.第二站：先拿一个例子看看</h1><p>第一例子<code>3d-heatmap</code>，显示效果上面有给出。</p>
<p><a href="https://github.com/uber/deck.gl/tree/master/examples/3d-heatmap" target="_blank" rel="noopener">源码路径</a>。</p>
<blockquote>
<p><a href="https://github.com/uber/deck.gl/tree/master/examples/3d-heatmap" target="_blank" rel="noopener">https://github.com/uber/deck.gl/tree/master/examples/3d-heatmap</a></p>
</blockquote>
<p>deck.gl 是基于地理信息数据的，所以可视化很多都会分层两层，一层是地图数据底图，一层是可视化的数据。这个观念我们要记住，带进去看整个例子。对于这个例子组件<code>MapGL</code>是地里数据底图，组件<code>DeckGLOverlay</code>是可视化成的数据。</p>
<p>基本结构很见简单。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/deck.gl/3.png" alt=""><br>由于是使用React框架搭建，html很简单</p>
<ul>
<li><strong>index.html</strong></li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">'UTF-8'</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>deck.gl example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-tag">body</span> &#123;<span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; <span class="attribute">overflow</span>: hidden;&#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'bundle.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>deckgl-overlay.js</strong></li>
</ul>
<p>首先引入React和deckgl。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> DeckGL, &#123;HexagonLayer&#125; <span class="keyword">from</span> <span class="string">'deck.gl'</span>;</span><br></pre></td></tr></table></figure></p>
<p>几个变量先放出来，光线设置（LIGHT_SETTINGS），颜色范围设置（colorRange），高度显示范围（elevationScale），一些默认的属性（defaultProps）。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LIGHT_SETTINGS = &#123;</span><br><span class="line">  lightsPosition: [<span class="number">-0.144528</span>, <span class="number">49.739968</span>, <span class="number">8000</span>, <span class="number">-3.807751</span>, <span class="number">54.104682</span>, <span class="number">8000</span>],</span><br><span class="line">  ambientRatio: <span class="number">0.4</span>,</span><br><span class="line">  diffuseRatio: <span class="number">0.6</span>,</span><br><span class="line">  specularRatio: <span class="number">0.2</span>,</span><br><span class="line">  lightsStrength: [<span class="number">0.8</span>, <span class="number">0.0</span>, <span class="number">0.8</span>, <span class="number">0.0</span>],</span><br><span class="line">  numberOfLights: <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> colorRange = [</span><br><span class="line">  [<span class="number">1</span>, <span class="number">152</span>, <span class="number">189</span>],</span><br><span class="line">  [<span class="number">73</span>, <span class="number">227</span>, <span class="number">206</span>],</span><br><span class="line">  [<span class="number">216</span>, <span class="number">254</span>, <span class="number">181</span>],</span><br><span class="line">  [<span class="number">254</span>, <span class="number">237</span>, <span class="number">177</span>],</span><br><span class="line">  [<span class="number">254</span>, <span class="number">173</span>, <span class="number">84</span>],</span><br><span class="line">  [<span class="number">209</span>, <span class="number">55</span>, <span class="number">78</span>]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> elevationScale = &#123;<span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">50</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultProps = &#123;</span><br><span class="line">  radius: <span class="number">1000</span>,</span><br><span class="line">  upperPercentile: <span class="number">100</span>,</span><br><span class="line">  coverage: <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>我们建立叫<code>DeckGLOverlay</code>的组件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">DeckGLOverlay</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>组件中提供了两个静态的属性，静态属性可以使用[类名].[方法名]调用，例如：<code>DeckGLOverlay.defaultColorRange</code>。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> get defaultColorRange() &#123;<span class="comment">//默认的颜色范围</span></span><br><span class="line">  <span class="keyword">return</span> colorRange;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> get defaultViewport() &#123;<span class="comment">//默认的视图</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    longitude: <span class="number">-1.4157267858730052</span>,</span><br><span class="line">    latitude: <span class="number">52.232395363869415</span>,</span><br><span class="line">    zoom: <span class="number">6.6</span>,</span><br><span class="line">    minZoom: <span class="number">5</span>,</span><br><span class="line">    maxZoom: <span class="number">15</span>,</span><br><span class="line">    pitch: <span class="number">40.5</span>,</span><br><span class="line">    bearing: <span class="number">-27.396674584323023</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>constructor</code>是构造函数，主要看的是<code>_animateHeight</code>对组件state的设置，这个是用来控制高度的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">  <span class="keyword">super</span>(props);</span><br><span class="line">  <span class="keyword">this</span>.startAnimationTimer = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.intervalTimer = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.state = &#123;</span><br><span class="line">    elevationScale: elevationScale.min</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._startAnimate = <span class="keyword">this</span>._startAnimate.bind(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>._animateHeight = <span class="keyword">this</span>._animateHeight.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">this</span>._animate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">  <span class="keyword">if</span> (nextProps.data.length !== <span class="keyword">this</span>.props.data.length) &#123;</span><br><span class="line">    <span class="keyword">this</span>._animate();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentWillUnmount() &#123;</span><br><span class="line">  <span class="keyword">this</span>._stopAnimate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_animate() &#123;</span><br><span class="line">  <span class="keyword">this</span>._stopAnimate();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait 1.5 secs to start animation so that all data are loaded</span></span><br><span class="line">  <span class="keyword">this</span>.startAnimationTimer = <span class="built_in">window</span>.setTimeout(<span class="keyword">this</span>._startAnimate, <span class="number">1500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_startAnimate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.intervalTimer = <span class="built_in">window</span>.setInterval(<span class="keyword">this</span>._animateHeight, <span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_stopAnimate() &#123;</span><br><span class="line">  <span class="built_in">window</span>.clearTimeout(<span class="keyword">this</span>.startAnimationTimer);</span><br><span class="line">  <span class="built_in">window</span>.clearTimeout(<span class="keyword">this</span>.intervalTimer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_animateHeight() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.state.elevationScale === elevationScale.max) &#123;</span><br><span class="line">    <span class="keyword">this</span>._stopAnimate();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">elevationScale</span>: <span class="keyword">this</span>.state.elevationScale + <span class="number">1</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_initialize(gl) &#123;</span><br><span class="line">  gl.enable(gl.DEPTH_TEST);</span><br><span class="line">  gl.depthFunc(gl.LEQUAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>render</code>渲染方法，layers是可视化渲染的图层定义变量。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;viewport, data, radius, coverage, upperPercentile&#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> layers = [</span><br><span class="line">    <span class="keyword">new</span> HexagonLayer(&#123;</span><br><span class="line">      id: <span class="string">'heatmap'</span>,</span><br><span class="line">      colorRange,</span><br><span class="line">      coverage,</span><br><span class="line">      data,</span><br><span class="line">      elevationRange: [<span class="number">0</span>, <span class="number">3000</span>],</span><br><span class="line">      elevationScale: <span class="keyword">this</span>.state.elevationScale, <span class="comment">//高度</span></span><br><span class="line">      extruded: <span class="literal">true</span>,</span><br><span class="line">      getPosition: <span class="function"><span class="params">d</span> =&gt;</span> d,          <span class="comment">//位置</span></span><br><span class="line">      lightSettings: LIGHT_SETTINGS,</span><br><span class="line">      onHover: <span class="keyword">this</span>.props.onHover,</span><br><span class="line">      opacity: <span class="number">1</span>,</span><br><span class="line">      pickable: <span class="built_in">Boolean</span>(<span class="keyword">this</span>.props.onHover),</span><br><span class="line">      radius,</span><br><span class="line">      upperPercentile</span><br><span class="line">    &#125;)</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">DeckGL</span> &#123;<span class="attr">...viewport</span>&#125; <span class="attr">layers</span>=<span class="string">&#123;layers&#125;</span> <span class="attr">onWebGLInitialized</span>=<span class="string">&#123;this._initialize&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>app.js</strong></li>
</ul>
<p>引入：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;render&#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> MapGL <span class="keyword">from</span> <span class="string">'react-map-gl'</span>;</span><br><span class="line"><span class="keyword">import</span> DeckGLOverlay <span class="keyword">from</span> <span class="string">'./deckgl-overlay.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;csv <span class="keyword">as</span> requestCsv&#125; <span class="keyword">from</span> <span class="string">'d3-request'</span>;<span class="comment">//加载csv文件</span></span><br></pre></td></tr></table></figure></p>
<p>mapbox key：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MAPBOX_TOKEN = process.env.MAPBOX_ACCESS_TOKEN;</span><br></pre></td></tr></table></figure></p>
<p>组件<code>Root</code>：<br>在构造函数中，我们将两个关键的变量viewport和data均放入到state中。这里的<code>MapGL</code>组件就是地理底图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Root</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      viewport: &#123;</span><br><span class="line">        ...DeckGLOverlay.defaultViewport,</span><br><span class="line">        width: <span class="number">500</span>,</span><br><span class="line">        height: <span class="number">500</span></span><br><span class="line">      &#125;,</span><br><span class="line">      data: <span class="literal">null</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//请求csv数据</span></span><br><span class="line">    requestCsv(<span class="string">'./data/heatmap-data.csv'</span>, (error, response) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">        <span class="keyword">const</span> data = response.map(<span class="function"><span class="params">d</span> =&gt;</span> ([<span class="built_in">Number</span>(d.lng), <span class="built_in">Number</span>(d.lat)]));</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;data&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, <span class="keyword">this</span>._resize.bind(<span class="keyword">this</span>));</span><br><span class="line">    <span class="keyword">this</span>._resize();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _resize() &#123;</span><br><span class="line">    <span class="keyword">this</span>._onChangeViewport(&#123;</span><br><span class="line">      width: <span class="built_in">window</span>.innerWidth,</span><br><span class="line">      height: <span class="built_in">window</span>.innerHeight</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _onChangeViewport(viewport) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      viewport: &#123;...this.state.viewport, ...viewport&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;viewport, data&#125; = <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;MapGL</span><br><span class="line">        &#123;...viewport&#125;</span><br><span class="line">        mapStyle=<span class="string">"mapbox://styles/mapbox/dark-v9"</span></span><br><span class="line">        perspectiveEnabled=&#123;<span class="literal">true</span>&#125;</span><br><span class="line">        onChangeViewport=&#123;<span class="keyword">this</span>._onChangeViewport.bind(<span class="keyword">this</span>)&#125;</span><br><span class="line">        mapboxApiAccessToken=&#123;MAPBOX_TOKEN&#125;&gt;</span><br><span class="line">        &lt;DeckGLOverlay</span><br><span class="line">          viewport=&#123;viewport&#125;</span><br><span class="line">          data=&#123;data || []&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/MapGL&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>渲染：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">Root</span> /&gt;</span>, document.body.appendChild(document.createElement('div')));</span></span><br></pre></td></tr></table></figure></p>
<p>MapGL组件我们来修改下<code>mapStyle</code>来重新生成一张图。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapStyle=<span class="string">"mapbox://styles/mapbox/satellite-v9"</span></span><br></pre></td></tr></table></figure></p>
<p>来看下显示效果，地图就变成了卫星影像。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/deck.gl/4.jpg" alt=""></p>
<p><a href="https://www.mapbox.com/studio/styles/" target="_blank" rel="noopener">mapbox</a>提供了几款基础的样式，我们还可以自定义样式使用。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/deck.gl/5.jpg" alt=""></p>
<h1 id="3-第三站：总结一下"><a href="#3-第三站：总结一下" class="headerlink" title="3.第三站：总结一下"></a>3.第三站：总结一下</h1><p>通过上面我们就分析了一个简单的例子，使用Deck.gl，MapGL组件，利用两百多行代码就可以渲染14万多条数据，而且显示效果让我们惊叹，还支持交互，性能比较好，基于WebGL的大数据二三维可视化一个值得研究的方向。</p>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="http://uber.github.io/" target="_blank" rel="noopener">uber deck.gl官网</a></li>
<li><a href="http://www.jianshu.com/p/143ee36b9536" target="_blank" rel="noopener">uber可能用到的可视化技术</a></li>
<li><a href="http://www.tuicool.com/articles/fqYbieY" target="_blank" rel="noopener">Uber工程的deck.gl框架下的Web数据可视化集</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/05/22/leaflet可视化平台搭建/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/05/22/leaflet可视化平台搭建/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">leaflet可视化平台搭建</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-05-22 20:27:57" itemprop="dateCreated datePublished" datetime="2017-05-22T20:27:57+08:00">2017-05-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:40:53" itemprop="dateModified" datetime="2018-11-30T10:40:53+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/WebGIS/" itemprop="url" rel="index"><span itemprop="name">WebGIS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><a href="https://github.com/zrysmt/leaflet-viz" target="_blank" rel="noopener">leaflet-viz–Leaflet可视化平台</a></strong></p>
<blockquote>
<p><a href="https://github.com/zrysmt/leaflet-viz" target="_blank" rel="noopener">https://github.com/zrysmt/leaflet-viz</a></p>
</blockquote>
<p><a href="http://leafletjs.com/index.html" target="_blank" rel="noopener">leaflet</a>是一个开源的前端地图交互类库，比较轻量级，支持移动端。而且有丰富的<a href="http://leafletjs.com/plugins.html" target="_blank" rel="noopener">插件资源</a>可供我们使用。</p>
<p><a href="http://echarts.baidu.com/" target="_blank" rel="noopener">Echarts</a>是百度开源的前端可视化类库，提供丰富的前端可视化图表，平台中重要的一部分是我们要将leaflet和Echarts结合在一起。</p>
<p>该平台是基于leaflet及其插件搭建的一个方便可用的可视化平台。详细参见[示例Demo]。(<a href="https://zrysmt.github.io/demo/leaflet-demo/">https://zrysmt.github.io/demo/leaflet-demo/</a>)</p>
<h2 id="1-安装与编译"><a href="#1-安装与编译" class="headerlink" title="1. 安装与编译"></a>1. 安装与编译</h2><ul>
<li><strong>安装</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>编译</strong></li>
</ul>
<p><strong>debug模式</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure>
<p><strong>输出</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<h2 id="2-示例简介"><a href="#2-示例简介" class="headerlink" title="2.示例简介"></a>2.示例简介</h2><p>示例地址：<a href="https://zrysmt.github.io/demo/leaflet-demo/">https://zrysmt.github.io/demo/leaflet-demo/</a><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-1.jpg" alt=""><br>示例包含最基本的GIS功能和可视化Demo</p>
<h2 id="3-基础的GIS功能"><a href="#3-基础的GIS功能" class="headerlink" title="3.基础的GIS功能"></a>3.基础的GIS功能</h2><ul>
<li>拖放、全图、定位、打印出图片、打印出PDF功能。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-2.png" alt=""></li>
<li>地图缩放、比例尺显示功能</li>
<li>测量面积和距离功能</li>
<li>图层切换，提供丰富的图层切换<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-3.png" alt=""></li>
<li>地图搜索功能</li>
<li>基础绘图功能<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-4.png" alt=""></li>
</ul>
<h2 id="4-可视化示例"><a href="#4-可视化示例" class="headerlink" title="4.可视化示例"></a>4.可视化示例</h2><p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-5.png" alt=""></p>
<ul>
<li><strong>热力图</strong></li>
</ul>
<p>引入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &apos;../common/leaflet-plugin/HeatLayer.js&apos;;</span><br></pre></td></tr></table></figure></p>
<p>使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> heat = L.heatLayer([</span><br><span class="line">    [<span class="number">50.5</span>, <span class="number">30.5</span>, <span class="number">0.2</span>], <span class="comment">// lat, lng, intensity</span></span><br><span class="line">    [<span class="number">50.6</span>, <span class="number">30.4</span>, <span class="number">0.5</span>],</span><br><span class="line">...</span><br><span class="line">], &#123;<span class="attr">radius</span>: <span class="number">25</span>&#125;).addTo(map)</span><br></pre></td></tr></table></figure></p>
<p><strong>效果图</strong>：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-6.jpg" alt=""></p>
<ul>
<li><strong>结合Echarts</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> overlay = <span class="keyword">new</span> L.echartsLayer3(map, echarts);</span><br><span class="line"><span class="keyword">let</span> chartsContainer = overlay.getEchartsContainer();</span><br><span class="line"><span class="keyword">let</span> myChart = overlay.initECharts(chartsContainer);</span><br><span class="line"><span class="built_in">window</span>.onresize = myChart.onresize;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"chartsContainer:"</span>, chartsContainer);</span><br><span class="line"><span class="keyword">if</span> (type == <span class="string">"qianxi"</span>) &#123;</span><br><span class="line">    overlay.setOption(ecOption);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">"scatter"</span>) &#123;</span><br><span class="line">    overlay.setOption(scatterOption);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>迁徙图</strong>（选择了高德卫星底图）<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-7.jpg" alt=""><br><strong>散点图</strong>（选择了Geoq午夜蓝底图）<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-8.jpg" alt=""></p>
<ul>
<li><strong>DivIcon结合Echarts</strong></li>
</ul>
<p>这个方案不太适合大数据量的渲染。<br>我写了两个简单的功能函数，一个用来渲染可视化图（echartsIcon），一个专门用来渲染图例（echartsLegend）。<br><strong>效果图</strong>（底图选择了为google底图）<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-9.jpg" alt=""><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> echartsIcon <span class="keyword">from</span> <span class="string">'../common/plugin/echartsIcon.js'</span>; <span class="comment">//echartsLegend</span></span><br><span class="line"><span class="keyword">import</span> echartsLegend <span class="keyword">from</span> <span class="string">'../common/plugin/echartsLegend.js'</span>; <span class="comment">//echartsLegend</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> option = &#123;</span><br><span class="line">    tooltip: &#123;</span><br><span class="line">        trigger: <span class="string">'item'</span>,</span><br><span class="line">        formatter: <span class="string">"&#123;a&#125; &lt;br/&gt;&#123;b&#125; : &#123;c&#125; (&#123;d&#125;%)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    series: [&#123;</span><br><span class="line">        name: <span class="string">'访问来源'</span>,</span><br><span class="line">        type: <span class="string">'pie'</span>,</span><br><span class="line">        radius: <span class="string">'55%'</span>,</span><br><span class="line">        center: [<span class="string">'50%'</span>, <span class="string">'50%'</span>],</span><br><span class="line">        label: &#123;</span><br><span class="line">            normal: &#123;</span><br><span class="line">                show: <span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">                show: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        lableLine: &#123;</span><br><span class="line">            normal: &#123;</span><br><span class="line">                show: <span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">                show: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        itemStyle: &#123;</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">                shadowBlur: <span class="number">10</span>,</span><br><span class="line">                shadowOffsetX: <span class="number">0</span>,</span><br><span class="line">                shadowColor: <span class="string">'rgba(0, 0, 0, 0.5)'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//经纬度不能相同</span></span><br><span class="line"><span class="keyword">let</span> latlngs = [</span><br><span class="line">    [<span class="number">30</span>, <span class="number">104</span>],</span><br><span class="line">    [<span class="number">31</span>, <span class="number">110</span>],</span><br><span class="line">    [<span class="number">34</span>, <span class="number">120</span>]</span><br><span class="line">];</span><br><span class="line">option.datas = [</span><br><span class="line">    [</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">335</span>, <span class="attr">name</span>: <span class="string">'直接访问'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">310</span>, <span class="attr">name</span>: <span class="string">'邮件营销'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">234</span>, <span class="attr">name</span>: <span class="string">'联盟广告'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">135</span>, <span class="attr">name</span>: <span class="string">'视频广告'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">1548</span>, <span class="attr">name</span>: <span class="string">'搜索引擎'</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">345</span>, <span class="attr">name</span>: <span class="string">'直接访问'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">410</span>, <span class="attr">name</span>: <span class="string">'邮件营销'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">244</span>, <span class="attr">name</span>: <span class="string">'联盟广告'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">145</span>, <span class="attr">name</span>: <span class="string">'视频广告'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">548</span>, <span class="attr">name</span>: <span class="string">'搜索引擎'</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">445</span>, <span class="attr">name</span>: <span class="string">'直接访问'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">410</span>, <span class="attr">name</span>: <span class="string">'邮件营销'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">244</span>, <span class="attr">name</span>: <span class="string">'联盟广告'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">145</span>, <span class="attr">name</span>: <span class="string">'视频广告'</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">148</span>, <span class="attr">name</span>: <span class="string">'搜索引擎'</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">];</span><br><span class="line">echartsIcon(map, latlngs, option);</span><br><span class="line"><span class="comment">//图例</span></span><br><span class="line"><span class="keyword">let</span> legendOption = &#123;</span><br><span class="line">    orient: <span class="string">'vertical'</span>,</span><br><span class="line">    left: <span class="string">'left'</span>,</span><br><span class="line">    width: <span class="string">"90px"</span>,</span><br><span class="line">    height: <span class="string">"140px"</span>,</span><br><span class="line">    data: [<span class="string">'直接访问'</span>, <span class="string">'邮件营销'</span>, <span class="string">'联盟广告'</span>, <span class="string">'视频广告'</span>, <span class="string">'搜索引擎'</span>]</span><br><span class="line">&#125;;</span><br><span class="line">echartsLegend(map, legendOption);</span><br></pre></td></tr></table></figure>
<ul>
<li>leaflet-dvf</li>
</ul>
<p><a href="https://github.com/humangeo/leaflet-dvf" target="_blank" rel="noopener">leaflet-dvf</a>是一个基于leaflet的数据可视化框架，提供有比较多的可视化图形。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"../common/leaflet-plugin/Leaflet.dvf/css/dvf.css"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"leaflet-dvf"</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>地震图：</strong><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-10.jpg" alt=""><br><strong>收入水平图：</strong><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-11.jpg" alt=""><br>需要的数据<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> earthquakesData <span class="keyword">from</span> <span class="string">'../data/earthquakes.json'</span>;</span><br><span class="line"><span class="keyword">import</span> countryData <span class="keyword">from</span> <span class="string">'../data/countryData.js'</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>地震图代码：</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> lastLayer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> eqfeed_callback = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize framework linear functions for mapping earthquake data properties to Leaflet style properties</span></span><br><span class="line">    <span class="comment">// Color scale - green to red using the basic HSLHueFunction</span></span><br><span class="line">    <span class="keyword">let</span> magnitudeColorFunction = <span class="keyword">new</span> L.HSLHueFunction(<span class="keyword">new</span> L.Point(<span class="number">0</span>, <span class="number">90</span>), <span class="keyword">new</span> L.Point(<span class="number">10</span>, <span class="number">0</span>), &#123; <span class="attr">outputSaturation</span>: <span class="string">'100%'</span>, <span class="attr">outputLuminosity</span>: <span class="string">'25%'</span>, <span class="attr">postProcess</span>: <span class="literal">null</span> &#125;);</span><br><span class="line">    <span class="keyword">let</span> magnitudeFillColorFunction = <span class="keyword">new</span> L.HSLHueFunction(<span class="keyword">new</span> L.Point(<span class="number">0</span>, <span class="number">90</span>), <span class="keyword">new</span> L.Point(<span class="number">10</span>, <span class="number">0</span>), &#123; <span class="attr">outputSaturation</span>: <span class="string">'100%'</span>, <span class="attr">outputLuminosity</span>: <span class="string">'50%'</span>, <span class="attr">postProcess</span>: <span class="literal">null</span> &#125;);</span><br><span class="line">    <span class="keyword">let</span> magnitudeRadiusFunction = <span class="keyword">new</span> L.LinearFunction(<span class="keyword">new</span> L.Point(<span class="number">0</span>, <span class="number">10</span>), <span class="keyword">new</span> L.Point(<span class="number">10</span>, <span class="number">30</span>), &#123; <span class="attr">postProcess</span>: <span class="literal">null</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> now = <span class="built_in">Math</span>.round((<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime());</span><br><span class="line">    <span class="keyword">let</span> start = now - <span class="number">86400000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize a linear function to map earthquake time to opacity</span></span><br><span class="line">    <span class="keyword">let</span> timeOpacityFunction = <span class="keyword">new</span> L.LinearFunction(<span class="keyword">new</span> L.Point(start, <span class="number">0.3</span>), <span class="keyword">new</span> L.Point(now, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">let</span> fontSizeFunction = <span class="keyword">new</span> L.LinearFunction(<span class="keyword">new</span> L.Point(<span class="number">0</span>, <span class="number">8</span>), <span class="keyword">new</span> L.Point(<span class="number">10</span>, <span class="number">24</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> textFunction = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            text: value,</span><br><span class="line">            style: &#123;</span><br><span class="line">                <span class="string">'font-size'</span>: fontSizeFunction.evaluate(value)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup a new data layer</span></span><br><span class="line">    <span class="keyword">let</span> dataLayer = <span class="keyword">new</span> L.DataLayer(data, &#123;</span><br><span class="line">        recordsField: <span class="string">'features'</span>,</span><br><span class="line">        latitudeField: <span class="string">'geometry.coordinates.1'</span>,</span><br><span class="line">        longitudeField: <span class="string">'geometry.coordinates.0'</span>,</span><br><span class="line">        locationMode: L.LocationModes.LATLNG,</span><br><span class="line">        displayOptions: &#123;</span><br><span class="line">            <span class="string">'properties.mag'</span>: &#123;</span><br><span class="line">                displayName: <span class="string">'震级'</span>,</span><br><span class="line">                color: magnitudeColorFunction,</span><br><span class="line">                fillColor: magnitudeFillColorFunction,</span><br><span class="line">                radius: magnitudeRadiusFunction,</span><br><span class="line">                text: textFunction</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'properties.time'</span>: &#123;</span><br><span class="line">                displayName: <span class="string">'时间'</span>,</span><br><span class="line">                opacity: timeOpacityFunction,</span><br><span class="line">                fillOpacity: timeOpacityFunction,</span><br><span class="line">                displayText: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> moment.unix(value / <span class="number">1000</span>).format(<span class="string">'MM/DD/YY HH:mm'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        layerOptions: &#123;</span><br><span class="line">            numberOfSides: <span class="number">4</span>,</span><br><span class="line">            radius: <span class="number">10</span>,</span><br><span class="line">            weight: <span class="number">1</span>,</span><br><span class="line">            color: <span class="string">'#000'</span>,</span><br><span class="line">            opacity: <span class="number">0.2</span>,</span><br><span class="line">            stroke: <span class="literal">true</span>,</span><br><span class="line">            fillOpacity: <span class="number">0.7</span>,</span><br><span class="line">            dropShadow: <span class="literal">true</span>,</span><br><span class="line">            gradient: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        tooltipOptions: &#123;</span><br><span class="line">            iconSize: <span class="keyword">new</span> L.Point(<span class="number">90</span>, <span class="number">90</span>), <span class="comment">//hover框大小</span></span><br><span class="line">            iconAnchor: <span class="keyword">new</span> L.Point(<span class="number">-4</span>, <span class="number">76</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        onEachRecord: <span class="function"><span class="keyword">function</span>(<span class="params">layer, record, location</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> $html = $(L.HTMLUtils.buildTable(record));</span><br><span class="line"></span><br><span class="line">            layer.bindPopup($html.wrap(<span class="string">'&lt;div/&gt;'</span>).parent().html(), &#123;</span><br><span class="line">                minWidth: <span class="number">400</span>,</span><br><span class="line">                maxWidth: <span class="number">400</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the data layer to the map</span></span><br><span class="line">    map.addLayer(dataLayer);</span><br><span class="line"></span><br><span class="line">    lastLayer = dataLayer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.mapSetting();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (lastLayer) &#123;</span><br><span class="line">    map.removeLayer(lastLayer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"earthquakesData:"</span>, earthquakesData);</span><br><span class="line">eqfeed_callback(earthquakesData)</span><br></pre></td></tr></table></figure></p>
<p><strong>收入水平图代码：</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> incomeLevelTypes = [<span class="string">'OEC'</span>, <span class="string">'NOC'</span>, <span class="string">'UMC'</span>, <span class="string">'MIC'</span>, <span class="string">'LMC'</span>, <span class="string">'LIC'</span>, <span class="string">'HPC'</span>];</span><br><span class="line"><span class="keyword">let</span> valueArray = [&#123; <span class="string">"id"</span>: <span class="string">"HIC"</span>, <span class="string">"value"</span>: <span class="string">"高收入(HIC)"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"id"</span>: <span class="string">"HPC"</span>, <span class="string">"value"</span>: <span class="string">"收入严重不足(HIPC)"</span> &#125;, &#123; <span class="string">"id"</span>: <span class="string">"INX"</span>, <span class="string">"value"</span>: <span class="string">"未分类(INX)"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"id"</span>: <span class="string">"LIC"</span>, <span class="string">"value"</span>: <span class="string">"低收入(LIC)"</span> &#125;, &#123; <span class="string">"id"</span>: <span class="string">"LMC"</span>, <span class="string">"value"</span>: <span class="string">"中等偏下(LMC)"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"id"</span>: <span class="string">"LMY"</span>, <span class="string">"value"</span>: <span class="string">"中低等收入"</span> &#125;, &#123; <span class="string">"id"</span>: <span class="string">"MIC"</span>, <span class="string">"value"</span>: <span class="string">"中等收入(MIC)"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"id"</span>: <span class="string">"NOC"</span>, <span class="string">"value"</span>: <span class="string">"高收入：nonOECD(NOC)"</span> &#125;, &#123; <span class="string">"id"</span>: <span class="string">"OEC"</span>, <span class="string">"value"</span>: <span class="string">"高收入: OECD(OEC)"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"id"</span>: <span class="string">"UMC"</span>, <span class="string">"value"</span>: <span class="string">"中等偏上(UMC)"</span> &#125;</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> getMap = <span class="function"><span class="keyword">function</span>(<span class="params">valueArray</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> map = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; valueArray.length; ++index) &#123;</span><br><span class="line">        <span class="keyword">let</span> value = valueArray[index];</span><br><span class="line"></span><br><span class="line">        map[value[<span class="string">'id'</span>]] = value[<span class="string">'value'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> valueMap = getMap(valueArray);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> incomeLevelToText = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> valueMap[incomeLevelTypes[value]];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> colorFunction1 = <span class="keyword">new</span> L.HSLLuminosityFunction(<span class="keyword">new</span> L.Point(<span class="number">0</span>, <span class="number">0.2</span>), <span class="keyword">new</span> L.Point(incomeLevelTypes.length - <span class="number">1</span>, <span class="number">0.75</span>), &#123; <span class="attr">outputHue</span>: <span class="number">0</span>, <span class="attr">outputLuminosity</span>: <span class="string">'100%'</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> fillColorFunction1 = <span class="keyword">new</span> L.HSLLuminosityFunction(<span class="keyword">new</span> L.Point(<span class="number">0</span>, <span class="number">0.5</span>), <span class="keyword">new</span> L.Point(incomeLevelTypes.length - <span class="number">1</span>, <span class="number">1</span>), &#123; <span class="attr">outputHue</span>: <span class="number">0</span>, <span class="attr">outputLuminosity</span>: <span class="string">'100%'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> styles = <span class="keyword">new</span> L.StylesBuilder(incomeLevelTypes, &#123;</span><br><span class="line">    displayName: incomeLevelToText,</span><br><span class="line">    color: colorFunction1,</span><br><span class="line">    fillColor: fillColorFunction1</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    recordsField: <span class="string">'1'</span>,</span><br><span class="line">    locationMode: L.LocationModes.COUNTRY,</span><br><span class="line">    codeField: <span class="string">'id'</span>,</span><br><span class="line">    displayOptions: &#123;</span><br><span class="line">        <span class="string">'incomeLevel.id'</span>: &#123;</span><br><span class="line">            displayName: <span class="string">'收入水平'</span>,</span><br><span class="line">            styles: styles.getStyles()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    layerOptions: &#123;</span><br><span class="line">        fillOpacity: <span class="number">0.7</span>,</span><br><span class="line">        opacity: <span class="number">1</span>,</span><br><span class="line">        weight: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    tooltipOptions: &#123;</span><br><span class="line">        iconSize: <span class="keyword">new</span> L.Point(<span class="number">100</span>, <span class="number">65</span>),</span><br><span class="line">        iconAnchor: <span class="keyword">new</span> L.Point(<span class="number">-5</span>, <span class="number">65</span>)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onEachRecord: <span class="function"><span class="keyword">function</span>(<span class="params">layer, record</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> $html = $(L.HTMLUtils.buildTable(record));</span><br><span class="line"></span><br><span class="line">        layer.bindPopup($html.wrap(<span class="string">'&lt;div/&gt;'</span>).parent().html(), &#123;</span><br><span class="line">            maxWidth: <span class="number">400</span>,</span><br><span class="line">            minWidth: <span class="number">400</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> incomeLayer = <span class="keyword">new</span> L.ChoroplethDataLayer(incomeLevels, options);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> legendControl = <span class="keyword">new</span> L.Control.Legend();</span><br><span class="line"></span><br><span class="line">legendControl.addTo(map);</span><br><span class="line">map.addLayer(incomeLayer);</span><br></pre></td></tr></table></figure></p>
<h1 id="5-GeoJSON"><a href="#5-GeoJSON" class="headerlink" title="5.GeoJSON"></a>5.GeoJSON</h1><p>假设我们需要自己做个地图，然后加载到平台中。这个时候可以使用我们提供了编辑栏，编辑后会得到坐标，把坐标转成GeoJSON数据存到数据库中，下次加载的时候解析即可。<br>还可以使用GIS工具，做成GeoJSON的数据，然后使用下面的方法加载，详细说明的<a href="https://zrysmt.github.io/2017/05/04/%E4%BD%BF%E7%94%A8leaflet%E6%88%96%E8%80%85openlayers-3-%E8%B0%83%E7%94%A8MapServer%E6%9C%8D%E5%8A%A1%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%AE%8C%E6%95%B4%E8%AF%B4%E6%98%8E/">传送门</a>在这，当然这包括MapServer的东西，我们将在第六部分有简要说明。<br><strong>示例图：</strong><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-12.jpg" alt=""><br>引入数据：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; json_china &#125; <span class="keyword">from</span> <span class="string">'../data/china.js'</span>;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pop_0</span>(<span class="params">feature, layer</span>) </span>&#123;<span class="comment">//部分有省略</span></span><br><span class="line">    <span class="keyword">let</span> popupContent = <span class="string">'&lt;table&gt;\</span></span><br><span class="line"><span class="string">                    &lt;tr&gt;\</span></span><br><span class="line"><span class="string">                        &lt;td colspan="2"&gt;面积：'</span> + (feature.properties[<span class="string">'AREA'</span>] !== <span class="literal">null</span> ? Autolinker.link(<span class="built_in">String</span>(feature.properties[<span class="string">'AREA'</span>])) : <span class="string">''</span>) + <span class="string">'&lt;/td&gt;\</span></span><br><span class="line"><span class="string">                    &lt;/tr&gt;\</span></span><br><span class="line"><span class="string">                    &lt;tr&gt;\</span></span><br><span class="line"><span class="string">                        &lt;td colspan="2"&gt;周长：'</span> + (feature.properties[<span class="string">'PERIMETER'</span>] !== <span class="literal">null</span> ? Autolinker.link(<span class="built_in">String</span>(feature.properties[<span class="string">'PERIMETER'</span>])) : <span class="string">''</span>) + <span class="string">'&lt;/td&gt;\</span></span><br><span class="line"><span class="string">                    &lt;/tr&gt;\</span></span><br><span class="line"><span class="string">                    &lt;tr&gt;\</span></span><br><span class="line"><span class="string">                        &lt;td colspan="2"&gt;名称：'</span> + (feature.properties[<span class="string">'NAME'</span>] !== <span class="literal">null</span> ? Autolinker.link(<span class="built_in">String</span>(feature.properties[<span class="string">'NAME'</span>])) : <span class="string">''</span>) + <span class="string">'&lt;/td&gt;\</span></span><br><span class="line"><span class="string">                    &lt;/tr&gt;\</span></span><br><span class="line"><span class="string">                &lt;/table&gt;'</span>;</span><br><span class="line">    layer.bindPopup(popupContent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">style_0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        pane: <span class="string">'pane_0'</span>,</span><br><span class="line">        opacity: <span class="number">1</span>,</span><br><span class="line">        color: <span class="string">'rgba(0,0,0,0.494117647059)'</span>,</span><br><span class="line">        dashArray: <span class="string">''</span>,</span><br><span class="line">        lineCap: <span class="string">'butt'</span>,</span><br><span class="line">        lineJoin: <span class="string">'miter'</span>,</span><br><span class="line">        weight: <span class="number">1.0</span>,</span><br><span class="line">        fillOpacity: <span class="number">1</span>,</span><br><span class="line">        fillColor: <span class="string">'rgba(64,98,210,0.494117647059)'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">map.createPane(<span class="string">'pane_0'</span>);</span><br><span class="line">map.getPane(<span class="string">'pane_0'</span>).style.zIndex = <span class="number">400</span>;</span><br><span class="line">map.getPane(<span class="string">'pane_0'</span>).style[<span class="string">'mix-blend-mode'</span>] = <span class="string">'normal'</span>;</span><br><span class="line"><span class="keyword">let</span> layer_0 = <span class="keyword">new</span> L.geoJson(json_china, &#123;</span><br><span class="line">    attribution: <span class="string">'&lt;a href=""&gt;&lt;/a&gt;'</span>,</span><br><span class="line">    pane: <span class="string">'pane_0'</span>,</span><br><span class="line">    onEachFeature: pop_0,</span><br><span class="line">    style: style_0</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="6-MapServer"><a href="#6-MapServer" class="headerlink" title="6.MapServer"></a>6.MapServer</h1><p>再进一步，如果我们想要自己的地图服务器，这个时候就需要使用到了MapServer,具体的说明见<a href="https://zrysmt.github.io/2017/05/04/%E4%BD%BF%E7%94%A8leaflet%E6%88%96%E8%80%85openlayers-3-%E8%B0%83%E7%94%A8MapServer%E6%9C%8D%E5%8A%A1%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%AE%8C%E6%95%B4%E8%AF%B4%E6%98%8E/">传送门</a></p>
<p>有个示例在<code>test</code>文件夹下:<code>leaflet-mapserver.html</code>。注意这个是需要配置好服务器的，在这里直接预览是不能成功的。<br>示例得到我们的世界地图的地图服务器。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/leaflet/1-13.jpg" alt=""></p>
<p>其实leaflet和D3等开源库结合起来，能得到很多丰富多彩的可视化图，姑且留下点神秘，这里就不再探究两者结合的神奇魅力了。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/05/22/2017阿里实习校招-前端技术视频面试体会/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/05/22/2017阿里实习校招-前端技术视频面试体会/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">2017阿里实习校招-前端技术视频面试体会</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-05-22 16:14:00" itemprop="dateCreated datePublished" datetime="2017-05-22T16:14:00+08:00">2017-05-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:40:53" itemprop="dateModified" datetime="2018-11-30T10:40:53+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>快要秋招找工作了，预约的暑期实习面试，也是为了秋招攒点经验。约的时间是15:15 - 16:00，焦急又必须有耐心的等待后，终于在下午四点左右接通了视频，紧张ing。</p>
<p>首先面试官介绍了自己的花名，心里紧张没记下来，现在想想挺后悔的。但是谁让我紧张了呢？<br>然后是我的自我介绍，简单的介绍了一下我的基本情况，把技能和项目都介绍了介绍。<br>面试官态度挺好的，平易近人的感觉，慢慢的也就不紧张了，后面面试官一路45度仰天扣鼻子，也是让我乐了，心态更加轻松随意了。</p>
<p>面试的前端工程师，当然最重要的技术问题。上来就是让我共享屏幕，然后打开IDE写个排序，尼玛宝宝好怕，虽然简单，但是全部写下来运行太痛苦了。</p>
<h1 id="1-数组排序"><a href="#1-数组排序" class="headerlink" title="1.数组排序"></a>1.数组排序</h1><ul>
<li><p>原生实现 sort函数，倒是很快就写出来了，然后随时就让我用不是原生的方法实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">34</span>,<span class="number">20</span>,<span class="number">10</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">arr,sortType</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">return</span>    arr.sort(<span class="function"><span class="keyword">function</span>(<span class="params">num1,num2</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(sortType == <span class="string">"desc"</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> num1 &lt; num2; </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> num1 &gt; num2; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>快排 我记得模棱两可，没写出来啊，心痛啊。现在把正确的贴在这里。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">quickSort</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(arr.length&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> leftArr = [];</span><br><span class="line">    <span class="keyword">let</span> rightArr = [];</span><br><span class="line">    <span class="keyword">let</span> q = arr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">1</span>,l=arr.length; i&lt;l; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(arr[i]&gt;q) &#123;</span><br><span class="line">            rightArr.push(arr[i]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            leftArr.push(arr[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [].concat(quickSort(leftArr),[q],quickSort(rightArr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>还好冒泡还记得，又用冒泡写的，马马虎虎能运行了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bubbleSort</span>(<span class="params">arr</span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>,l=arr.length;i&lt;l<span class="number">-1</span>;i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> j = i+<span class="number">1</span>;j&lt;l;j++) &#123; </span><br><span class="line">          <span class="keyword">if</span>(arr[i]&gt;arr[j]) &#123;</span><br><span class="line">                <span class="keyword">let</span> tem = arr[i];</span><br><span class="line">                arr[i] = arr[j];</span><br><span class="line">                arr[j] = tem;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="2-ES6"><a href="#2-ES6" class="headerlink" title="2.ES6"></a>2.ES6</h1><p>提了下ES6，问了ES6的<strong>let，const与var</strong>的区别，特意说下let和const有块级作用域。var没有。然后又问了我都有什么作用域，我说ES5没有块级作用域，有全局作用域和函数作用域。然后面试官补充了一个对象作用域，这个我知道只是好像没经过总结过啊。</p>
<p>问我在项目中使用的ES6都有哪些？我说<strong>Promoise</strong>挺优雅的，然后让我写写，然后我就写了个XmlHttpServer，啊悲了个催了的，我的编辑器没有智能提示（论一个智能提醒的IDE有多重要），然后我手写的ajax请求，忘记了很多细节，怎么写啊，写了部分，面试官看不下去了吧（心伤），说他明白我的意思，你不用全部写下来，把过程大概写好就行了。然后我就写了怎么调用，我是理解了Promise，不知道这个问题面试官给打多少分，所以说坑都是自己挖的。</p>
<p>其实介绍了几次我使用了React+react router，估计阿里内部使用的是Weex，Kissy这样的自己的框架，面试官估计没有太接触React，所以一直没问我这方面的问题。</p>
<h1 id="3-项目"><a href="#3-项目" class="headerlink" title="3.项目"></a>3.项目</h1><p>一直不提我使用React写的项目，提起来我之前做的一个项目，那个项目我也没啥说的吧，我只能说我比较早做的，使用的都是老技术。运用的是Bootstrap，查询渲染数据，巴拉巴拉，感觉我说完的意思是我的这个项目不咋样，自己不相信自己了啊，怀疑了人生。</p>
<p>然后问我做了其他的有什么最深的体会。<br>所以我立刻就说了使用 React的项目（终于可以介绍了），然后我就说主要分了两个模块，一个是基础的显示模块，一个是地图模块，使用Openlayers api的组件化，还和github上的有个OpenLayer封装的做了个对比，我说有一个开源的使用React封装的Openlayers不方便，而且源码不全，我就自己封装了，面试官再次表现出了不太了解React，所以就没有继续追问下去。</p>
<h1 id="4-对可视化的理解"><a href="#4-对可视化的理解" class="headerlink" title="4.对可视化的理解"></a>4.对可视化的理解</h1><p>估计看了我的博客，我的博客最近写的是WebGL，就问了我对WebGL的理解。<br>理解，这怎么说啊，好难过，我也不知道怎么描述啊。而且我也只是刚看了一个星期的书，还有一个周的Threejs罢了，我就说性能好，但是WebGL书写比较麻烦，所以大家都用Three.js,我也看了部分的Three.js。然后又顺嘴提了下我后面的研究方向， 目前还没有太深的理解（是不是这句话不应该说啊，应该忽悠忽悠的啊），然后就又随口说了下cesium.js,与我们的专业还有点关系–webgis，然后我们会在此基础上扩展。</p>
<p>总之问我理解，我又给出的印象是我的理解不深，痛心了。<br>然后给了个更大的题目，对可视化的理解，这题目呢，怎么说啊。我只能说大数据可视化和canvas，然后举了举例子，ECharts，datav，mapv等，然后说我对这方面挺有兴趣的，忘了面试官说什么了，好像的意思也只是你对这感兴趣，有个方向，没有深耕下去。</p>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a>5.总结</h1><p>这可以说是我第一次真正意义上的面试，第一次视频面试，还是阿里的。总之感觉是这次我没戏了，哪怕是个实习面试。看来是要多刷刷面试经验的。</p>
<p>离远方还是有很多路要走啊，还有两三个月时间，继续加油吧，一定要告诫自己不要气馁，坚持就是胜利。</p>
<p>简单体会，写至此处，感怀万千。，坚持就是胜利。  简单体会，写至此处，感怀万千。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/05/17/WebGL基础简明教程2-基础知识/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/05/17/WebGL基础简明教程2-基础知识/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">WebGL基础简明教程2-基础知识</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-05-17 13:16:09" itemprop="dateCreated datePublished" datetime="2017-05-17T13:16:09+08:00">2017-05-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:40:53" itemprop="dateModified" datetime="2018-11-30T10:40:53+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇我们介绍了使用WebGL的基础，包括顶点着色器、片元着色器、初始化WebGL，初始化着色器以及变换、动画、颜色、纹理等，这一部分的内容我们就来进入三维的世界。和上一篇文章一样，我们的这篇只做个大概的介绍，详细的内容部分请参阅《WebGL编程指南》一书。</p>
<p>代码存储在我的<a href="https://github.com/zrysmt/data-viz/tree/master/webgl/demo" target="_blank" rel="noopener">GitHub</a>中。</p>
<blockquote>
<p><a href="https://github.com/zrysmt/data-viz/tree/master/webgl/demo" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/tree/master/webgl/demo</a></p>
</blockquote>
<p>首先我们来绘制一个三维的实例。<br>示例程序:<a href="https://zrysmt.github.io/demo/webgl-demo/demo/10-HelloCube.html">https://zrysmt.github.io/demo/webgl-demo/demo/10-HelloCube.html</a>.</p>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-1.jpg" alt=""></p>
<p>实例的源码程序:<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/demo/HelloCube.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/demo/HelloCube.js</a><br>其实这里我们应该注意到示例和源码的结构对应，下面的一些我可能只给出一个url地址。</p>
<h1 id="1-视图、投影和索引矩阵"><a href="#1-视图、投影和索引矩阵" class="headerlink" title="1.视图、投影和索引矩阵"></a>1.视图、投影和索引矩阵</h1><h2 id="从main函数开始"><a href="#从main函数开始" class="headerlink" title="从main函数开始"></a>从main函数开始</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Retrieve &lt;canvas&gt; element</span></span><br><span class="line">    <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'webgl'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the rendering context for WebGL</span></span><br><span class="line">    <span class="keyword">var</span> gl = getWebGLContext(canvas);</span><br><span class="line">    <span class="keyword">if</span> (!gl) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to get the rendering context for WebGL'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize shaders</span></span><br><span class="line">    <span class="keyword">if</span> (!initShaders(gl, VSHADER_SOURCE, FSHADER_SOURCE)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to intialize shaders.'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the vertex coordinates and color</span></span><br><span class="line">    <span class="keyword">var</span> n = initVertexBuffers(gl);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to set the vertex information'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set clear color and enable hidden surface removal</span></span><br><span class="line">    gl.clearColor(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    gl.enable(gl.DEPTH_TEST);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the storage location of u_MvpMatrix</span></span><br><span class="line">    <span class="keyword">var</span> u_MvpMatrix = gl.getUniformLocation(gl.program, <span class="string">'u_MvpMatrix'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!u_MvpMatrix) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to get the storage location of u_MvpMatrix'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the eye point and the viewing volume</span></span><br><span class="line">    <span class="keyword">var</span> mvpMatrix = <span class="keyword">new</span> Matrix4();</span><br><span class="line">    mvpMatrix.setPerspective(<span class="number">30</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    mvpMatrix.lookAt(<span class="number">3</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pass the model view projection matrix to u_MvpMatrix</span></span><br><span class="line">    gl.uniformMatrix4fv(u_MvpMatrix, <span class="literal">false</span>, mvpMatrix.elements);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear color and depth buffer</span></span><br><span class="line">    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw the cube</span></span><br><span class="line">    gl.drawElements(gl.TRIANGLES, n, gl.UNSIGNED_BYTE, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="顶点着色器和片元着色器"><a href="#顶点着色器和片元着色器" class="headerlink" title="顶点着色器和片元着色器"></a>顶点着色器和片元着色器</h2><p>和上一篇有一些的不同<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> VSHADER_SOURCE =</span><br><span class="line">    <span class="string">'attribute vec4 a_Position;\n'</span> +</span><br><span class="line">    <span class="string">'attribute vec4 a_Color;\n'</span> +</span><br><span class="line">    <span class="string">'uniform mat4 u_MvpMatrix;\n'</span> +      <span class="comment">//模型矩阵，设置视图/投影</span></span><br><span class="line">    <span class="string">'varying vec4 v_Color;\n'</span> +          <span class="comment">//传值给片元着色器</span></span><br><span class="line">    <span class="string">'void main() &#123;\n'</span> +</span><br><span class="line">    <span class="string">'  gl_Position = u_MvpMatrix * a_Position;\n'</span> +</span><br><span class="line">    <span class="string">'  v_Color = a_Color;\n'</span> +</span><br><span class="line">    <span class="string">'&#125;\n'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fragment shader program</span></span><br><span class="line"><span class="keyword">var</span> FSHADER_SOURCE =</span><br><span class="line">    <span class="string">'#ifdef GL_ES\n'</span> +</span><br><span class="line">    <span class="string">'precision mediump float;\n'</span> +    <span class="comment">//精度限定 中等精度</span></span><br><span class="line">    <span class="string">'#endif\n'</span> +</span><br><span class="line">    <span class="string">'varying vec4 v_Color;\n'</span> +</span><br><span class="line">    <span class="string">'void main() &#123;\n'</span> +</span><br><span class="line">    <span class="string">'  gl_FragColor = v_Color;\n'</span> +</span><br><span class="line">    <span class="string">'&#125;\n'</span>;</span><br></pre></td></tr></table></figure></p>
<p>关于<strong>attribute uniform varying</strong><br><strong>attribute:</strong>只能是全局的，只能出现在顶点着色器，标识逐顶点信息；<br><strong>uniform：</strong>只能是全局的，可以在顶点着色器和片元着色器上，如果两个地方均定义，那么这变量被两个着色器共享了；<br><strong>varying:</strong>只能是全局的，负责从顶点着色器向片元着色器传输数据。  </p>
<h2 id="视图矩阵-view-matrix"><a href="#视图矩阵-view-matrix" class="headerlink" title="视图矩阵(view matrix)"></a>视图矩阵(view matrix)</h2><p><strong>视点</strong>、<strong>观察点</strong>和<strong>上方向</strong>决定<strong>视图矩阵</strong><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-2.jpg" alt=""><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mvpMatrix = <span class="keyword">new</span> Matrix4();</span><br><span class="line">    mvpMatrix.setLookAt(<span class="number">3</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-3.jpg" alt=""></p>
<h2 id="投影矩阵"><a href="#投影矩阵" class="headerlink" title="投影矩阵"></a>投影矩阵</h2><p>投影的作用就是使得距离近的看的比较大，距离远的看的比较小<br><a href="https://zrysmt.github.io/demo/webgl-demo/demo/8-PerspectiveView.html">示例</a><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-4.png" alt=""><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">projMatrix.setPerspective(<span class="number">30</span>, canvas.width/canvas.height, <span class="number">1</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-5.jpg" alt=""><br><strong>三角形与可视空间的位置</strong><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-6.jpg" alt=""><br>其实投影矩阵的核心就是两种变换，1）按比例缩放；2）平移</p>
<h2 id="消除被遮挡的面"><a href="#消除被遮挡的面" class="headerlink" title="消除被遮挡的面"></a>消除被遮挡的面</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gl.enable(gl.DEPTH_TEST);</span><br></pre></td></tr></table></figure>
<p>清除颜色和深度buffer<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Clear color and depth buffer </span></span><br><span class="line">gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);</span><br></pre></td></tr></table></figure></p>
<h2 id="重要的公式"><a href="#重要的公式" class="headerlink" title="重要的公式"></a>重要的公式</h2><p>我们总结下一个重要的公式，WebGL绘制物体的位置为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;投影矩阵&gt; X &lt;视图矩阵&gt; X  &lt;模型矩阵&gt;  X  &lt;顶点坐标&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="绘制立方体"><a href="#绘制立方体" class="headerlink" title="绘制立方体"></a>绘制立方体</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initVertexBuffers</span>(<span class="params">gl</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> verticesColors = <span class="keyword">new</span> <span class="built_in">Float32Array</span>([</span><br><span class="line">        <span class="comment">// Vertex coordinates and color</span></span><br><span class="line">        <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="comment">// v0 White</span></span><br><span class="line">        <span class="number">-1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="comment">// v1 Magenta</span></span><br><span class="line">        <span class="number">-1.0</span>, <span class="number">-1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="comment">// v2 Red</span></span><br><span class="line">        <span class="number">1.0</span>, <span class="number">-1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="comment">// v3 Yellow</span></span><br><span class="line">        <span class="number">1.0</span>, <span class="number">-1.0</span>, <span class="number">-1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="comment">// v4 Green</span></span><br><span class="line">        <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">-1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="comment">// v5 Cyan</span></span><br><span class="line">        <span class="number">-1.0</span>, <span class="number">1.0</span>, <span class="number">-1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="comment">// v6 Blue</span></span><br><span class="line">        <span class="number">-1.0</span>, <span class="number">-1.0</span>, <span class="number">-1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span> <span class="comment">// v7 Black</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indices of the vertices</span></span><br><span class="line">    <span class="keyword">var</span> indices = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([</span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="comment">// front</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="comment">// right</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="comment">// up</span></span><br><span class="line">        <span class="number">1</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="comment">// left</span></span><br><span class="line">        <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="comment">// down</span></span><br><span class="line">        <span class="number">4</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span> <span class="comment">// back</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a buffer object</span></span><br><span class="line">    <span class="keyword">var</span> vertexColorBuffer = gl.createBuffer();</span><br><span class="line">    <span class="keyword">var</span> indexBuffer = gl.createBuffer();</span><br><span class="line">    <span class="keyword">if</span> (!vertexColorBuffer || !indexBuffer) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the vertex coordinates and color to the buffer object</span></span><br><span class="line">    <span class="comment">// 存入缓冲：颜色/位置</span></span><br><span class="line">    gl.bindBuffer(gl.ARRAY_BUFFER, vertexColorBuffer);</span><br><span class="line">    gl.bufferData(gl.ARRAY_BUFFER, verticesColors, gl.STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> FSIZE = verticesColors.BYTES_PER_ELEMENT;</span><br><span class="line">    <span class="comment">// Assign the buffer object to a_Position and enable the assignment</span></span><br><span class="line">    <span class="keyword">var</span> a_Position = gl.getAttribLocation(gl.program, <span class="string">'a_Position'</span>);</span><br><span class="line">    <span class="keyword">if</span> (a_Position &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to get the storage location of a_Position'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    gl.vertexAttribPointer(a_Position, <span class="number">3</span>, gl.FLOAT, <span class="literal">false</span>, FSIZE * <span class="number">6</span>, <span class="number">0</span>);</span><br><span class="line">    gl.enableVertexAttribArray(a_Position);</span><br><span class="line">    <span class="comment">// Assign the buffer object to a_Color and enable the assignment</span></span><br><span class="line">    <span class="keyword">var</span> a_Color = gl.getAttribLocation(gl.program, <span class="string">'a_Color'</span>);</span><br><span class="line">    <span class="keyword">if</span> (a_Color &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to get the storage location of a_Color'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    gl.vertexAttribPointer(a_Color, <span class="number">3</span>, gl.FLOAT, <span class="literal">false</span>, FSIZE * <span class="number">6</span>, FSIZE * <span class="number">3</span>);</span><br><span class="line">    gl.enableVertexAttribArray(a_Color);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the indices to the buffer object</span></span><br><span class="line">    <span class="comment">// 存入缓冲：索引</span></span><br><span class="line">    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);</span><br><span class="line">    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> indices.length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>立方体的结构</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  v6----- v5</span><br><span class="line"> /|      <span class="regexp">/|</span></span><br><span class="line"><span class="regexp">v1------v0|</span></span><br><span class="line"><span class="regexp">| |     | |</span></span><br><span class="line"><span class="regexp">| |v7---|-|v4</span></span><br><span class="line"><span class="regexp">|/</span>      |<span class="regexp">/</span></span><br><span class="line"><span class="regexp">v2------v3</span></span><br></pre></td></tr></table></figure></p>
<p>首先顶点坐标和顶点坐标的颜色存储在<code>verticesColors</code>矩阵中。<br>而WebGL的绘制是按照三角形的形式一个一个绘制的，那么意味着一个立方体的一个面有两个三角形，一个立方体总共需要2<em>6 = 12个三角形，一个三角形需要3个顶点，那么一共需要绘制 3</em>12 = 36个顶点。我们知道一个立方体只需要8个顶点就可以了。为此我们在这里使用了<strong>索引矩阵</strong>（indices），索引矩阵也要写入缓存中。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-7.jpg" alt=""><br>这样我们就能完成绘制了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gl.drawElements(gl.TRIANGLES, n, gl.UNSIGNED_BYTE, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<p>注意这里的<code>n = indices.length</code>。</p>
<h1 id="2-光照"><a href="#2-光照" class="headerlink" title="2.光照"></a>2.光照</h1><p>我们主要关注下面三种形式的<strong>光照</strong>：</p>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-8.jpg" alt=""></p>
<p>物理表面<strong>反射光线：</strong>分为漫反射和环境反射</p>
<h2 id="环境反射"><a href="#环境反射" class="headerlink" title="环境反射"></a>环境反射</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;环境反射光颜色&gt; = &lt;入射光颜色&gt; X &lt;表面基底色&gt;</span><br></pre></td></tr></table></figure>
<h2 id="平行光下的漫反射"><a href="#平行光下的漫反射" class="headerlink" title="平行光下的漫反射"></a>平行光下的漫反射</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;漫反射光颜色&gt; = &lt;入射光颜色&gt; X &lt;表面基底色&gt; X cosθ</span><br></pre></td></tr></table></figure>
<p>即：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;漫反射光颜色&gt; = &lt;入射光颜色&gt; X &lt;表面基底色&gt; X （&lt;光线方向&gt; · &lt;法线方向&gt;）</span><br></pre></td></tr></table></figure></p>
<p>我们只用漫反射的效果的时候<br><a href="https://zrysmt.github.io/demo/webgl-demo/demo/11-LightedCube.html">示例</a><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-9.png" alt=""><br>由于只考虑漫反射，右边的部分几乎是黑色了，这时候我们来考虑下环境光。<br><strong>环境反射下的表面的反射光颜色</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;表面的反射光颜色&gt; = &lt;漫反射颜色&gt; + &lt;环境反射光颜色&gt;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://zrysmt.github.io/demo/webgl-demo/demo/13-LightedCube_ambient.html">示例</a><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-10.png" alt=""><br>我们来看下着色器源码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> VSHADER_SOURCE =</span><br><span class="line">  <span class="string">'attribute vec4 a_Position;\n'</span> +</span><br><span class="line">  <span class="string">'attribute vec4 a_Color;\n'</span> +        <span class="comment">//表面颜色</span></span><br><span class="line">  <span class="string">'attribute vec4 a_Normal;\n'</span> +       <span class="comment">// 表面法向量</span></span><br><span class="line">  <span class="string">'uniform mat4 u_MvpMatrix;\n'</span> +</span><br><span class="line">  <span class="string">'uniform vec3 u_DiffuseLight;\n'</span> +   <span class="comment">// 漫反射光颜色</span></span><br><span class="line">  <span class="string">'uniform vec3 u_LightDirection;\n'</span> + <span class="comment">// 漫反射入射光方向 (in the world coordinate, normalized)归一化后</span></span><br><span class="line">  <span class="string">'uniform vec3 u_AmbientLight;\n'</span> +   <span class="comment">// 环境光颜色</span></span><br><span class="line">  <span class="string">'varying vec4 v_Color;\n'</span> +</span><br><span class="line">  <span class="string">'void main() &#123;\n'</span> +</span><br><span class="line">  <span class="string">'  gl_Position = u_MvpMatrix * a_Position;\n'</span> +</span><br><span class="line">     <span class="comment">// 归一化方向量</span></span><br><span class="line">  <span class="string">'  vec3 normal = normalize(a_Normal.xyz);\n'</span> +</span><br><span class="line">     <span class="comment">// &lt;归一化的光线方向&gt; 点乘 &lt;归一化法线向量&gt;</span></span><br><span class="line">  <span class="string">'  float nDotL = max(dot(u_LightDirection, normal), 0.0);\n'</span> +</span><br><span class="line">     <span class="comment">// 计算漫反射颜色</span></span><br><span class="line">  <span class="string">'  vec3 diffuse = u_DiffuseLight * a_Color.rgb * nDotL;\n'</span> +</span><br><span class="line">     <span class="comment">// 计算环境光颜色</span></span><br><span class="line">  <span class="string">'  vec3 ambient = u_AmbientLight * a_Color.rgb;\n'</span> +</span><br><span class="line">     <span class="comment">// 两者相加得到物体最终的颜色</span></span><br><span class="line">  <span class="string">'  v_Color = vec4(diffuse + ambient, a_Color.a);\n'</span> + </span><br><span class="line">  <span class="string">'&#125;\n'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fragment shader program</span></span><br><span class="line"><span class="keyword">var</span> FSHADER_SOURCE =</span><br><span class="line">  <span class="string">'#ifdef GL_ES\n'</span> +</span><br><span class="line">  <span class="string">'precision mediump float;\n'</span> +</span><br><span class="line">  <span class="string">'#endif\n'</span> +</span><br><span class="line">  <span class="string">'varying vec4 v_Color;\n'</span> +</span><br><span class="line">  <span class="string">'void main() &#123;\n'</span> +</span><br><span class="line">  <span class="string">'  gl_FragColor = v_Color;\n'</span> +</span><br><span class="line">  <span class="string">'&#125;\n'</span>;</span><br></pre></td></tr></table></figure></p>
<p>对于变化后的物体，物体的法向量也会改变<br><a href="https://zrysmt.github.io/demo/webgl-demo/demo/14-LightedTranslatedRotatedCube.html">示例</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;变换后的法向量&gt; = &lt;法向量&gt; X &lt;变化矩阵的逆转置矩阵&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">normalMatrix.setInverseOf(modelMatrix); </span><br><span class="line">normalMatrix.transpose(); </span><br><span class="line">gl.uniformMatrix4fv(u_NormalMatrix, <span class="literal">false</span>, normalMatrix.elements);</span><br></pre></td></tr></table></figure>
<p>在顶点着色器中变化原法向量<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vec3 normal = normalize(vec3(u_NormalMatrix * a_Normal))</span><br></pre></td></tr></table></figure></p>
<p> 最后我们来看下最终的<strong>漫反射光颜色</strong>的公式<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;漫反射光颜色&gt; = &lt;入射光颜色&gt; X &lt;表面基底色&gt; X （&lt;光线方向&gt; ·（&lt;模型矩阵逆转置矩阵&gt; X &lt;法线方向&gt;））</span><br></pre></td></tr></table></figure></p>
<h2 id="点光源"><a href="#点光源" class="headerlink" title="点光源"></a>点光源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">光线方向 = 归一化（点光源方向 - 顶点坐标）</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 顶点处的光线方向 = 点光源的光坐标 - 顶点坐标 </span><br><span class="line"> &apos; vec3 lightDirection = normalize(u_LightPosition - vec3(vertexPosition));\n&apos;</span><br></pre></td></tr></table></figure>
<h1 id="3-层次模型"><a href="#3-层次模型" class="headerlink" title="3.层次模型"></a>3.层次模型</h1><p>有的物体的运动会带动别的物体，如上臂的运动会带动下臂和手掌的运动。</p>
<p>示例:<a href="https://zrysmt.github.io/demo/webgl-demo/ch09/JointModel.html">https://zrysmt.github.io/demo/webgl-demo/ch09/JointModel.html</a><br>示例源码：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch09/JointModel.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch09/JointModel.js</a></p>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/2-11.png" alt=""><br>下边的(Arm1)会带动上边的(Arm2)运动，而上边的运动不会带动下边的。</p>
<p>思路：共用一个变换的模型矩阵：<code>g_modelMatrix</code>,Arm1变化<code>g_modelMatrix</code>也会变化，那么Arm2也会使用这个模型。谁能控制谁，关键是谁先写上去，谁后写上去，先写上去的控制后写上去的。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Arm1 </span></span><br><span class="line"><span class="keyword">var</span> arm1Length = <span class="number">10.0</span>; <span class="comment">// Length of arm1 </span></span><br><span class="line">g_modelMatrix.setTranslate(<span class="number">0.0</span>, <span class="number">-12.0</span>, <span class="number">0.0</span>); </span><br><span class="line">g_modelMatrix.rotate(g_arm1Angle, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>); <span class="comment">// Rotate around the y-axis </span></span><br><span class="line">drawBox(gl, n, viewProjMatrix, u_MvpMatrix, u_NormalMatrix); <span class="comment">// Draw |</span></span><br><span class="line"><span class="comment">// Arm2 </span></span><br><span class="line">g_modelMatrix.translate(<span class="number">0.0</span>, arm1Length, <span class="number">0.0</span>); 　　　<span class="comment">// Move to joint1 </span></span><br><span class="line">g_modelMatrix.rotate(g_joint1Angle, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>); <span class="comment">// Rotate around the z-axis </span></span><br><span class="line">g_modelMatrix.scale(<span class="number">1.3</span>, <span class="number">1.0</span>, <span class="number">1.3</span>); <span class="comment">// Make it a little thicker </span></span><br><span class="line">drawBox(gl, n, viewProjMatrix, u_MvpMatrix, u_NormalMatrix); <span class="comment">// Draw</span></span><br></pre></td></tr></table></figure></p>
<h1 id="4-几个高级功能的实例"><a href="#4-几个高级功能的实例" class="headerlink" title="4.几个高级功能的实例"></a>4.几个高级功能的实例</h1><ul>
<li><a href="https://zrysmt.github.io/demo/webgl-demo/ch10/RotateObject.html">鼠标控制物体的旋转</a></li>
<li><a href="https://zrysmt.github.io/demo/webgl-demo/ch10/PickObject.html">是否选中物体</a></li>
<li><a href="https://zrysmt.github.io/demo/webgl-demo/ch10/HUD.html">HUD，结合canvas绘制文本</a></li>
<li><a href="https://zrysmt.github.io/demo/webgl-demo/ch10/Fog.html">雾化</a></li>
<li><a href="https://zrysmt.github.io/demo/webgl-demo/ch10/Shadow.html">绘制阴影</a></li>
<li><a href="https://zrysmt.github.io/demo/webgl-demo/ch10/OBJViewer.html">加载三维obj文件</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/05/17/WebGL基础简明教程1-简介/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/05/17/WebGL基础简明教程1-简介/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">WebGL基础简明教程1-简介</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-05-17 13:14:42" itemprop="dateCreated datePublished" datetime="2017-05-17T13:14:42+08:00">2017-05-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:40:53" itemprop="dateModified" datetime="2018-11-30T10:40:53+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我也是个初学WebGL的人，这部分的内容是我在看完《WebGL编程指南》一书后的精简教程。看完之后我对三维世界重建了一些观念，这篇文章是尽量在有限的内容中，一下介绍几个重要的基本的概念，后面我会分几篇再详细介绍几个重要的概念。</p>
<p>WebGL是利用HTML5的canvas绘制和渲染三维图形，再现代的浏览器中均支持。WebGL是从OpenGL ES中继承过来的。</p>
<p>代码存储在我的<a href="https://github.com/zrysmt/data-viz/tree/master/webgl/demo" target="_blank" rel="noopener">GitHub</a>中。</p>
<blockquote>
<p><a href="https://github.com/zrysmt/data-viz/tree/master/webgl/demo" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/tree/master/webgl/demo</a></p>
</blockquote>
<p>首先我们来绘制一个二维的实例，点击的时候绘制一个点。<br>示例程序:<a href="https://zrysmt.github.io/demo/webgl-demo/demo/0-simple.html">https://zrysmt.github.io/demo/webgl-demo/demo/0-simple.html</a>.</p>
<h1 id="1-WebGL二维：一次绘制一个点"><a href="#1-WebGL二维：一次绘制一个点" class="headerlink" title="1.WebGL二维：一次绘制一个点"></a>1.WebGL二维：一次绘制一个点</h1><h2 id="html片段"><a href="#html片段" class="headerlink" title="html片段"></a>html片段</h2><p>注意WebGL canvas的坐标（右，z轴垂直屏幕向外）和二维canvas（左）不一样。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/1-1.jpg" alt=""><br>html片段很简单，我们使用就是canvas元素。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"main()"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"webgl"</span> <span class="attr">width</span>=<span class="string">"400"</span> <span class="attr">height</span>=<span class="string">"400"</span>&gt;</span></span><br><span class="line">        Please use a browser that supports "canvas"</span><br><span class="line">    <span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="WebGL执行流程"><a href="#WebGL执行流程" class="headerlink" title="WebGL执行流程"></a>WebGL执行流程</h2><p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/1-2.jpg" alt=""></p>
<h2 id="从main函数开始"><a href="#从main函数开始" class="headerlink" title="从main函数开始"></a>从main函数开始</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'webgl'</span>);</span><br><span class="line">    <span class="comment">//初始化WebGL</span></span><br><span class="line">    <span class="keyword">var</span> gl = getWebGLContext(canvas);</span><br><span class="line">    <span class="keyword">if</span> (!gl) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to get the rendering context for WebGL'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化着色器</span></span><br><span class="line">    <span class="keyword">if</span> (!initShaders(gl, VSHADER_SOURCE, FSHADER_SOURCE)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to intialize shaders.'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取a_Position的存储位置</span></span><br><span class="line">    <span class="keyword">var</span> a_Position = gl.getAttribLocation(gl.program, <span class="string">'a_Position'</span>);</span><br><span class="line">    <span class="keyword">if</span> (a_Position &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Failed to get the storage location of a_Position'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注册鼠标点击事件</span></span><br><span class="line">    canvas.onmousedown = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span><br><span class="line">        click(ev, gl, canvas, a_Position);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置&lt;canvas&gt;背景色</span></span><br><span class="line">    gl.clearColor(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除&lt;canvas&gt;</span></span><br><span class="line">    gl.clear(gl.COLOR_BUFFER_BIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="顶点着色器"><a href="#顶点着色器" class="headerlink" title="顶点着色器"></a>顶点着色器</h2><p>用来描述顶点的特性（如位置、颜色等）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> VSHADER_SOURCE =</span><br><span class="line">  <span class="string">'attribute vec4 a_Position;\n'</span> +</span><br><span class="line">  <span class="string">'void main() &#123;\n'</span> +</span><br><span class="line">  <span class="string">'  gl_Position = a_Position;\n'</span> +</span><br><span class="line">  <span class="string">'  gl_PointSize = 10.0;\n'</span> +</span><br><span class="line">  <span class="string">'&#125;\n'</span>;</span><br></pre></td></tr></table></figure></p>
<p>是一种类似C的语言。a_Position是一个attribute变量，vec4表示有四个浮点数组成的矢量。</p>
<h2 id="片元着色器"><a href="#片元着色器" class="headerlink" title="片元着色器"></a>片元着色器</h2><p>进行逐片处理的过程如光照<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> FSHADER_SOURCE =</span><br><span class="line">   <span class="string">'void main() &#123;\n'</span> +</span><br><span class="line">   <span class="string">'  gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n'</span> +</span><br><span class="line">   <span class="string">'&#125;\n'</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="使用顶点着色器和片元着色器"><a href="#使用顶点着色器和片元着色器" class="headerlink" title="使用顶点着色器和片元着色器"></a>使用顶点着色器和片元着色器</h2><p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/1-3.jpg" alt=""></p>
<h2 id="初始化着色器"><a href="#初始化着色器" class="headerlink" title="初始化着色器"></a>初始化着色器</h2><p>这部分的代码也是通用的，流程如下,具体代码我们在我的github中查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 1.创建着色器对象(gl.createShader())</span><br><span class="line">* 2.向着色器对象中填充着色器程序的源代码(gl.shaderSource())</span><br><span class="line">* 3.编译着色器(gl.compileShader())</span><br><span class="line">* 4.创建程序对象(gl.createProgram())</span><br><span class="line">* 5.为程序对象分配着色器(gl.attachShader())</span><br><span class="line">* 6.连接程序对象(gl.linkProgram())</span><br><span class="line">* 7.使用程序对象(gl.useProgram())</span><br></pre></td></tr></table></figure></p>
<h2 id="注册鼠标点击事件"><a href="#注册鼠标点击事件" class="headerlink" title="注册鼠标点击事件"></a>注册鼠标点击事件</h2><p>注册鼠标事件，然后对坐标进行处理<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">canvas.onmousedown = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span><br><span class="line">       click(ev, gl, canvas, a_Position);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>注意要转化为WebGL的坐标。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">click</span>(<span class="params">ev, gl, canvas, a_Position</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = ev.clientX; <span class="comment">// 鼠标的x坐标</span></span><br><span class="line">    <span class="keyword">var</span> y = ev.clientY; <span class="comment">// 鼠标的y坐标</span></span><br><span class="line">    <span class="keyword">var</span> rect = ev.target.getBoundingClientRect();</span><br><span class="line"></span><br><span class="line">    x = ((x - rect.left) - canvas.width / <span class="number">2</span>) / (canvas.width / <span class="number">2</span>); <span class="comment">//处理后相得canvas的x坐标</span></span><br><span class="line">    y = (canvas.height / <span class="number">2</span> - (y - rect.top)) / (canvas.height / <span class="number">2</span>); <span class="comment">//处理后相得canvas的y坐标</span></span><br><span class="line">    g_points.push(x);</span><br><span class="line">    g_points.push(y);</span><br><span class="line"></span><br><span class="line">    gl.clear(gl.COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> len = g_points.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// 将顶点位置传给attribute变量a_Position</span></span><br><span class="line">        gl.vertexAttrib3f(a_Position, g_points[i], g_points[i + <span class="number">1</span>], <span class="number">0.0</span>);</span><br><span class="line">        <span class="comment">// 绘制</span></span><br><span class="line">        gl.drawArrays(gl.POINTS, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="绘制"><a href="#绘制" class="headerlink" title="绘制"></a>绘制</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gl.drawArrays(gl.POINTS, <span class="number">0</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/1-4.jpg" alt=""><br>指定第一个参数可以绘制线或三角形，具体的这几个有什么意义，可以查看<a href="https://github.com/zrysmt/data-viz/tree/master/webgl/demo" target="_blank" rel="noopener">github</a>中示例的源码。</p>
<h1 id="2-WebGL二维：绘制多个点"><a href="#2-WebGL二维：绘制多个点" class="headerlink" title="2.WebGL二维：绘制多个点"></a>2.WebGL二维：绘制多个点</h1><p>一次性的将全部的点传给顶点着色器，这个时候就需要用到了<strong>缓冲对象</strong>。<br>我们以绘制个三角形为例（一次性至少传入三个点），示例程序：<a href="https://zrysmt.github.io/demo/webgl-demo/ch03/HelloTriangle.html">https://zrysmt.github.io/demo/webgl-demo/ch03/HelloTriangle.html</a>。<br>效果如下所示：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/1-5.png" alt=""><br>对应的源码位置：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/HelloTriangle.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/HelloTriangle.js</a></p>
<h2 id="创建缓冲区对象"><a href="#创建缓冲区对象" class="headerlink" title="创建缓冲区对象"></a>创建缓冲区对象</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initVertexBuffers</span>(<span class="params">gl</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> vertices = <span class="keyword">new</span> <span class="built_in">Float32Array</span>([</span><br><span class="line">    <span class="number">0</span>, <span class="number">0.5</span>,   <span class="number">-0.5</span>, <span class="number">-0.5</span>,   <span class="number">0.5</span>, <span class="number">-0.5</span></span><br><span class="line">  ]);</span><br><span class="line">  <span class="keyword">var</span> n = <span class="number">3</span>; <span class="comment">// The number of vertices</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建缓冲区对象</span></span><br><span class="line">  <span class="keyword">var</span> vertexBuffer = gl.createBuffer();</span><br><span class="line">  <span class="keyword">if</span> (!vertexBuffer) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Failed to create the buffer object'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定</span></span><br><span class="line">  gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);</span><br><span class="line">  <span class="comment">// 写入数据</span></span><br><span class="line">  gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> a_Position = gl.getAttribLocation(gl.program, <span class="string">'a_Position'</span>);</span><br><span class="line">  <span class="keyword">if</span> (a_Position &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Failed to get the storage location of a_Position'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 缓冲区对象传给a_Position变量</span></span><br><span class="line">  gl.vertexAttribPointer(a_Position, <span class="number">2</span>, gl.FLOAT, <span class="literal">false</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用</span></span><br><span class="line">  gl.enableVertexAttribArray(a_Position);</span><br><span class="line"> <span class="comment">//顶点个数</span></span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-WebGL二维-变换与动画"><a href="#3-WebGL二维-变换与动画" class="headerlink" title="3.WebGL二维-变换与动画"></a>3.WebGL二维-变换与动画</h1><h2 id="变换"><a href="#变换" class="headerlink" title="变换"></a>变换</h2><p>学过线性代数的都知道矢量的变化是可以通过矩阵（4 X 4的，可以容纳下三种变化）完成的。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/1-6.jpg" alt=""></p>
<p>我们来看顶点着色器代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> VSHADER_SOURCE =</span><br><span class="line">  <span class="string">'attribute vec4 a_Position;\n'</span> +</span><br><span class="line">  <span class="string">'uniform mat4 u_xformMatrix;\n'</span> +</span><br><span class="line">  <span class="string">'void main() &#123;\n'</span> +</span><br><span class="line">  <span class="string">'  gl_Position = u_xformMatrix * a_Position;\n'</span> +</span><br><span class="line">  <span class="string">'&#125;\n'</span>;</span><br></pre></td></tr></table></figure></p>
<p>u_xformMatrix就是变化的矩阵。<br>旋转示例：<a href="https://zrysmt.github.io/demo/webgl-demo/ch03/RotatedTriangle_Matrix.html">https://zrysmt.github.io/demo/webgl-demo/ch03/RotatedTriangle_Matrix.html</a><br>旋转示例源码：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/RotatedTriangle_Matrix.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/RotatedTriangle_Matrix.js</a><br>缩放示例：<a href="https://zrysmt.github.io/demo/webgl-demo/ch03/ScaledTriangle_Matrix.html">https://zrysmt.github.io/demo/webgl-demo/ch03/ScaledTriangle_Matrix.html</a><br>缩放示例源码：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/ScaledTriangle_Matrix.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/ScaledTriangle_Matrix.js</a><br>平移示例：<a href="https://zrysmt.github.io/demo/webgl-demo/ch03/TranslatedTriangle.html">https://zrysmt.github.io/demo/webgl-demo/ch03/TranslatedTriangle.html</a><br>平移示例源码：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/TranslatedTriangle.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch03/TranslatedTriangle.js</a></p>
<p><strong>注意：</strong>以后关于矩阵的运算我们使用源码提供的库。旋转使用<code>setRotate</code>,<code>rotate</code>;平移使用<code>setTranslate</code>，<code>translate</code>;缩放使用<code>setScale</code>,<code>scale</code>.<br>这部分的使用<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> formatMatrix = <span class="keyword">new</span> Matrix4();</span><br><span class="line">    formatMatrix.setRotate(ANGLE,<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>); <span class="comment">//绕z轴旋转ANGLE度数</span></span><br><span class="line">    formatMatrix.translate(Tx,Ty,Tz);   <span class="comment">//x,y,z轴上平移</span></span><br></pre></td></tr></table></figure></p>
<p>第一个都要是带z的方法，后面的都不带即可。</p>
<blockquote>
<p><a href="https://github.com/zrysmt/data-viz/blob/master/webgl/lib/cuon-matrix.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/lib/cuon-matrix.js</a></p>
</blockquote>
<h2 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h2><p>动画的原理是使用HTML5 requestAnimationFrame()方法重绘WebGL图形。<br>示例：<a href="https://zrysmt.github.io/demo/webgl-demo/ch04/RotatingTriangle_withButtons.html">https://zrysmt.github.io/demo/webgl-demo/ch04/RotatingTriangle_withButtons.html</a><br>示例源码：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch04/RotatingTriangle_withButtons.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch04/RotatingTriangle_withButtons.js</a></p>
<h1 id="4-WebGL二维-颜色与纹理"><a href="#4-WebGL二维-颜色与纹理" class="headerlink" title="4.WebGL二维-颜色与纹理"></a>4.WebGL二维-颜色与纹理</h1><h2 id="颜色"><a href="#颜色" class="headerlink" title="颜色"></a>颜色</h2><p>示例：<a href="https://zrysmt.github.io/demo/webgl-demo/ch05/ColoredTriangle.html">https://zrysmt.github.io/demo/webgl-demo/ch05/ColoredTriangle.html</a><br>示例源码：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch05/ColoredTriangle.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch05/ColoredTriangle.js</a></p>
<p><strong>大概流程</strong>是这样的：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webgl/1-7.jpg" alt=""><br>顶点坐标==&gt;图形装配==&gt;光栅化==&gt;执行片元着色器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var verticesColors = new Float32Array([</span><br><span class="line">  //  坐标x,坐标y，颜色r，g，b</span><br><span class="line">   0.0,  0.5,  1.0,  0.0,  0.0, </span><br><span class="line">  -0.5, -0.5,  0.0,  1.0,  0.0, </span><br><span class="line">   0.5, -0.5,  0.0,  0.0,  1.0, </span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>initVertexBuffers函数对整个矩阵的处理,位置和颜色分别分配给a_Position和a_Color<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gl.vertexAttribPointer(a_Position, 2, gl.FLOAT, false, FSIZE * 5, 0);</span><br><span class="line">gl.vertexAttribPointer(a_Color, 3, gl.FLOAT, false, FSIZE * 5, FSIZE * 2);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initVertexBuffers</span>(<span class="params">gl</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> verticesColors = <span class="keyword">new</span> <span class="built_in">Float32Array</span>([</span><br><span class="line">    <span class="comment">// Vertex coordinates and color</span></span><br><span class="line">     <span class="number">0.0</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>,  <span class="number">0.0</span>,  <span class="number">0.0</span>, </span><br><span class="line">    <span class="number">-0.5</span>, <span class="number">-0.5</span>,  <span class="number">0.0</span>,  <span class="number">1.0</span>,  <span class="number">0.0</span>, </span><br><span class="line">     <span class="number">0.5</span>, <span class="number">-0.5</span>,  <span class="number">0.0</span>,  <span class="number">0.0</span>,  <span class="number">1.0</span>, </span><br><span class="line">  ]);</span><br><span class="line">  <span class="keyword">var</span> n = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a buffer object</span></span><br><span class="line">  <span class="keyword">var</span> vertexColorBuffer = gl.createBuffer();  </span><br><span class="line">  <span class="keyword">if</span> (!vertexColorBuffer) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Failed to create the buffer object'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bind the buffer object to target</span></span><br><span class="line">  gl.bindBuffer(gl.ARRAY_BUFFER, vertexColorBuffer);</span><br><span class="line">  gl.bufferData(gl.ARRAY_BUFFER, verticesColors, gl.STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> FSIZE = verticesColors.BYTES_PER_ELEMENT;</span><br><span class="line">  <span class="comment">//Get the storage location of a_Position, assign and enable buffer</span></span><br><span class="line">  <span class="keyword">var</span> a_Position = gl.getAttribLocation(gl.program, <span class="string">'a_Position'</span>);</span><br><span class="line">  <span class="keyword">if</span> (a_Position &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Failed to get the storage location of a_Position'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  gl.vertexAttribPointer(a_Position, <span class="number">2</span>, gl.FLOAT, <span class="literal">false</span>, FSIZE * <span class="number">5</span>, <span class="number">0</span>);</span><br><span class="line">  gl.enableVertexAttribArray(a_Position);  <span class="comment">// Enable the assignment of the buffer object</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the storage location of a_Position, assign buffer and enable</span></span><br><span class="line">  <span class="keyword">var</span> a_Color = gl.getAttribLocation(gl.program, <span class="string">'a_Color'</span>);</span><br><span class="line">  <span class="keyword">if</span>(a_Color &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Failed to get the storage location of a_Color'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  gl.vertexAttribPointer(a_Color, <span class="number">3</span>, gl.FLOAT, <span class="literal">false</span>, FSIZE * <span class="number">5</span>, FSIZE * <span class="number">2</span>);</span><br><span class="line">  gl.enableVertexAttribArray(a_Color);  <span class="comment">// Enable the assignment of the buffer object</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Unbind the buffer object</span></span><br><span class="line">  gl.bindBuffer(gl.ARRAY_BUFFER, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="纹理"><a href="#纹理" class="headerlink" title="纹理"></a>纹理</h2><p>示例：<a href="https://zrysmt.github.io/demo/webgl-demo/ch05/TexturedQuad.html">https://zrysmt.github.io/demo/webgl-demo/ch05/TexturedQuad.html</a><br>示例源码：<a href="https://github.com/zrysmt/data-viz/blob/master/webgl/ch05/TexturedQuad.js" target="_blank" rel="noopener">https://github.com/zrysmt/data-viz/blob/master/webgl/ch05/TexturedQuad.js</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> image = <span class="keyword">new</span> Image();  <span class="comment">// Create the image object</span></span><br><span class="line">  <span class="keyword">if</span> (!image) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Failed to create the image object'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Register the event handler to be called on loading an image</span></span><br><span class="line">  image.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; loadTexture(gl, n, texture, u_Sampler, image); &#125;;</span><br><span class="line">  <span class="comment">// Tell the browser to load an image</span></span><br><span class="line">  image.src = <span class="string">'../resources/sky.jpg'</span>;</span><br></pre></td></tr></table></figure>
<p>逻辑函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadTexture</span>(<span class="params">gl, n, texture, u_Sampler, image</span>) </span>&#123;</span><br><span class="line">  gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, <span class="number">1</span>); <span class="comment">// Flip the image's y axis</span></span><br><span class="line">  <span class="comment">// Enable texture unit0</span></span><br><span class="line">  gl.activeTexture(gl.TEXTURE0);</span><br><span class="line">  <span class="comment">// Bind the texture object to the target</span></span><br><span class="line">  gl.bindTexture(gl.TEXTURE_2D, texture);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the texture parameters</span></span><br><span class="line">  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);</span><br><span class="line">  <span class="comment">// Set the texture image</span></span><br><span class="line">  gl.texImage2D(gl.TEXTURE_2D, <span class="number">0</span>, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Set the texture unit 0 to the sampler</span></span><br><span class="line">  gl.uniform1i(u_Sampler, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  gl.clear(gl.COLOR_BUFFER_BIT);   <span class="comment">// Clear &lt;canvas&gt;</span></span><br><span class="line"></span><br><span class="line">  gl.drawArrays(gl.TRIANGLE_STRIP, <span class="number">0</span>, n); <span class="comment">// Draw the rectangle</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>三维单独写一篇介绍。</p>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="">WebGL权威指南</a></li>
<li><a href="http://blog.csdn.net/lh1162810317/article/details/50827948" target="_blank" rel="noopener">webgl开源三维引擎的选择</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebGL_API" target="_blank" rel="noopener">MDN-WebGl API</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebGL_API/Tutorial" target="_blank" rel="noopener">MDN-WebGL 中文教程</a> </li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/05/04/使用leaflet或者openlayers-3-调用MapServer服务最佳实践完整说明/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/05/04/使用leaflet或者openlayers-3-调用MapServer服务最佳实践完整说明/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">使用leaflet或者openlayers 3 调用MapServer服务最佳实践完整说明</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-05-04 20:36:48" itemprop="dateCreated datePublished" datetime="2017-05-04T20:36:48+08:00">2017-05-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:40:53" itemprop="dateModified" datetime="2018-11-30T10:40:53+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/WebGIS/" itemprop="url" rel="index"><span itemprop="name">WebGIS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近尝试了很多次，看到网上的很多教程都是版本比较老旧，会出现很多问题。经过数天的实践，现在可以调用成功，遂将步骤记录在此。<br>为避免以后使用的软件不兼容，首先给出基于window 10的软件版本：</p>
<ul>
<li>MapServer服务器  3.2.1 <a href="http://www.ms4w.com/release/ms4w-3.2.1-setup.exe" target="_blank" rel="noopener">ms4w-3.2.1-setup.exe</a></li>
</ul>
<blockquote>
<p><a href="http://www.ms4w.com/" target="_blank" rel="noopener">http://www.ms4w.com/</a></p>
</blockquote>
<ul>
<li>QGIS 2.18 <a href="http://www.qgis.org/en/site/forusers/download.html" target="_blank" rel="noopener">osgeo4w-setup-x86_64.exe</a></li>
</ul>
<blockquote>
<p><a href="http://www.qgis.org/en/site/forusers/download.html" target="_blank" rel="noopener">http://www.qgis.org/en/site/forusers/download.html</a></p>
</blockquote>
<hr>
<p>所有配置和示例我都放在了github仓库中<a href="https://github.com/zrysmt/mapserver-leaflet-openlayers" target="_blank" rel="noopener">mapserver-leaflet-openlayers</a>。</p>
<blockquote>
<p><a href="https://github.com/zrysmt/mapserver-leaflet-openlayers" target="_blank" rel="noopener">https://github.com/zrysmt/mapserver-leaflet-openlayers</a></p>
</blockquote>
<h1 id="1-安装说明"><a href="#1-安装说明" class="headerlink" title="1.安装说明"></a>1.安装说明</h1><h2 id="1-1-ms4w-3-2-1-setup-exe"><a href="#1-1-ms4w-3-2-1-setup-exe" class="headerlink" title="1.1 ms4w-3.2.1-setup.exe"></a>1.1 ms4w-3.2.1-setup.exe</h2><p>Windows平台MapServer （MS4W）安装<a href="http://mapserver.org/de/introduction.html" target="_blank" rel="noopener">Windows平台MapServer （MS4W）安装</a></p>
<blockquote>
<p><a href="http://blog.csdn.net/u010924834/article/details/53434322" target="_blank" rel="noopener">http://blog.csdn.net/u010924834/article/details/53434322</a><br><a href="http://mapserver.org/de/introduction.html" target="_blank" rel="noopener">http://mapserver.org/de/introduction.html</a></p>
</blockquote>
<p>MapServer的安装包（ms4w.zip,解压到根目录下）里内置了<strong>Apache</strong>，不过因为IIS占用了80的端口，所以需要设置下端口 （在\ms4w\Apache\conf\ httpd.conf中，将Listen 80改为Listen 8081）</p>
<h2 id="1-2-osgeo4w-setup-x86-64-exe"><a href="#1-2-osgeo4w-setup-x86-64-exe" class="headerlink" title="1.2 osgeo4w-setup-x86_64.exe"></a>1.2 osgeo4w-setup-x86_64.exe</h2><p>因为刚开始值安装了Destop桌面端，后来出了问题，无奈废了很大的劲又卸载了重新安装的。这里建议全部安装，选择<code>Advanced Install</code> 点击选择全部安装即可。</p>
<h2 id="1-3-QGIS几个重要的插件"><a href="#1-3-QGIS几个重要的插件" class="headerlink" title="1.3 QGIS几个重要的插件"></a>1.3 QGIS几个重要的插件</h2><p>安装插件<br>qGIS菜单栏plugin–&gt;Manager and Install Plugin<br><strong>1.qgis2web</strong><br>会导出一个完整的网页结构<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/1.png" alt=""><br>【Update perview】可以更换坐标系<br>【Export】导出即可</p>
<p>导出后会打开一个网页，我们需要的是data文件夹下的js，里面有geoJson数据</p>
<p><strong>2.RT Mapfile Export</strong><br>这是我们发布地图服务的重要的插件</p>
<p>使用插件的时候注意先设置好，打开<code>Manager and Install Plugin</code>对话框，注意在设置中勾选住实验性的插件一项，再搜索插件并进行安装。</p>
<h1 id="2-发布服务"><a href="#2-发布服务" class="headerlink" title="2.发布服务"></a>2.发布服务</h1><p>安装好<code>RT Mapfile Export</code>插件后，我们就可以使用QGIS导出Mapfile文件用来发布服务了。<br><strong>坐标系</strong><br>首先重要的一点是坐标系一定要选择好。如果不满足，可以使用QGIS工具<code>Reproject Layer</code>转换坐标系。目前常用的是EPSG：3857 墨卡托坐标系和EPSG：4326 WGS84坐标系，这里我们就以3857坐标系为例。</p>
<p><strong>MapFile</strong><br>在发布服务方面，MapServer有一个和mxd（ArcGIS）类似的map文件来描述地图的图层及样式，不同的是，在使用地图服务的时候，调用的url中需要知道map文件的位置，而ArcGIS则不需要</p>
<p>关于MapFile,这里就不单独介绍太多，Mapfile的作用如下图所示。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/2-1.png" alt=""><br>基本介绍：<br><a href="http://blog.csdn.net/qingyafan/article/details/46500127" target="_blank" rel="noopener">http://blog.csdn.net/qingyafan/article/details/46500127</a><br>MapServer 快速入门文档：<br><a href="http://live.osgeo.org/zh/quickstart/mapserver_quickstart.html" target="_blank" rel="noopener">http://live.osgeo.org/zh/quickstart/mapserver_quickstart.html</a></p>
<p><strong>发布过程</strong><br>因为我把发布的服务器端口改为8000了，所以<code>Online resource url</code>地址是<code>http://127.0.0.1:8000/cgi-bin/mapserv.exe</code><br>1.<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/2-2.png" alt=""><br>2.<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/2-3.png" alt=""><br>3.<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/2-4.png" alt=""><br>【确定】即可生成mapfile文件，在本文末尾会给出.<br>mapfile文件地址在<code>E:\ms4w\apps\worldmap</code>中。<br>我们在浏览器中输入地址<code>http://127.0.0.1:8000/cgi-bin/mapserv.exe?MAP=E:/ms4w/apps/worldmap/world3857.map&amp;LAYERS=World_region&amp;MODE=MAP</code><br><strong>注意:</strong>在使用类库调用该WMS服务的时候一定要去掉<code>&amp;MODE=MAP</code>,否则不能成功。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/2-5.png" alt=""></p>
<h1 id="3-使用leaflet或openlayers调用"><a href="#3-使用leaflet或openlayers调用" class="headerlink" title="3.使用leaflet或openlayers调用"></a>3.使用leaflet或openlayers调用</h1><p>leaflet示例如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>leaflet加载MapServer示例子<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;link rel="stylesheet" href="../app/common/css/leaflet.css"&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/leaflet/1.0.3/leaflet.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-id">#map</span> &#123;</span></span><br><span class="line"><span class="undefined">        width: 100%;</span></span><br><span class="line"><span class="undefined">        height: 600px;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/leaflet/1.0.3/leaflet-src.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;script src="../app/common/leaflet-plugin/leaflet-src.js"&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> map = L.map(<span class="string">'map'</span>, &#123;</span></span><br><span class="line"><span class="undefined">        crs: L.CRS.EPSG3857</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">    map.setView([30, 104], 2);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// let map = L.map('map').setView([30, 104], 10); //默认墨卡托投影 ESPG：3857</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//http://127.0.0.1:8000/cgi-bin/mapserv.exe?MAP=E:/ms4w/apps/test/test.map&amp;LAYERS=ALL&amp;MODE=MAP</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//一定不要有&amp;MODE=MAP</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> myDemo = L.tileLayer.wms(<span class="string">"http://127.0.0.1:8000/cgi-bin/mapserv.exe?MAP=E:/ms4w/apps/worldmap/world3857.map"</span>, &#123;</span></span><br><span class="line"><span class="javascript">        layers: <span class="string">'World_region'</span>,</span></span><br><span class="line"><span class="javascript">        format: <span class="string">'image/png'</span>,</span></span><br><span class="line"><span class="javascript">        transparent: <span class="literal">false</span>,</span></span><br><span class="line"><span class="undefined">        crs: L.CRS.EPSG3857,</span></span><br><span class="line"><span class="javascript">        attribution: <span class="string">"自定义地图"</span>,</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    myDemo.addTo(map);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>访问示例如下：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/3-1.png" alt=""><br>openlayers示例如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>openlayers 3加载MapServer示例子<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://openlayers.org/en/v4.1.1/css/ol.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-id">#map</span> &#123;</span></span><br><span class="line"><span class="undefined">        width: 100%;</span></span><br><span class="line"><span class="undefined">        height: 600px;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://openlayers.org/en/v4.1.1/build/ol.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> layers = [</span></span><br><span class="line"><span class="javascript">        <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="javascript">            source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">        &#125;),</span></span><br><span class="line"><span class="javascript">        <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="javascript">            source: <span class="keyword">new</span> ol.source.TileWMS(&#123;</span></span><br><span class="line"><span class="javascript">                url: <span class="string">'http://127.0.0.1:8000/cgi-bin/mapserv.exe'</span>,</span></span><br><span class="line"><span class="undefined">                params: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">'layers'</span>: <span class="string">'World_region'</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">'MAP'</span>: <span class="string">"E:/ms4w/apps/worldmap/world3857.map"</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">'TILED'</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="javascript">                serverType: <span class="string">'mapserver'</span>,</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    ];</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="javascript">        target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="undefined">        layers: layers,</span></span><br><span class="line"><span class="javascript">        view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">            center: ol.proj.fromLonLat([104, 30]),</span></span><br><span class="line"><span class="undefined">            zoom: 2,</span></span><br><span class="line"><span class="javascript">            projection: <span class="string">'EPSG:3857'</span></span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>访问示例如下：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/mapserver/3-2.png" alt=""></p>
<h1 id="4-附录：mapfile文件world3857-map"><a href="#4-附录：mapfile文件world3857-map" class="headerlink" title="4.附录：mapfile文件world3857.map"></a>4.附录：mapfile文件world3857.map</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">MAP</span><br><span class="line">  FONTSET &quot;E:/ms4w/apps/etc/fonts.txt&quot;</span><br><span class="line">  EXTENT -179.99942 -59.484295 180 83.627357</span><br><span class="line">  IMAGETYPE &quot;png&quot;</span><br><span class="line">  NAME &quot;QGIS--MAP&quot;</span><br><span class="line">  SHAPEPATH &quot;E:/ms4w/apps/data/worldmap3857&quot;</span><br><span class="line">  SIZE 800 800</span><br><span class="line">  STATUS ON</span><br><span class="line">  UNITS DD</span><br><span class="line"></span><br><span class="line">  OUTPUTFORMAT</span><br><span class="line">    NAME &quot;png&quot;</span><br><span class="line">    MIMETYPE &quot;image/png&quot;</span><br><span class="line">    DRIVER &quot;AGG/PNG&quot;</span><br><span class="line">    EXTENSION &quot;png&quot;</span><br><span class="line">    IMAGEMODE RGB</span><br><span class="line">    TRANSPARENT FALSE</span><br><span class="line">  END # OUTPUTFORMAT</span><br><span class="line"></span><br><span class="line">  PROJECTION</span><br><span class="line">    &quot;proj=longlat&quot;</span><br><span class="line">    &quot;datum=WGS84&quot;</span><br><span class="line">    &quot;no_defs&quot;</span><br><span class="line">    &quot;init=epsg:3857&quot;</span><br><span class="line">  END # PROJECTION</span><br><span class="line">  LEGEND</span><br><span class="line">    KEYSIZE 20 20</span><br><span class="line">    KEYSPACING 5 5</span><br><span class="line">    LABEL</span><br><span class="line">      SIZE MEDIUM</span><br><span class="line">      OFFSET 0 0</span><br><span class="line">      SHADOWSIZE 1 1</span><br><span class="line">      TYPE BITMAP</span><br><span class="line">    END # LABEL</span><br><span class="line">    STATUS OFF</span><br><span class="line">  END # LEGEND</span><br><span class="line"></span><br><span class="line">  QUERYMAP</span><br><span class="line">    SIZE -1 -1</span><br><span class="line">    STATUS OFF</span><br><span class="line">    STYLE HILITE</span><br><span class="line">  END # QUERYMAP</span><br><span class="line"></span><br><span class="line">  SCALEBAR</span><br><span class="line">    INTERVALS 4</span><br><span class="line">    LABEL</span><br><span class="line">      SIZE MEDIUM</span><br><span class="line">      OFFSET 0 0</span><br><span class="line">      SHADOWSIZE 1 1</span><br><span class="line">      TYPE BITMAP</span><br><span class="line">    END # LABEL</span><br><span class="line">    SIZE 200 3</span><br><span class="line">    STATUS OFF</span><br><span class="line">    UNITS MILES</span><br><span class="line">  END # SCALEBAR</span><br><span class="line"></span><br><span class="line">  WEB</span><br><span class="line">    FOOTER &quot;&quot;</span><br><span class="line">    HEADER &quot;&quot;</span><br><span class="line">    IMAGEPATH &quot;E:/ms4w/tmp/ms_tmp/&quot;</span><br><span class="line">    TEMPPATH &quot;E:/ms4w/tmp/&quot;</span><br><span class="line">    IMAGEURL &quot;/tmp/&quot;</span><br><span class="line">    METADATA</span><br><span class="line">      &quot;wms_onlineresource&quot; &quot;http://127.0.0.1:8000/cgi-bin/mapserv.exe?map=E:/ms4w/apps/test2/test2.map&quot;</span><br><span class="line">      &quot;wms_enable_request&quot; &quot;*&quot;</span><br><span class="line">      &quot;wms_srs&quot; &quot;EPSG:3857&quot;</span><br><span class="line">      &quot;wms_feature_info_mime_type&quot; &quot;text/html&quot;</span><br><span class="line">      &quot;wms_format&quot; &quot;image/png&quot;</span><br><span class="line">    END # METADATA</span><br><span class="line">    TEMPLATE &quot;E:/ms4w/apps/test2/test.map.html.tmpl&quot;</span><br><span class="line">  END # WEB</span><br><span class="line"></span><br><span class="line">  LAYER</span><br><span class="line">    DATA &quot;E:/ms4w/apps/data/worldmap3857/World_region.shp&quot;</span><br><span class="line">    EXTENT -20037443.7774846 -8285806.11600741 20037508.3427892 18422153.0437227</span><br><span class="line">    METADATA</span><br><span class="line">      &quot;ows_include_items&quot;    &quot;all&quot;</span><br><span class="line">      &quot;ows_extent&quot;    &quot;-20037443.7775 -8285806.11601 20037508.3428 18422153.0437&quot;</span><br><span class="line">      &quot;ows_srs&quot;    &quot;EPSG:3857&quot;</span><br><span class="line">      &quot;ows_title&quot;    &quot;World_region&quot;</span><br><span class="line">      &quot;wms_getfeatureinfo_formatlist&quot;    &quot;OGRGML&quot;</span><br><span class="line">      &quot;wms_bbox_extended&quot;    &quot;true&quot;</span><br><span class="line">      &quot;gml_include_items&quot;    &quot;all&quot;</span><br><span class="line">    END # METADATA</span><br><span class="line">    NAME &quot;World_region&quot;</span><br><span class="line">    PROJECTION</span><br><span class="line">      &quot;proj=merc&quot;</span><br><span class="line">      &quot;a=6378137&quot;</span><br><span class="line">      &quot;b=6378137&quot;</span><br><span class="line">      &quot;lat_ts=0.0&quot;</span><br><span class="line">      &quot;lon_0=0.0&quot;</span><br><span class="line">      &quot;x_0=0.0&quot;</span><br><span class="line">      &quot;y_0=0&quot;</span><br><span class="line">      &quot;k=1.0&quot;</span><br><span class="line">      &quot;units=m&quot;</span><br><span class="line">      &quot;nadgrids=@null&quot;</span><br><span class="line">      &quot;wktext&quot;</span><br><span class="line">      &quot;no_defs&quot;</span><br><span class="line">    END # PROJECTION</span><br><span class="line">    STATUS ON</span><br><span class="line">    TILEITEM &quot;location&quot;</span><br><span class="line">    TYPE POLYGON</span><br><span class="line">    UNITS METERS</span><br><span class="line">    CLASS</span><br><span class="line">      NAME &quot;Single symbol&quot;</span><br><span class="line">      STYLE</span><br><span class="line">        COLOR 209 143 80</span><br><span class="line">      END # STYLE</span><br><span class="line">      STYLE</span><br><span class="line">        OUTLINECOLOR 0 0 1</span><br><span class="line">      END # STYLE</span><br><span class="line">    END # CLASS</span><br><span class="line">  END # LAYER</span><br><span class="line"></span><br><span class="line">END # MAP</span><br></pre></td></tr></table></figure>
<p>所有配置和示例我都放在了github仓库中<a href="https://github.com/zrysmt/mapserver-leaflet-openlayers" target="_blank" rel="noopener">mapserver-leaflet-openlayers</a>。</p>
<blockquote>
<p><a href="https://github.com/zrysmt/mapserver-leaflet-openlayers" target="_blank" rel="noopener">https://github.com/zrysmt/mapserver-leaflet-openlayers</a></p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/04/28/阿里巴巴校招2017前端笔试题目-原生js-html5-实现一个路由/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/04/28/阿里巴巴校招2017前端笔试题目-原生js-html5-实现一个路由/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">阿里巴巴校招2017前端笔试题目 -- 原生js/html5 实现一个路由</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-04-28 12:44:52" itemprop="dateCreated datePublished" datetime="2017-04-28T12:44:52+08:00">2017-04-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:40:53" itemprop="dateModified" datetime="2018-11-30T10:40:53+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>阿里巴巴校招2017前端笔试题目：<br>1）路由有什么缺点？<br>2）原生js/html5 实现一个路由</p>
<p>缺点:</p>
<ul>
<li>使用浏览器的前进，后退键的时候会重新发送请求，没有合理地利用缓存</li>
<li>单页面无法记住之前滚动的位置，无法在前进，后退的时候记住滚动的位置</li>
</ul>
<p>路由的概念：</p>
<ul>
<li>路由是根据不同的 url 地址展示不同的内容或页面</li>
<li>前端路由就是把不同路由对应不同的内容或页面的任务交给前端来做，之前是通过服务端根据 url 的不同返回不同的页面实现的。</li>
</ul>
<p>我们直接来看两个例子，一个是hash结构的，这是在Html5 的history api出现之前的解决方案；一个是基于history api实现的。</p>
<ul>
<li>hash</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.1/</span><br><span class="line">http://10.0.0.1/#/about</span><br><span class="line">http://10.0.0.1/#/concat</span><br></pre></td></tr></table></figure>
<ul>
<li>history</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.1/</span><br><span class="line">http://10.0.0.1/about</span><br><span class="line">http://10.0.0.1/concat</span><br></pre></td></tr></table></figure>
<p>前端的路由和后端的路由在实现技术上不一样，但是原理都是一样的。</p>
<h1 id="1-hash"><a href="#1-hash" class="headerlink" title="1.hash"></a>1.hash</h1><p>关键是监控两个事件，一个是页面加载进来的时候触发<code>load</code>,一个是hash改变的时候触发<code>hashchange</code>。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">        &lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#/"</span>&gt;</span>turn white<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">        &lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#/blue"</span>&gt;</span>turn blue<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">        &lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#/green"</span>&gt;</span>turn green<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script&gt;</span></span><br><span class="line"><span class="regexp">    class Router &#123;</span></span><br><span class="line"><span class="regexp">        constructor() &#123;</span></span><br><span class="line"><span class="regexp">            this.routes = &#123;&#125;;</span></span><br><span class="line"><span class="regexp">            this.curUrl = "";</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        route(path, callback) &#123;</span></span><br><span class="line"><span class="regexp">            this.routes[path] = callback || function() &#123;&#125;;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        refresh() &#123;</span></span><br><span class="line"><span class="regexp">            this.curUrl = location.hash.slice(1) || '/</span><span class="string">';</span></span><br><span class="line"><span class="string">            this.routes[this.curUrl]();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        init() &#123;</span></span><br><span class="line"><span class="string">            window.addEventListener('</span>load<span class="string">', this.refresh.bind(this), false);</span></span><br><span class="line"><span class="string">            window.addEventListener('</span>hashchange<span class="string">', this.refresh.bind(this), false);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var router = new Router();</span></span><br><span class="line"><span class="string">    router.init();</span></span><br><span class="line"><span class="string">    var content = document.querySelector('</span>body<span class="string">');</span></span><br><span class="line"><span class="string">    // change Page anything</span></span><br><span class="line"><span class="string">    function changeBgColor(color) &#123;</span></span><br><span class="line"><span class="string">        content.style.backgroundColor = color;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    router.route('</span>/<span class="string">', function() &#123;</span></span><br><span class="line"><span class="string">        changeBgColor('</span>white<span class="string">');</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    router.route('</span>/blue<span class="string">', function() &#123;</span></span><br><span class="line"><span class="string">        changeBgColor('</span>blue<span class="string">');</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    router.route('</span>/green<span class="string">', function() &#123;</span></span><br><span class="line"><span class="string">        changeBgColor('</span>green<span class="string">');</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="2-history-api"><a href="#2-history-api" class="headerlink" title="2.history api"></a>2.history api</h1><p>html5 增加了两个方法，分别是<code>pushState</code>，<code>replaceState</code>.</p>
<p>两个方法均有三个参数：一个状态对象、一个标题（现在会被忽略），一个可选的URL地址<br><strong>状态对象（state object）</strong> — 一个JavaScript对象，与用pushState()方法创建的新历史记录条目关联。无论何时用户导航到新创建的状态，popstate事件都会被触发，并且事件对象的state属性都包含历史记录条目的状态对象的拷贝。</p>
<p>任何可序列化的对象都可以被当做状态对象。因为FireFox浏览器会把状态对象保存到用户的硬盘，这样它们就能在用户重启浏览器之后被还原，我们强行限制状态对象的大小为640k。如果你向pushState()方法传递了一个超过该限额的状态对象，该方法会抛出异常。如果你需要存储很大的数据，建议使用sessionStorage或localStorage。</p>
<p>pushState 用于向 history 添加当前页面的记录，而 replaceState 和 pushState 的用法完全一样，唯一的区别就是它用于修改当前页面在 history 中的记录。</p>
<p><strong>两者的一个表现的区别是</strong>：在浏览器上点击后退键的时候，使用pushState的会正常按照点击的顺序依次返回，而使用replaceState的只是替换，不会返回，会直接返回到pushState的记录。</p>
<p><strong>index.html</strong><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Simple History<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"push"</span> <span class="attr">href</span>=<span class="string">"?push-one"</span>&gt;</span>Push One<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"push"</span> <span class="attr">href</span>=<span class="string">"?push-two"</span>&gt;</span>Push Two<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"push"</span> <span class="attr">href</span>=<span class="string">"?push-three"</span>&gt;</span>Push Three<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"replace"</span> <span class="attr">href</span>=<span class="string">"?replace-one"</span>&gt;</span>Replace One<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"replace"</span> <span class="attr">href</span>=<span class="string">"?replace-two"</span>&gt;</span>Replace Two<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"replace"</span> <span class="attr">href</span>=<span class="string">"?replace-three"</span>&gt;</span>Replace Three<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"log"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"simple-history.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/1.7.1/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!SimpleHistory.supported) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        SimpleHistory.start(<span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"match"</span>, path);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.title = <span class="string">"Simple History - "</span> + path;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"&lt;li&gt;"</span>).text(<span class="string">"match: "</span> + path).appendTo(<span class="string">"#log"</span>);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"a:not([href^=http])"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (event.metaKey || event.shiftKey || event.ctrlKey) &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">            event.preventDefault();</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> path = $(event.target).attr(<span class="string">"href"</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> ($(event.target).is(<span class="string">".push"</span>)) &#123;</span></span><br><span class="line"><span class="undefined">                SimpleHistory.pushState(event.target.href);</span></span><br><span class="line"><span class="javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">                SimpleHistory.replaceState(event.target.href);</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;())</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>simple-history.js</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">window, undefined</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> initial = location.href;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.SimpleHistory = &#123;</span><br><span class="line">        supported: !!(<span class="built_in">window</span>.history &amp;&amp; <span class="built_in">window</span>.history.pushState),</span><br><span class="line">        pushState: <span class="function"><span class="keyword">function</span>(<span class="params">fragment, state</span>) </span>&#123;</span><br><span class="line">            state = state || &#123;&#125;;</span><br><span class="line">            history.pushState(state, <span class="literal">null</span>, fragment);</span><br><span class="line">            <span class="keyword">this</span>.notify(state);</span><br><span class="line">        &#125;,</span><br><span class="line">        replaceState: <span class="function"><span class="keyword">function</span>(<span class="params">fragment, state</span>) </span>&#123;</span><br><span class="line">            state = state || &#123;&#125;;</span><br><span class="line">            history.replaceState(state, <span class="literal">null</span>, fragment);</span><br><span class="line">        &#125;,</span><br><span class="line">        notify: <span class="function"><span class="keyword">function</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(location.pathname,location.search);</span><br><span class="line">            <span class="keyword">this</span>.matcher(location.pathname + location.search, state);</span><br><span class="line">        &#125;,</span><br><span class="line">        start: <span class="function"><span class="keyword">function</span>(<span class="params">matcher</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.matcher = matcher;</span><br><span class="line">            <span class="built_in">window</span>.addEventListener(<span class="string">"popstate"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// workaround to always ignore first popstate event (Chrome)</span></span><br><span class="line">                <span class="comment">// a timeout isn't reliable enough</span></span><br><span class="line">                <span class="keyword">if</span> (initial &amp;&amp; initial === location.href) &#123;</span><br><span class="line">                    initial = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                SimpleHistory.notify(event.state || &#123;&#125;);</span><br><span class="line">            &#125;, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;(<span class="built_in">window</span>));</span><br></pre></td></tr></table></figure></p>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="http://blog.csdn.net/sunxinty/article/details/52586556" target="_blank" rel="noopener"> 原生JS实现一个简单的前端路由（路由实现的原理）</a></li>
<li><a href="http://blog.csdn.net/u013063153/article/details/52513872" target="_blank" rel="noopener">从 React Router 谈谈路由的那些事</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/03/28/openlayers 3扩展，调用百度地图、高德地图、天地图服务/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/03/28/openlayers 3扩展，调用百度地图、高德地图、天地图服务/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">openlayers 3扩展，调用百度地图、高德地图、天地图服务</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-28 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-28T00:00:00+08:00">2017-03-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:01:14" itemprop="dateModified" datetime="2018-11-30T11:01:14+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/WebGIS/" itemprop="url" rel="index"><span itemprop="name">WebGIS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>调用这三个商业地图服务，我们使用的都是切片（Tile）地图服务，关于切片地图的含义这里做简单的介绍：<br>切片地图就是指将显示的地图切成一块一块的(256 * 256)分别显示加载。openlayers 3中有这样图层加载类，<code>ol.layer.Tile</code>,对应的source类有<code>ol.source.TileImage</code>,<code>ol.source.XYZ</code>,这两者的关系通过源码可以看到<br><code>ol.inherits(ol.source.XYZ, ol.source.TileImage);</code>,<code>ol.source.TileImage</code>是父类。</p>
<p>对于天地图，我们访问<a href="http://map.tianditu.com/map/index.html" target="_blank" rel="noopener">天地图</a>地图主页服务，打开控制台-&gt;<code>Network</code>,我们可以看到请求的一些地址如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://t2.tianditu.com/DataServer?T=vec_w&amp;x=53&amp;y=24&amp;l=6&apos;</span><br></pre></td></tr></table></figure>
<p>其中重要的信息是x,y,z分别表示x坐标，y坐标和zoomLevel,</p>
<p>其实在openlayers 3源码中有Bing地图和OSM地图的扩展了，我们可以仿照它们进行一些扩展。</p>
<h2 id="1-扩展天地图"><a href="#1-扩展天地图" class="headerlink" title="1.扩展天地图"></a>1.扩展天地图</h2><p>源码使用模块化打包</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ol = <span class="built_in">require</span>(<span class="string">'openlayers'</span>);</span><br><span class="line"></span><br><span class="line">ol.source.TianMap = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> options = options ? options : &#123;&#125;;</span><br><span class="line">  	<span class="keyword">var</span> attributions;</span><br><span class="line">  	<span class="keyword">if</span>(options.attributions !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">  		attributions = option.attributions;</span><br><span class="line">  	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  		attributions = [ol.source.BaiduMap.ATTRIBUTION];</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> url;</span><br><span class="line">    <span class="keyword">if</span>(options.mapType == <span class="string">"sat"</span>)&#123;</span><br><span class="line">    	url = <span class="string">"http://t&#123;0-4&#125;.tianditu.com/DataServer?T=img_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(options.mapType == <span class="string">"satLabel"</span>)&#123;</span><br><span class="line">    	url = <span class="string">"http://t&#123;0-4&#125;.tianditu.com/DataServer?T=cia_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(options.mapType == <span class="string">"label"</span>)&#123;</span><br><span class="line">    	url = <span class="string">"http://t&#123;0-4&#125;.tianditu.com/DataServer?T=cva_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    	url = <span class="string">"http://t&#123;0-4&#125;.tianditu.com/DataServer?T=vec_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  	</span><br><span class="line">  	ol.source.XYZ.call(<span class="keyword">this</span>, &#123;</span><br><span class="line">  	  attributions: attributions,</span><br><span class="line">      projection: ol.proj.get(<span class="string">'EPSG:3857'</span>),</span><br><span class="line">  	  cacheSize: options.cacheSize,</span><br><span class="line">  	  crossOrigin: <span class="string">'anonymous'</span>,</span><br><span class="line">  	  opaque: options.opaque !== <span class="literal">undefined</span> ? options.opaque : <span class="literal">true</span>,</span><br><span class="line">  	  maxZoom: options.maxZoom !== <span class="literal">undefined</span> ? options.maxZoom : <span class="number">19</span>,</span><br><span class="line">  	  reprojectionErrorThreshold: options.reprojectionErrorThreshold,</span><br><span class="line">  	  tileLoadFunction: options.tileLoadFunction,</span><br><span class="line">  	  url: url,</span><br><span class="line">  	  wrapX: options.wrapX</span><br><span class="line">  	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">ol.inherits(ol.source.TianMap, ol.source.XYZ);</span><br><span class="line"></span><br><span class="line">ol.source.TianMap.ATTRIBUTION = <span class="keyword">new</span> ol.Attribution(&#123;</span><br><span class="line">  	html: <span class="string">'&amp;copy; &lt;a class="ol-attribution-tianmap" '</span> +</span><br><span class="line">      <span class="string">'href="http://www.tianditu.cn/"&gt;'</span> +</span><br><span class="line">      <span class="string">'天地图&lt;/a&gt;'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = ol.source.TianMap;</span><br></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tianMapSat = <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">    title: <span class="string">"天地图卫星"</span>,</span><br><span class="line">    source: <span class="keyword">new</span> ol.source.TianMap(&#123;<span class="attr">mapType</span>:<span class="string">"sat"</span>&#125;)</span><br><span class="line">&#125;);</span><br><span class="line">map.addLayer(tianMapSat);</span><br></pre></td></tr></table></figure>
<h2 id="2-扩展百度地图"><a href="#2-扩展百度地图" class="headerlink" title="2. 扩展百度地图"></a>2. 扩展百度地图</h2><p>百度地图坐标进行了加偏，所以需要使用<code>projzh</code>转化<br>百度地图使用的是定制化的墨卡托投影和BD-09 datum,所以将WGS-84坐标转化为百度坐标需要两步<br>first transform from WGS-84 to BD-09 (which itself uses the GCJ-09 transform), and then do the forward transform to Baidu Mercator<br>第一步是将WGS-84 转化为 BD-09，然后转化为百度墨卡托<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">baiduMercator.forward(bd09.fromWGS84(point))</span><br></pre></td></tr></table></figure></p>
<p>反过来的转化为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bd09.toWGS84(baiduMercator.inverse(point))</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><a href="https://github.com/tschaub/projzh" target="_blank" rel="noopener">https://github.com/tschaub/projzh</a></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ol = <span class="built_in">require</span>(<span class="string">'openlayers'</span>);</span><br><span class="line"><span class="keyword">var</span> projzh = <span class="built_in">require</span>(<span class="string">'projzh'</span>);</span><br><span class="line"><span class="comment">/* projzh处理百度坐标的问题，算法基于proj4m project</span></span><br><span class="line"><span class="comment"> * https://www.versioneye.com/nodejs/projzh/0.5.0</span></span><br><span class="line"><span class="comment"> * https://github.com/tschaub/projzh</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ol.source.BaiduMap = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> options = options ? options : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  	<span class="keyword">var</span> attributions;</span><br><span class="line">  	<span class="keyword">if</span>(options.attributions !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">  		attributions = option.attributions;</span><br><span class="line">  	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  		attributions = [ol.source.BaiduMap.ATTRIBUTION];</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> extent = [<span class="number">72.004</span>, <span class="number">0.8293</span>, <span class="number">137.8347</span>, <span class="number">55.8271</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义百度坐标</span></span><br><span class="line">    <span class="comment">//地址：https://github.com/openlayers/openlayers/issues/3522</span></span><br><span class="line">    <span class="keyword">var</span> baiduMercator = <span class="keyword">new</span> ol.proj.Projection(&#123;</span><br><span class="line">        code: <span class="string">'baidu'</span>,</span><br><span class="line">        extent: ol.extent.applyTransform(extent, projzh.ll2bmerc),</span><br><span class="line">        units: <span class="string">'m'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    ol.proj.addProjection(baiduMercator);</span><br><span class="line">    ol.proj.addCoordinateTransforms(<span class="string">'EPSG:4326'</span>, baiduMercator, projzh.ll2bmerc, projzh.bmerc2ll);</span><br><span class="line">    ol.proj.addCoordinateTransforms(<span class="string">'EPSG:3857'</span>, baiduMercator, projzh.smerc2bmerc, projzh.bmerc2smerc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  	<span class="keyword">var</span> resolutions = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">19</span>; i++)&#123;</span><br><span class="line">        resolutions[i] = <span class="built_in">Math</span>.pow(<span class="number">2</span>, <span class="number">18</span>-i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> tilegrid  = <span class="keyword">new</span> ol.tilegrid.TileGrid(&#123;</span><br><span class="line">        origin: [<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">        resolutions: resolutions,</span><br><span class="line">        extent: ol.extent.applyTransform(extent, projzh.ll2bmerc),</span><br><span class="line">        tileSize: [<span class="number">256</span>, <span class="number">256</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">  	<span class="keyword">var</span> satUrls = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].map(<span class="function"><span class="keyword">function</span>(<span class="params">sub</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'http://shangetu'</span> + sub +</span><br><span class="line">            <span class="string">'.map.bdimg.com/it/u=x=&#123;x&#125;;y=&#123;y&#125;;z=&#123;z&#125;;v=009;type=sate&amp;fm=46&amp;udt=20150601'</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> urls = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].map(<span class="function"><span class="keyword">function</span>(<span class="params">sub</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'http://online'</span> + sub +</span><br><span class="line">            <span class="string">'.map.bdimg.com/onlinelabel/qt=tile&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;&amp;v=009&amp;styles=pl&amp;udt=20170301&amp;scaler=1&amp;p=1'</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    ol.source.TileImage.call(<span class="keyword">this</span>, &#123;</span><br><span class="line">  		crossOrigin: <span class="string">'anonymous'</span>,   <span class="comment">//跨域</span></span><br><span class="line">	    cacheSize: options.cacheSize,</span><br><span class="line">        <span class="comment">// projection: ol.proj.get('EPSG:3857'),</span></span><br><span class="line">  		projection:<span class="string">'baidu'</span>,</span><br><span class="line">  		tileGrid: tilegrid,</span><br><span class="line">  		tileUrlFunction: <span class="function"><span class="keyword">function</span>(<span class="params">tileCoord, pixelRatio, proj</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!tileCoord) <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> z = tileCoord[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">var</span> x = tileCoord[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> y = tileCoord[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">var</span> hash = (x &lt;&lt; z) + y;</span><br><span class="line">            <span class="keyword">var</span> index = hash % urls.length;</span><br><span class="line">            index = index &lt; <span class="number">0</span> ? index + urls.length : index;</span><br><span class="line">            <span class="keyword">if</span>(options.mapType == <span class="string">"sat"</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> satUrls[index].replace(<span class="string">'&#123;x&#125;'</span>, x).replace(<span class="string">'&#123;y&#125;'</span>, y).replace(<span class="string">'&#123;z&#125;'</span>, z);</span><br><span class="line">  			&#125;</span><br><span class="line">            <span class="keyword">return</span> urls[index].replace(<span class="string">'&#123;x&#125;'</span>, x).replace(<span class="string">'&#123;y&#125;'</span>, y).replace(<span class="string">'&#123;z&#125;'</span>, z);</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">    	wrapX: options.wrapX !== <span class="literal">undefined</span> ? options.wrapX : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ol.inherits(ol.source.BaiduMap,ol.source.TileImage);</span><br><span class="line"></span><br><span class="line">ol.source.BaiduMap.ATTRIBUTION = <span class="keyword">new</span> ol.Attribution(&#123;</span><br><span class="line">  	html: <span class="string">'&amp;copy; &lt;a class="ol-attribution-baidumap" '</span> +</span><br><span class="line">      <span class="string">'href="http://map.baidu.com/"&gt;'</span> +</span><br><span class="line">      <span class="string">'百度地图&lt;/a&gt;'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = ol.source.BaiduMap;</span><br></pre></td></tr></table></figure>
<p>调用<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> baiduMapSat = <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">    title: <span class="string">"百度地图卫星"</span>,</span><br><span class="line">    source: <span class="keyword">new</span> ol.source.BaiduMap(&#123;<span class="attr">mapType</span>:<span class="string">"sat"</span>&#125;)</span><br><span class="line">&#125;);</span><br><span class="line">map.addLayer(baiduMapSat);</span><br></pre></td></tr></table></figure></p>
<h2 id="3-扩展高德地图"><a href="#3-扩展高德地图" class="headerlink" title="3. 扩展高德地图"></a>3. 扩展高德地图</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ol = <span class="built_in">require</span>(<span class="string">'openlayers'</span>);</span><br><span class="line"></span><br><span class="line">ol.source.AMap = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> options = options ? options : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  	<span class="keyword">var</span> attributions;</span><br><span class="line">  	<span class="keyword">if</span>(options.attributions !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">  		attributions = option.attributions;</span><br><span class="line">  	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  		attributions = [ol.source.AMap.ATTRIBUTION];</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">  	<span class="keyword">var</span> url;</span><br><span class="line">  	<span class="keyword">if</span>(options.mapType == <span class="string">"sat"</span>)&#123;</span><br><span class="line">  		url =<span class="string">"http://webst0&#123;1-4&#125;.is.autonavi.com/appmaptile?style=6&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;"</span>;</span><br><span class="line">  	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  		url = <span class="string">"http://webrd0&#123;1-4&#125;.is.autonavi.com/appmaptile?lang=zh_cn&amp;size=1&amp;scale=1&amp;style=7&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;"</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">    </span><br><span class="line">    ol.source.XYZ.call(<span class="keyword">this</span>, &#123;</span><br><span class="line">  		crossOrigin: <span class="string">'anonymous'</span>,   <span class="comment">//跨域</span></span><br><span class="line">	    cacheSize: options.cacheSize,</span><br><span class="line">        projection: ol.proj.get(<span class="string">'EPSG:3857'</span>),</span><br><span class="line">        <span class="comment">// urls:urls,</span></span><br><span class="line">        url:url,</span><br><span class="line">    	wrapX: options.wrapX !== <span class="literal">undefined</span> ? options.wrapX : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  	&#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ol.inherits(ol.source.AMap,ol.source.XYZ);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ol.source.AMap.ATTRIBUTION = <span class="keyword">new</span> ol.Attribution(&#123;</span><br><span class="line">  	html: <span class="string">'&amp;copy; &lt;a class="ol-attribution-amap" '</span> +</span><br><span class="line">      <span class="string">'href="http://ditu.amap.com/"&gt;'</span> +</span><br><span class="line">      <span class="string">'高德地图&lt;/a&gt;'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = ol.source.AMap;</span><br></pre></td></tr></table></figure>
<p>调用<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aMapSat = <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">    title: <span class="string">"高德地图卫星"</span>,</span><br><span class="line">    source: <span class="keyword">new</span> ol.source.AMap(&#123;<span class="attr">mapType</span>:<span class="string">"sat"</span>&#125;)</span><br><span class="line">&#125;);</span><br><span class="line">map.addLayer(aMapSat);</span><br></pre></td></tr></table></figure></p>
<p>最后推荐一个<a href="https://github.com/zrysmt/openlayers3-react" target="_blank" rel="noopener">github仓库</a>,Openlayers 3 使用React 组件化+wepack+ES6实践,<br>包括扩展在其中的具体使用方法</p>
<blockquote>
<p><a href="https://github.com/zrysmt/openlayers3-react" target="_blank" rel="noopener">https://github.com/zrysmt/openlayers3-react</a></p>
</blockquote>
<h1 id="参考阅读"><a href="#参考阅读" class="headerlink" title="参考阅读"></a>参考阅读</h1><ul>
<li><a href="https://github.com/openlayers/openlayers" target="_blank" rel="noopener">openlayers github</a></li>
<li><a href="https://github.com/openlayers/openlayers/issues" target="_blank" rel="noopener">openlayers github Issues</a></li>
<li><a href="https://openlayers.org/en/latest/apidoc/" target="_blank" rel="noopener">openlayers 官方地址</a></li>
<li><a href="http://blog.csdn.net/future_todo/article/details/61206783" target="_blank" rel="noopener">Openlayers 3 使用React 组件化+wepack+ES6实践记录笔记</a></li>
<li><a href="http://blog.csdn.net/qingyafan/article/details/49403989" target="_blank" rel="noopener">OpenLayers 3 之 加载百度地图</a></li>
<li><a href="http://blog.csdn.net/qingyafan/article/details/49565245" target="_blank" rel="noopener">OpenLayers 3 之 加载天地图</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2017/03/10/openlayers 3 使用React 组件化+wepack+ES6实践记录/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/03/10/openlayers 3 使用React 组件化+wepack+ES6实践记录/" class="post-title-link" itemprop="https://zrysmt.github.io/index.html">openlayers 3 使用React 组件化+wepack+ES6实践记录</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-10 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-10T00:00:00+08:00">2017-03-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:00:02" itemprop="dateModified" datetime="2018-11-30T11:00:02+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/WebGIS/" itemprop="url" rel="index"><span itemprop="name">WebGIS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本博文不作深入研究内容，只用来记录使用React 组件化+wepack+ES6技术操作Openlayers 3 实践中遇到的问题，本博文作为开篇，所以只是简单的demo案例说明。后面还会有其他的一些博文分享我在项目中遇到的问题和总结的经验。</p>
<p>大约一年前我写过一个系列的Openlayers 3的简单的源码结构的分析，代码以及说明在我的<a href="https://github.com/zrysmt/openlayers-3" target="_blank" rel="noopener">github</a>中有，需要的同学出门右转。</p>
<blockquote>
<p>Openlayers 3的简单的源码结构的分析 <a href="https://github.com/zrysmt/openlayers-3" target="_blank" rel="noopener">https://github.com/zrysmt/openlayers-3</a> </p>
</blockquote>
<p>我在github上看到一些人将openlayers彻底组件化，属性通过props传入进来，例如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;layer.Tile&gt;</span><br><span class="line">    &lt;source.OSM /&gt;</span><br><span class="line">  &lt;/layer.Tile&gt;</span><br></pre></td></tr></table></figure></p>
<p>这样做的好处是高度组件化，看起来很和谐。但是这样无形中增加了学习成本和时间成本，我们要看到ol3的API，然后再考虑到转化为组件化的书写的对应形式，导致了多走一步。<br>本博文的思想很简单，就是外壳用react组件封装，内部的源码实现使用ol3的API完全没有改变，这样就简单清晰而且避免多走一步。具体例子见下面给出的Demo。</p>
<p>我还将我写的一些组件，比如基础地图，工具栏和绘制栏用React写的组件单独从项目中拿出来，提供给使用和学习者一些方便，下面给出<a href="https://github.com/zrysmt/openlayers3-react" target="_blank" rel="noopener">地址</a>,欢迎fork，star，不定期更新，有错误请指出：</p>
<blockquote>
<p><a href="https://github.com/zrysmt/openlayers3-react" target="_blank" rel="noopener">https://github.com/zrysmt/openlayers3-react</a></p>
</blockquote>
<h1 id="1-一些问题总结"><a href="#1-一些问题总结" class="headerlink" title="1.一些问题总结"></a>1.一些问题总结</h1><p><strong>问题1：</strong>npm安装的问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed at the closure-util@1.18.0 postinstall script &apos;node ./bin/closure-util.js update&apos;</span><br></pre></td></tr></table></figure></p>
<p>解决方案：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">首先 npm i closure-util --save</span><br><span class="line">然后再安装 npm i openlayers --save</span><br></pre></td></tr></table></figure></p>
<p><strong>问题2：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WARNING in ./~/openlayers/dist/ol.js`</span><br><span class="line">`Critical dependencies:`</span><br><span class="line">`748:1160-1167  This seems to be a pre-built javascript file.  Though  this is possible, it&apos;s not recommended. Try to require the original source to get better results.`</span><br></pre></td></tr></table></figure>
<p>修改webpack.config.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module: &#123;// ...</span><br><span class="line">    noParse: [&apos;/node_modules/prebuiltlib/dist/build.js&apos;,]// ...&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-基本Demo"><a href="#2-基本Demo" class="headerlink" title="2.基本Demo"></a>2.基本Demo</h1><p><strong>olbasemap.jsx</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ol <span class="keyword">from</span> <span class="string">'openlayers'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openlayers/css/ol.css'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./olbasemap.scss'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Olbasemap</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        <span class="keyword">let</span> map = <span class="keyword">new</span> ol.Map(&#123;</span><br><span class="line">              target: <span class="string">'map'</span>,</span><br><span class="line">              layers: [</span><br><span class="line">                <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">                   source: <span class="keyword">new</span> ol.source.OSM()</span><br><span class="line">                &#125;)</span><br><span class="line">              ],</span><br><span class="line">              view: <span class="keyword">new</span> ol.View(&#123;</span><br><span class="line">                center: ol.proj.fromLonLat([<span class="number">37.41</span>, <span class="number">8.82</span>]),</span><br><span class="line">                zoom: <span class="number">4</span>,</span><br><span class="line">              &#125;)</span><br><span class="line">          &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">return</span>(</span><br><span class="line">            &lt;div id=<span class="string">"map"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Olbasemap;</span><br></pre></td></tr></table></figure>
<p><strong>olbasemap.scss</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#map&#123;</span><br><span class="line">    width:<span class="number">100</span>%;</span><br><span class="line">    height:<span class="number">600</span>px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-调用天地图"><a href="#3-调用天地图" class="headerlink" title="3.调用天地图"></a>3.调用天地图</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基础地图模块</span></span><br><span class="line"><span class="comment"> * @Date 2017-3-8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ol <span class="keyword">from</span> <span class="string">'openlayers'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> util <span class="keyword">from</span> <span class="string">'../../../common/util.jsx'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openlayers/css/ol.css'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./olbasemap.scss'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Olbasemap</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        util.adaptHeight(<span class="string">'map'</span>,<span class="number">105</span>,<span class="number">300</span>);<span class="comment">//高度自适应</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> projection,attribution,coor,view;</span><br><span class="line"></span><br><span class="line">        attribution = <span class="keyword">new</span> ol.Attribution(&#123;</span><br><span class="line">            html: <span class="string">'© &lt;a href="http://www.chinaonmap.com/map/index.html"&gt;天地图&lt;/a&gt;'</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> map = <span class="keyword">new</span> ol.Map(&#123;</span><br><span class="line">            target: <span class="string">'map'</span>,</span><br><span class="line">            layers: [</span><br><span class="line">                <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">                    source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span><br><span class="line">                        attributions: [attribution],</span><br><span class="line">                        url: <span class="string">"http://t2.tianditu.com/DataServer?T=vec_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;),</span><br><span class="line">                <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">                    source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span><br><span class="line">                        url: <span class="string">"http://t2.tianditu.com/DataServer?T=cva_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">            ],</span><br><span class="line">            view: <span class="keyword">new</span> ol.View(&#123;</span><br><span class="line">              <span class="comment">// projection: 'EPSG:4326',//WGS84</span></span><br><span class="line">              center: ol.proj.fromLonLat([<span class="number">104</span>, <span class="number">30</span>]),</span><br><span class="line">              zoom: <span class="number">5</span>,</span><br><span class="line">            &#125;),</span><br><span class="line">            controls: ol.control.defaults().extend([</span><br><span class="line">                <span class="keyword">new</span> ol.control.FullScreen(), <span class="comment">//全屏控件</span></span><br><span class="line">                <span class="keyword">new</span> ol.control.ScaleLine(), <span class="comment">//比例尺</span></span><br><span class="line">                <span class="keyword">new</span> ol.control.OverviewMap(), <span class="comment">//鹰眼控件</span></span><br><span class="line">                <span class="keyword">new</span> ol.control.Rotate(),</span><br><span class="line">                <span class="keyword">new</span> ol.control.MousePosition(),</span><br><span class="line">                <span class="keyword">new</span> ol.control.ZoomSlider(),</span><br><span class="line">             ]),</span><br><span class="line">          &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">return</span>(</span><br><span class="line">            &lt;div id=<span class="string">"map"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Olbasemap;</span><br></pre></td></tr></table></figure>
<p>此时有个问题，假设我们要把<code>map</code>变量传出去，供其他的组件使用，子类和父类之间的传值可以通过props和回调函数完成；现在我们做的组件其实是兄弟关系，怎么将<code>map</code>做成通用呢，经过考虑我们决定使用<strong>发布-订阅模式</strong>，涉及到各个组件的变量的都在组件内部定义，然后通过<strong>发布-订阅模式</strong>将一些事件集中管理起来。此外我们还组织将变量放到构造函数中。</p>
<p>于是我们可以这样修改<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基础地图模块</span></span><br><span class="line"><span class="comment"> * @Date 2017-3-8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ol <span class="keyword">from</span> <span class="string">'openlayers'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> util <span class="keyword">from</span> <span class="string">'../../../common/util.jsx'</span>;</span><br><span class="line"><span class="keyword">import</span> Eventful <span class="keyword">from</span> <span class="string">'../../../common/Eventful.js'</span>;</span><br><span class="line"><span class="keyword">import</span> olConfig <span class="keyword">from</span> <span class="string">'./ol-config'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openlayers/css/ol.css'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./olbasemap.scss'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Olbasemap</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">        <span class="keyword">let</span> map,view,projection,attribution,coor,mousePositionControl;</span><br><span class="line"></span><br><span class="line">        attribution = <span class="keyword">new</span> ol.Attribution(&#123;</span><br><span class="line">            html: <span class="string">'© &lt;a href="http://www.chinaonmap.com/map/index.html"&gt;天地图&lt;/a&gt;'</span></span><br><span class="line">        &#125;);</span><br><span class="line">        mousePositionControl = <span class="keyword">new</span> ol.control.MousePosition(&#123;</span><br><span class="line">            coordinateFormat: ol.coordinate.createStringXY(<span class="number">0</span>),</span><br><span class="line">            projection: <span class="string">'EPSG:3857'</span>,<span class="comment">//可以是4326 精度应该保留几个小数点</span></span><br><span class="line">            <span class="comment">// className: 'custom-mouse-position',</span></span><br><span class="line">            <span class="comment">// target: document.getElementById('mouse-position'),</span></span><br><span class="line">            undefinedHTML: <span class="string">'&amp;nbsp;'</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.view = view = <span class="keyword">new</span> ol.View(&#123;</span><br><span class="line">            <span class="comment">// projection: 'EPSG:4326',//WGS84</span></span><br><span class="line">            center: ol.proj.fromLonLat(olConfig.initialView.center||[<span class="number">104</span>, <span class="number">30</span>]),</span><br><span class="line">            zoom: olConfig.initialView.zoom || <span class="number">5</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.map = map = <span class="keyword">new</span> ol.Map(&#123;</span><br><span class="line">            target: <span class="string">'map'</span>,</span><br><span class="line">            layers: [</span><br><span class="line">                <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">                    source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span><br><span class="line">                        attributions: [attribution],</span><br><span class="line">                        url: <span class="string">"http://t2.tianditu.com/DataServer?T=vec_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;),</span><br><span class="line">                <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">                    source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span><br><span class="line">                        url: <span class="string">"http://t2.tianditu.com/DataServer?T=cva_w&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;l=&#123;z&#125;"</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">            ],</span><br><span class="line">            view: view,</span><br><span class="line">            controls: ol.control.defaults().extend([</span><br><span class="line">                <span class="keyword">new</span> ol.control.FullScreen(), <span class="comment">//全屏控件</span></span><br><span class="line">                <span class="keyword">new</span> ol.control.ScaleLine(), <span class="comment">//比例尺</span></span><br><span class="line">                <span class="keyword">new</span> ol.control.OverviewMap(), <span class="comment">//鹰眼控件</span></span><br><span class="line">                <span class="keyword">new</span> ol.control.Rotate(),</span><br><span class="line">                <span class="keyword">new</span> ol.control.ZoomSlider(),</span><br><span class="line">                mousePositionControl</span><br><span class="line">             ]),</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Eventful.subscribe(<span class="string">'zoomtoall'</span>,()=&gt;<span class="keyword">this</span>.handleClickOfZoomtoall());<span class="comment">//订阅</span></span><br><span class="line">    &#125;</span><br><span class="line">    handleClickOfZoomtoall()&#123;</span><br><span class="line">        <span class="keyword">this</span>.view.animate(&#123;<span class="attr">zoom</span>:olConfig.initialView.zoom || <span class="number">5</span>,</span><br><span class="line">            center:ol.proj.fromLonLat(olConfig.initialView.center||[<span class="number">104</span>, <span class="number">30</span>])&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        util.adaptHeight(<span class="string">'map'</span>,<span class="number">105</span>,<span class="number">300</span>);<span class="comment">//高度自适应</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(__DEV__) <span class="built_in">console</span>.info(<span class="string">"componentDidMount"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.map.setTarget(<span class="keyword">this</span>.refs.map);</span><br><span class="line">    &#125;</span><br><span class="line">    componentWillUnmount () &#123;</span><br><span class="line">        <span class="keyword">this</span>.map.setTarget(<span class="literal">undefined</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">return</span>(</span><br><span class="line">            &lt;div id=<span class="string">"map"</span> ref=<span class="string">"map"</span> &gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Olbasemap;</span></span><br></pre></td></tr></table></figure></p>
<p>在兄弟模块中该调用的模块中调用下面的关键代码即可<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Eventful.dispatch(<span class="string">'zoomtoall'</span>）；</span><br></pre></td></tr></table></figure></p>
<p>最后列下来<strong>发布-订阅模式</strong>的代码<code>Eventful.js</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察者(发布-订阅)模式</span></span><br><span class="line"><span class="comment"> * @Date 2017-3-14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> Eventful = &#123;</span><br><span class="line">    _events: &#123;&#125;,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [dispatch 发布]</span></span><br><span class="line"><span class="comment">     * @param  &#123;[String]&#125;    evtName [关键字名]</span></span><br><span class="line"><span class="comment">     * @param  &#123;...[Any]&#125; args    [传递的参数]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    dispatch(evtName, ...args) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>._events[evtName]) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>._events[evtName].forEach(</span><br><span class="line">            func =&gt; func.apply(<span class="built_in">Object</span>.create(<span class="literal">null</span>), args));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [subscribe 订阅]</span></span><br><span class="line"><span class="comment">     * @param  &#123;[String]&#125;    evtName [关键字名]</span></span><br><span class="line"><span class="comment">     * @param  &#123;Function&#125; callback [回掉函数]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    subscribe(evtName, callback) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>._events[evtName]) &#123;</span><br><span class="line">            <span class="keyword">this</span>._events[evtName] = [];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>._events[evtName].push(callback);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [unSubscribe 取消订阅]</span></span><br><span class="line"><span class="comment">     * @param  &#123;[String]&#125;    evtName [关键字名]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    unSubscribe(evtName) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>._events[evtName]) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>._events[evtName];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Eventful;</span><br></pre></td></tr></table></figure></p>
<p><strong>参考阅读</strong></p>
<ul>
<li><a href="http://blog.csdn.net/qingyafan/article/details/49565245" target="_blank" rel="noopener">OpenLayers 3 之 加载天地图</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ruyi Zhao</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">70</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">52</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ruyi Zhao</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
