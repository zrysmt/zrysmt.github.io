<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="漫漫技术路">
<meta property="og:url" content="https://zrysmt.github.io/page/4/index.html">
<meta property="og:site_name" content="漫漫技术路">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="漫漫技术路">






  <link rel="canonical" href="https://zrysmt.github.io/page/4/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>漫漫技术路</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">漫漫技术路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/26/动手DIY一个underscorejs库及underscorejs源码分析3/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/26/动手DIY一个underscorejs库及underscorejs源码分析3/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">动手DIY一个underscorejs库及underscorejs源码分析3</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-26T00:00:00+08:00">2016-10-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:10:15" itemprop="dateModified" datetime="2018-11-30T11:10:15+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>所有代码挂在我的<a href="https://github.com/zrysmt/DIY-underscorejs" target="_blank" rel="noopener">github</a>上,例子是demo6.html，DIY/4/_underscore.js.欢迎fork，star。<br><a href="https://github.com/zrysmt/DIY-underscorejs" target="_blank" rel="noopener">https://github.com/zrysmt/DIY-underscorejs</a></p>
</blockquote>
<p>这一部分来DIY两个经常被使用的函数（或者说分析其源码），分别是throttle(节流函数)和debounce(防反跳函数)。</p>
<p>这两个函数特别适合一些场景：事件频繁被触发，会导致频繁执行DOM的操作，如下：</p>
<ul>
<li>window对象的resize、scroll事件</li>
<li>拖拽时候的mousemove事件</li>
<li>mousedown、keydown事件</li>
<li>文字输入、自动完成的keyup事件</li>
</ul>
<h1 id="1-throttle节流函数"><a href="#1-throttle节流函数" class="headerlink" title="1.throttle节流函数"></a>1.throttle节流函数</h1><p>创建并返回一个像节流阀一样的函数，当重复调用函数的时候，最多每隔 <strong>wait</strong>毫秒调用一次该函数。对于想控制一些触发频率较高的事件有帮助。</p>
<p>默认情况下，<strong>throttle</strong>将在你调用的第一时间尽快执行这个<strong>function</strong>，并且，如果你在<strong>wait</strong>周期内调用任意次数的函数，都将尽快的被覆盖。如果你想禁用第一次首先执行的话，传递{leading: false}，还有如果你想禁用最后一次执行的话，传递{trailing: false}。</p>
<p>也许你还没完全看懂，我们来做个demo测试下。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span></span><br><span class="line">    创建并返回一个像节流阀一样的函数，当重复调用函数的时候，最多每隔 wait毫秒调用一次该函数。对于想控制一些触发频率较高的事件有帮助。（注：详见：javascript函数的throttle和debounce） 默认情况下，throttle将在你调用的第一时间尽快执行这个function，并且，如果你在wait周期内调用任意次数的函数，都将尽快的被覆盖。如果你想禁用第一次首先执行的话，传递&#123;leading: false&#125;，还有如果你想禁用最后一次执行的话，传递&#123;trailing: false&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">updatePosition</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log($(<span class="string">'#div1'</span>).height(), $(<span class="string">'#div1'</span>).width());</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript"><span class="comment">//不带options即第三个参数的时候(默认情况下)，会执行两次，一次是执行时候的状态(A) ，一次是执行后的状态(B)</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// &#123;leading: false &#125;不会执行第一次执行时的状态(A)</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// &#123;trailing: false&#125;不会执行最后一次执行后的状态(B)</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> throttled = _.throttle(updatePosition, <span class="number">1000</span></span></span><br><span class="line"><span class="undefined">    /*,&#123;</span></span><br><span class="line"><span class="javascript">        leading: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        trailing: <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">    &#125;*/</span></span><br><span class="line"><span class="undefined">);</span></span><br><span class="line"><span class="javascript">$(<span class="built_in">window</span>).resize(throttled);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>我们先看结果，后看下部分的源码实现。</p>
<ul>
<li>1.只拉动一次窗口，会响应两次<code>updatePosition</code>，分别对应状态A、B，示例Demo中有详细说明解释第三个参数。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/underscorejs/throttle1.gif" alt=""></p>
<ul>
<li>2.多次拉动窗口，第一次会立即响应，拖动比较快的时候，只会隔大概1000ms（自己设置的时间，默认100ms）响应一次。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/underscorejs/throttle2.gif" alt=""><br>源码实现：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">_.throttle = <span class="function"><span class="keyword">function</span>(<span class="params">func, wait, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> timeout, context, args, result;</span><br><span class="line">    <span class="keyword">var</span> previous = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!options) options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> later = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        previous = options.leading === <span class="literal">false</span> ? <span class="number">0</span> : _.now();</span><br><span class="line">        timeout = <span class="literal">null</span>;</span><br><span class="line">        result = func.apply(context, args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!timeout) context = args = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> throttled = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> now = _.now();<span class="comment">//加入_.now()，这里不在单说，相见开头处提供的github地址。</span></span><br><span class="line">        <span class="keyword">if</span> (!previous &amp;&amp; options.leading === <span class="literal">false</span>) previous = now; <span class="comment">//禁止第一次执行(A) remaining = wait - 0 = wait &gt; 0 的话不会执行A</span></span><br><span class="line">        <span class="comment">//不禁止第一次执行A的时候,previous = 0,现在时间now &gt;= wait,就是过了wait等待时间 </span></span><br><span class="line">        <span class="keyword">var</span> remaining = wait - (now - previous); <span class="comment">//remaining 第一次为&lt; 0</span></span><br><span class="line">        <span class="built_in">console</span>.warn(wait, now, remaining);</span><br><span class="line">        context = <span class="keyword">this</span>;</span><br><span class="line">        args = <span class="built_in">arguments</span>;</span><br><span class="line">        <span class="comment">//按理来说remaining &lt;= 0已经足够证明已经到达wait的时间间隔，但这里还考虑到假如客户端修改了系统时间则马上执行func函数（remaining &gt; wait）</span></span><br><span class="line">        <span class="keyword">if</span> (remaining &lt;= <span class="number">0</span> || remaining &gt; wait) &#123;</span><br><span class="line">            <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                clearTimeout(timeout);</span><br><span class="line">                timeout = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            previous = now;</span><br><span class="line">            result = func.apply(context, args); <span class="comment">//第一次执行A</span></span><br><span class="line">            <span class="keyword">if</span> (!timeout) context = args = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!timeout &amp;&amp; options.trailing !== <span class="literal">false</span>) &#123; <span class="comment">//不会禁用第二次执行(B)</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"============第二次==============="</span>);</span><br><span class="line">            timeout = setTimeout(later, remaining); <span class="comment">//第二次执行(B)</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    throttled.cancel = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        clearTimeout(timeout);</span><br><span class="line">        previous = <span class="number">0</span>;</span><br><span class="line">        timeout = context = args = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> throttled;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-debounce-防反跳函数"><a href="#2-debounce-防反跳函数" class="headerlink" title="2.debounce 防反跳函数"></a>2.debounce 防反跳函数</h1><p>返回 <strong>function</strong> 函数的防反跳版本, 将延迟函数的执行(真正的执行)在函数最后一次调用时刻的 <strong>wait</strong> 毫秒之后. 对于必须在一些输入（多是一些用户操作）停止到达_之后_执行的行为有帮助。 例如: 渲染一个Markdown格式的评论预览, 当窗口停止改变大小之后重新计算布局, 等等.</p>
<p>传参 <strong>immediate</strong> 为 true， <strong>debounce</strong>会在 <strong>wait</strong> 时间间隔的开始调用这个函数 。<br>示例Demo<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> debounce = _.debounce(updatePosition, <span class="number">1000</span>);</span><br><span class="line">$(<span class="built_in">window</span>).resize(debounce);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>只会在停止操作后1000ms(自己设置的)执行</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/underscorejs/debounce1.gif" alt=""></p>
<ul>
<li>加入第三个参数，会在操作的同时执行</li>
</ul>
<p><code>var debounce = _.debounce(updatePosition, 1000,true);</code><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/underscorejs/debounce2.gif" alt=""><br>首先一个使用的工具函数,不在这里详细说明了。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> _.delay = restArgs(<span class="function"><span class="keyword">function</span>(<span class="params">func, wait, args</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> func.apply(<span class="literal">null</span>, args);</span><br><span class="line">      &#125;, wait);</span><br><span class="line"><span class="keyword">var</span> restArgs = <span class="function"><span class="keyword">function</span>(<span class="params">func, startIndex</span>) </span>&#123;</span><br><span class="line">&#125;;</span><br><span class="line">_.restArgs = restArgs;</span><br></pre></td></tr></table></figure></p>
<p>源码实现：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//immediate默认为false</span></span><br><span class="line"><span class="comment">//只在最后一次关闭的时候，延迟后执行一次</span></span><br><span class="line">_.debounce = <span class="function"><span class="keyword">function</span>(<span class="params">func, wait, immediate</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> timeout, result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> later = <span class="function"><span class="keyword">function</span>(<span class="params">context, args</span>) </span>&#123;</span><br><span class="line">        timeout = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (args) result = func.apply(context, args);</span><br><span class="line">    &#125;;</span><br><span class="line">    restArgs = _.restArgs; <span class="comment">//增加</span></span><br><span class="line">    <span class="keyword">var</span> debounced = restArgs(<span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout) clearTimeout(timeout);</span><br><span class="line">        <span class="comment">//控制timeout，一直拖动的时候会清除timeout，这样中间就不会执行了</span></span><br><span class="line">        <span class="keyword">if</span> (immediate) &#123;<span class="comment">//immediate为true立刻执行</span></span><br><span class="line">            <span class="keyword">var</span> callNow = !timeout;</span><br><span class="line">            timeout = setTimeout(later, wait);</span><br><span class="line">            <span class="keyword">if</span> (callNow) result = func.apply(<span class="keyword">this</span>, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            timeout = _.delay(later, wait, <span class="keyword">this</span>, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    debounced.cancel = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        clearTimeout(timeout);</span><br><span class="line">        timeout = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> debounced;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>好了就简单介绍到这里</p>
<blockquote>
<p>所有代码挂在我的<a href="https://github.com/zrysmt/DIY-underscorejs" target="_blank" rel="noopener">github</a>上,例子是demo6.html，DIY/4/_underscore.js.欢迎fork，star。<br><a href="https://github.com/zrysmt/DIY-underscorejs" target="_blank" rel="noopener">https://github.com/zrysmt/DIY-underscorejs</a></p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/26/动手DIY一个underscorejs库及underscorejs源码分析2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/26/动手DIY一个underscorejs库及underscorejs源码分析2/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">动手DIY一个underscorejs库及underscorejs源码分析2</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-26T00:00:00+08:00">2016-10-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:10:15" itemprop="dateModified" datetime="2018-11-30T11:10:15+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>接着第一篇《动手DIY一个underscorejs库及underscorejs源码分析1》</p>
<blockquote>
<p>所有代码挂在我的<a href="https://github.com/zrysmt/DIY-underscorejs" target="_blank" rel="noopener">github</a>上。</p>
</blockquote>
<h1 id="1-兼容requirejs和seajs模块化"><a href="#1-兼容requirejs和seajs模块化" class="headerlink" title="1.兼容requirejs和seajs模块化"></a>1.兼容requirejs和seajs模块化</h1><ul>
<li>requirejs<br>在代码的尾部加上</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> define == <span class="string">'function'</span> &amp;&amp; define.amd) &#123;</span><br><span class="line">    <span class="comment">//定义一个模块并且起个名字</span></span><br><span class="line">    define(<span class="string">'_underscore'</span>, [], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用测试：<a href="https://github.com/zrysmt/DIY-underscorejs/tree/master/demo" target="_blank" rel="noopener">代码请点我</a><br>demo3.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">data-main</span>=<span class="string">"demo3"</span> <span class="attr">src</span>=<span class="string">"lib/require.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>demo3.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params">require</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>([<span class="string">'../DIY/2/_underscore'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(_);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>加上支持seajs的代码</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> define == <span class="string">'function'</span> &amp;&amp; define.amd) &#123;</span><br><span class="line">    define(<span class="string">'_underscore'</span>, [], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> define == <span class="string">'function'</span> &amp;&amp; define.cmd) &#123; <span class="comment">//seajs</span></span><br><span class="line">    define(<span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">module</span>.exports = _;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：<br>demo2.html</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"lib/sea-debug.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    seajs.use(<span class="string">'./demo2'</span>);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>demo2.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'../DIY/2/_underscore'</span>);</span><br><span class="line">    <span class="built_in">console</span>.info(_);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="2-支持nodejs"><a href="#2-支持nodejs" class="headerlink" title="2.支持nodejs"></a>2.支持nodejs</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root._ = _;</span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> exports != <span class="string">'undefined'</span> &amp;&amp; !exports.nodeType) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> != <span class="string">'undefined'</span> &amp;&amp; !<span class="built_in">module</span>.nodeType &amp;&amp; <span class="built_in">module</span>.exports) &#123;</span><br><span class="line">    exports = <span class="built_in">module</span>.exports = _;</span><br><span class="line">  &#125;</span><br><span class="line">  exports._ = _;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  root._ = _;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-extend"><a href="#3-extend" class="headerlink" title="3._.extend"></a>3.<code>_.extend</code></h1><p>使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_.extend(&#123;<span class="attr">name</span>: <span class="string">'moe'</span>&#125;, &#123;<span class="attr">age</span>: <span class="number">50</span>&#125;));</span><br><span class="line"><span class="comment">//结果Object &#123;name: "moe", age: 50&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类似与_.keys</span></span><br><span class="line">_.allKeys = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_.isObject(obj)) <span class="keyword">return</span> [];</span><br><span class="line">    <span class="keyword">var</span> keys = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) keys.push(key);</span><br><span class="line">    <span class="comment">// Ahem, IE &lt; 9.</span></span><br><span class="line">    <span class="comment">// if (hasEnumBug) collectNonEnumProps(obj, keys);</span></span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>主函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> createAssigner = <span class="function"><span class="keyword">function</span>(<span class="params">keysFunc, defaults</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> length = <span class="built_in">arguments</span>.length;</span><br><span class="line">        <span class="keyword">if</span> (defaults) obj = <span class="built_in">Object</span>(obj);</span><br><span class="line">        <span class="keyword">if</span> (length &lt; <span class="number">2</span> || obj == <span class="literal">null</span>) <span class="keyword">return</span> obj;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">1</span>; index &lt; length; index++) &#123;</span><br><span class="line">            <span class="keyword">var</span> source = <span class="built_in">arguments</span>[index],</span><br><span class="line">                keys = keysFunc(source),</span><br><span class="line">                l = keys.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> key = keys[i];</span><br><span class="line">                <span class="keyword">if</span> (!defaults || obj[key] === <span class="keyword">void</span> <span class="number">0</span>) obj[key] = source[key];</span><br><span class="line">        <span class="comment">//将参数（对象）放入到obj组合到一起</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">_.extend = createAssigner(_.allKeys);</span><br><span class="line">_.extendOwn = _.assign = createAssigner(_.keys);</span><br></pre></td></tr></table></figure>
<h1 id="4-重要内部函数cb"><a href="#4-重要内部函数cb" class="headerlink" title="4.重要内部函数cb"></a>4.重要内部函数<code>cb</code></h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builtinIteratee;</span><br><span class="line"><span class="comment">//如果是函数则返回上面说到的回调函数；</span></span><br><span class="line"><span class="comment">//如果是对象则返回一个能判断对象是否相等的函数；</span></span><br><span class="line"><span class="comment">//默认返回一个获取对象属性的函数</span></span><br><span class="line"><span class="keyword">var</span> cb = <span class="function"><span class="keyword">function</span>(<span class="params">value, context, argCount</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_.iteratee !== builtinIteratee) <span class="keyword">return</span> _.iteratee(value, context);</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) <span class="keyword">return</span> _.identity; <span class="comment">//默认的迭代器</span></span><br><span class="line">    <span class="keyword">if</span> (_.isFunction(value)) <span class="keyword">return</span> optimizeCb(value, context, argCount);</span><br><span class="line">    <span class="keyword">if</span> (_.isObject(value)) <span class="keyword">return</span> _.matcher(value);</span><br><span class="line">    <span class="keyword">return</span> _.property(value);</span><br><span class="line">&#125;;</span><br><span class="line">_.iteratee = builtinIteratee = <span class="function"><span class="keyword">function</span>(<span class="params">value, context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cb(value, context, <span class="literal">Infinity</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="4-1-identity"><a href="#4-1-identity" class="headerlink" title="4.1 _.identity"></a>4.1 <code>_.identity</code></h2><p>很简单但是是默认的迭代器<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_.identity = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>测试很简单<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = &#123;<span class="attr">name</span>:<span class="string">'zry'</span>&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(obj1 === _.identity(obj1));<span class="comment">//true</span></span><br></pre></td></tr></table></figure></p>
<h2 id="4-2-matcher"><a href="#4-2-matcher" class="headerlink" title="4.2 _.matcher"></a>4.2 <code>_.matcher</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">_.matcher = _.matches = <span class="function"><span class="keyword">function</span>(<span class="params">attrs</span>) </span>&#123;</span><br><span class="line">    attrs = _.extendOwn(&#123;&#125;, attrs);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _.isMatch(obj, attrs);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//两个对象是不是全等于。给定的对象是否匹配attrs指定键/值属性</span></span><br><span class="line">_.isMatch = <span class="function"><span class="keyword">function</span>(<span class="params">object, attrs</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> keys = _.keys(attrs),</span><br><span class="line">        length = keys.length;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">null</span>) <span class="keyword">return</span> !length;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="built_in">Object</span>(object);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> key = keys[i];</span><br><span class="line">        <span class="keyword">if</span> (attrs[key] !== obj[key] || !(key <span class="keyword">in</span> obj)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj2 = &#123;<span class="attr">selected</span>: <span class="literal">true</span>, <span class="attr">visible</span>: <span class="literal">true</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> ready = _.isMatch(obj2,&#123;<span class="attr">selected</span>: <span class="literal">true</span>, <span class="attr">visible</span>: <span class="literal">true</span>&#125;);</span><br><span class="line"><span class="comment">//返回一个断言函数，这个函数会给你一个断言 可以用来辨别 </span></span><br><span class="line"><span class="comment">//给定的对象是否匹配attrs指定键/值属性</span></span><br><span class="line"><span class="built_in">console</span>.log(ready);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>
<h2 id="4-3-property"><a href="#4-3-property" class="headerlink" title="4.3 _.property"></a>4.3 <code>_.property</code></h2><p>property函数在第一篇博客中已经实现<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.property = property;</span><br></pre></td></tr></table></figure></p>
<h1 id="5-map"><a href="#5-map" class="headerlink" title="5._.map"></a>5.<code>_.map</code></h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_.map = _.collect = <span class="function"><span class="keyword">function</span>(<span class="params">obj, iteratee, context</span>) </span>&#123;</span><br><span class="line">    iteratee = cb(iteratee, context);</span><br><span class="line">    <span class="keyword">var</span> keys = !isArrayLike(obj) &amp;&amp; _.keys(obj),</span><br><span class="line">        length = (keys || obj).length,</span><br><span class="line">        results = <span class="built_in">Array</span>(length);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; length; index++) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentKey = keys ? keys[index] : index;</span><br><span class="line">        results[index] = iteratee(obj[currentKey], currentKey, obj);</span><br><span class="line">        <span class="comment">//返回的是（value，key，obj）</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="6-filter"><a href="#6-filter" class="headerlink" title="6._.filter"></a>6.<code>_.filter</code></h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_.filter = _.select = <span class="function"><span class="keyword">function</span>(<span class="params">obj, predicate, context</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> results = [];</span><br><span class="line">    predicate = cb(predicate, context);</span><br><span class="line">    _.each(obj, <span class="function"><span class="keyword">function</span>(<span class="params">value, index, list</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (predicate(value, index, list)) results.push(value);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>测试：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> evens = _.filter([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], <span class="function"><span class="keyword">function</span>(<span class="params">num</span>)</span>&#123; <span class="keyword">return</span> num % <span class="number">2</span> == <span class="number">0</span>; &#125;);<span class="comment">//[2,4,6]</span></span><br></pre></td></tr></table></figure></p>
<h1 id="7-两个常用的工具函数-escape-unescape"><a href="#7-两个常用的工具函数-escape-unescape" class="headerlink" title="7.两个常用的工具函数_.escape,_.unescape`"></a>7.两个常用的工具函数<code>_.escape</code>,_.unescape`</h1><h2 id="7-1-escape"><a href="#7-1-escape" class="headerlink" title="7.1 _.escape"></a>7.1 <code>_.escape</code></h2><p>要过滤的字符串<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> escapeMap = &#123;</span><br><span class="line">    <span class="string">'&amp;'</span>: <span class="string">'&amp;amp;'</span>,</span><br><span class="line">    <span class="string">'&lt;'</span>: <span class="string">'&amp;lt;'</span>,</span><br><span class="line">    <span class="string">'&gt;'</span>: <span class="string">'&amp;gt;'</span>,</span><br><span class="line">    <span class="string">'"'</span>: <span class="string">'&amp;quot;'</span>,</span><br><span class="line">    <span class="string">"'"</span>: <span class="string">'&amp;#x27;'</span>,</span><br><span class="line">    <span class="string">'`'</span>: <span class="string">'&amp;#x60;'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>主函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> createEscaper = <span class="function"><span class="keyword">function</span>(<span class="params">map</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> escaper = <span class="function"><span class="keyword">function</span>(<span class="params">match</span>) </span>&#123;<span class="comment">//match 匹配的子串</span></span><br><span class="line">        <span class="keyword">return</span> map[match];</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> source = <span class="string">'(?:'</span> + _.keys(map).join(<span class="string">'|'</span>) + <span class="string">')'</span>;</span><br><span class="line">    <span class="keyword">var</span> testRegexp = <span class="built_in">RegExp</span>(source);</span><br><span class="line">    <span class="keyword">var</span> replaceRegexp = <span class="built_in">RegExp</span>(source, <span class="string">'g'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">        string = string == <span class="literal">null</span> ? <span class="string">''</span> : <span class="string">''</span> + string;</span><br><span class="line">        <span class="keyword">return</span> testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>注意值了的<code>string.replace</code>函数第二个参数是个函数，那么返回的数据第一个是match（匹配的子串）</p>
<table>
<thead>
<tr>
<th>变量名</th>
<th style="text-align:center">代表的值</th>
</tr>
</thead>
<tbody>
<tr>
<td>match</td>
<td style="text-align:center">匹配的子串。（对应于上述的$&amp;。）</td>
</tr>
<tr>
<td>p1,p2, …</td>
<td style="text-align:center">假如replace()方法的第一个参数是一个<code>RegExp</code>对象，则代表第n个括号匹配的字符串。（对应于上述的$1，$2等。）</td>
</tr>
<tr>
<td>offset</td>
<td style="text-align:center">匹配到的子字符串在原字符串中的偏移量。（比如，如果原字符串是“abcd”，匹配到的子字符串时“bc”，那么这个参数将是1）</td>
</tr>
<tr>
<td>string</td>
<td style="text-align:center">被匹配的原字符串。</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.escape = createEscaper(escapeMap);</span><br></pre></td></tr></table></figure>
<p>测试：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_.escape(<span class="string">'Curly, Larry &amp; Moe'</span>)<span class="comment">//Curly, Larry &amp;amp; Moe</span></span><br></pre></td></tr></table></figure></p>
<h2 id="7-2-unescape"><a href="#7-2-unescape" class="headerlink" title="7.2 _.unescape"></a>7.2 <code>_.unescape</code></h2><p>反转要过滤的字符串<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_.invert = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> keys = _.keys(obj);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = keys.length; i &lt; length; i++) &#123;</span><br><span class="line">        result[obj[keys[i]]] = keys[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> unescapeMap = _.invert(escapeMap);</span><br><span class="line">_.unescape = createEscaper(unescapeMap);</span><br></pre></td></tr></table></figure></p>
<p>测试：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_.unescape(<span class="string">'Curly, Larry &amp;amp; Moe'</span>));<span class="comment">//Curly, Larry &amp; Moe</span></span><br></pre></td></tr></table></figure></p>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="http://underscorejs.org/" target="_blank" rel="noopener">http://underscorejs.org/</a></li>
<li><a href="http://www.bootcss.com/p/underscore/" target="_blank" rel="noopener">underscorejs中文：http://www.bootcss.com/p/underscore/</a></li>
<li><a href="http://blog.fens.me/nodejs-underscore/" target="_blank" rel="noopener">UnderscoreJS精巧而强大工具包</a></li>
<li><a href="http://www.imooc.com/article/1566" target="_blank" rel="noopener">JS高手进阶之路：underscore源码经典</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/26/动手DIY一个underscorejs库及underscorejs源码分析1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/26/动手DIY一个underscorejs库及underscorejs源码分析1/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">动手DIY一个underscorejs库及underscorejs源码分析1</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-26T00:00:00+08:00">2016-10-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:10:15" itemprop="dateModified" datetime="2018-11-30T11:10:15+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://github.com/jashkenas/underscore/" target="_blank" rel="noopener">Underscore</a> 是一个 JavaScript 工具库,它提供一整套函数编程的实用功能。他弥补了 <a href="http://jquery.com/" target="_blank" rel="noopener">jQuery</a> 没有实现的功能，同时又是<a href="http://backbonejs.org/" target="_blank" rel="noopener">Backbone</a> 必不可少的部分。</p>
<p><code>underscore.js</code>源码加上注释也就1千多行，用<code>underscore.js</code>作为阅读源码的开始是一个不错的开始，当然阅读源码的同时，手也不能停下来。下面我会写几篇博客，一边分析源码，一边根据源码重新DIY一份（_underscore.js），基于版本：<code>1.8.3</code>。</p>
<p><code>underscore.js</code>分为集合（Collections）、数组（Arrays）、函数（Functions）、对象（Objects）、工具函数（Utility）五大部分。</p>
<blockquote>
<p>所有代码挂在我的<a href="https://github.com/zrysmt/DIY-underscorejs" target="_blank" rel="noopener">github</a>上。</p>
</blockquote>
<h1 id="1-简单的应用Demo"><a href="#1-简单的应用Demo" class="headerlink" title="1.简单的应用Demo"></a>1.简单的应用Demo</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;underscore.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;!-- &lt;script src=&quot;../DIY/1/_underscore.js&quot;&gt;&lt;/script&gt; --&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">console.info(_);</span><br><span class="line">console.info(_.prototype);</span><br><span class="line">/**</span><br><span class="line"> * 数组处理</span><br><span class="line"> */</span><br><span class="line">_.each([1, 2, 3], function(ele,idx) &#123;</span><br><span class="line">    console.log(idx + &quot; : &quot; +ele);</span><br><span class="line">&#125;);</span><br><span class="line">_.each([1, 2, 3], console.log);</span><br><span class="line">_.each(&#123;one: 1, two: 2, three: 3&#125;, console.log);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>打印结果：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/underscorejs/1-1.png" alt=""><br>展开<code>console.info(_.prototype);</code>打印的结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ Object</span><br><span class="line">  //... ...</span><br><span class="line">  - ()each: </span><br><span class="line">  - ()escape: </span><br><span class="line">  - ()every: </span><br><span class="line">  - ()extend: </span><br><span class="line">  //... ...</span><br><span class="line">__proto__: Object</span><br></pre></td></tr></table></figure></p>
<h1 id="2-从-each-开始"><a href="#2-从-each-开始" class="headerlink" title="2.从_.each()开始"></a>2.从<code>_.each()</code>开始</h1><h2 id="2-1-整体结构：IIFE"><a href="#2-1-整体结构：IIFE" class="headerlink" title="2.1 整体结构：IIFE"></a>2.1 整体结构：IIFE</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> &#125;()）</span><br></pre></td></tr></table></figure>
<h2 id="2-2-初始化"><a href="#2-2-初始化" class="headerlink" title="2.2 初始化_"></a>2.2 初始化<code>_</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在浏览器上是window(self),服务器上是global</span></span><br><span class="line"><span class="keyword">var</span> root = <span class="keyword">typeof</span> self == <span class="string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||</span><br><span class="line">    <span class="keyword">typeof</span> global == <span class="string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||</span><br><span class="line">    <span class="keyword">this</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//形式：_([1, 2, 3]).each(function(ele) &#123;&#125;);会执行下面的</span></span><br><span class="line"><span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">    <span class="keyword">this</span>._wrapped = obj;  <span class="comment">//存放数据</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//形式：_.each([1, 2, 3], function(ele, idx) &#123; &#125;);不会执行上面的函数，而是直接通过全局的_,寻找定义在_或者其原型上的方法</span></span><br><span class="line">root._ = _;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-两个类型isObject-isArrayLike判断"><a href="#2-3-两个类型isObject-isArrayLike判断" class="headerlink" title="2.3 两个类型isObject,isArrayLike判断"></a>2.3 两个类型<code>isObject</code>,<code>isArrayLike</code>判断</h2><p>为了压缩我们把常用的方法/属性独立写成变量<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ArrayProto = <span class="built_in">Array</span>.prototype,</span><br><span class="line">    ObjProto = <span class="built_in">Object</span>.prototype;</span><br><span class="line"><span class="keyword">var</span> push = ArrayProto.push,</span><br><span class="line">    toString = ObjProto.toString,</span><br><span class="line">    hasOwnProperty = ObjProto.hasOwnProperty;</span><br><span class="line"><span class="keyword">var</span> nativeIsArray = <span class="built_in">Array</span>.isArray,</span><br><span class="line">    nativeKeys = <span class="built_in">Object</span>.keys;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是不是对象/函数</span></span><br><span class="line">_.isObject = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type = <span class="keyword">typeof</span> obj;</span><br><span class="line">    <span class="keyword">return</span> type === <span class="string">'function'</span> || type === <span class="string">'object'</span> &amp;&amp; !!obj;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//属性中是否有key</span></span><br><span class="line"><span class="keyword">var</span> property = <span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obj == <span class="literal">null</span> ? <span class="keyword">void</span> <span class="number">0</span> : obj[key];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> MAX_ARRAY_INDEX = <span class="built_in">Math</span>.pow(<span class="number">2</span>, <span class="number">53</span>) - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> getLength = property(<span class="string">'length'</span>);</span><br><span class="line"><span class="keyword">var</span> isArrayLike = <span class="function"><span class="keyword">function</span>(<span class="params">collection</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> length = getLength(collection);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> length == <span class="string">'number'</span> &amp;&amp; length &gt;= <span class="number">0</span> &amp;&amp; length &lt;= MAX_ARRAY_INDEX;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-上下文绑定"><a href="#2-4-上下文绑定" class="headerlink" title="2.4 上下文绑定"></a>2.4 上下文绑定</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> optimizeCb = <span class="function"><span class="keyword">function</span>(<span class="params">func, context, argCount</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//void 0 === undefined 返回ture</span></span><br><span class="line">    <span class="keyword">if</span> (context === <span class="keyword">void</span> <span class="number">0</span>) <span class="keyword">return</span> func;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> func.apply(context, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-each方法"><a href="#2-5-each方法" class="headerlink" title="2.5 each方法"></a>2.5 each方法</h2><p>一个简单的版本属性<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.VERSION = <span class="string">'0.0.1'</span>;</span><br></pre></td></tr></table></figure></p>
<p><code>_.each</code>需要<code>_.keys</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> _.each = _.forEach = <span class="function"><span class="keyword">function</span>(<span class="params">obj, iteratee, context</span>) </span>&#123;</span><br><span class="line">    iteratee = optimizeCb(iteratee, context);</span><br><span class="line">    <span class="keyword">var</span> i, length;</span><br><span class="line">    <span class="keyword">if</span> (isArrayLike(obj)) &#123;<span class="comment">//类数组</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>, length = obj.length; i &lt; length; i++) &#123;</span><br><span class="line">            iteratee(obj[i], i, obj); <span class="comment">//(element, index, list)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> keys = _.keys(obj);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = keys.length; i &lt; length; i++) &#123;</span><br><span class="line">            iteratee(obj[keys[i]], keys[i], obj); <span class="comment">//(value, key, list)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj; <span class="comment">//返回obj方便链式调用</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>_.keys</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_.keys = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//不是对象/函数,返回空数组</span></span><br><span class="line">    <span class="keyword">if</span> (!_.isObject(obj)) <span class="keyword">return</span> [];</span><br><span class="line">    <span class="comment">//使用ES5中的方法，返回属性（数组）</span></span><br><span class="line">    <span class="keyword">if</span> (nativeKeys) <span class="keyword">return</span> nativeKeys(obj);</span><br><span class="line">    <span class="keyword">var</span> keys = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj)</span><br><span class="line">        <span class="keyword">if</span> (_.has(obj, key)) keys.push(key);</span><br><span class="line">        <span class="comment">//兼容IE&lt; 9 暂时省略</span></span><br><span class="line">        <span class="comment">// if (hasEnumBug) collectNonEnumProps(obj, keys);</span></span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>_.has</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_.has = <span class="function"><span class="keyword">function</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> obj != <span class="literal">null</span> &amp;&amp; hasOwnProperty.call(obj, key);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h1 id="3-将方法放入原型中"><a href="#3-将方法放入原型中" class="headerlink" title="3. 将方法放入原型中"></a>3. 将方法放入原型中</h1><p><code>_.prototype</code>的打印结果是：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/underscorejs/1-2.png" alt=""><br><code>console.logo(_.prototype);</code>不在其原型中（其实我们定义_.** 也并没有放到原型中）如果不放到原型中，第<code>5</code>部分不能成功调用。<br>需要使用的工具类<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">_.each([<span class="string">'Arguments'</span>, <span class="string">'Function'</span>, <span class="string">'String'</span>, <span class="string">'Number'</span>, <span class="string">'Date'</span>, <span class="string">'RegExp'</span>, <span class="string">'Error'</span>, <span class="string">'Symbol'</span>, <span class="string">'Map'</span>, <span class="string">'WeakMap'</span>, <span class="string">'Set'</span>, <span class="string">'WeakSet'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    _[<span class="string">'is'</span> + name] = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> toString.call(obj) === <span class="string">'[object '</span> + name + <span class="string">']'</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// IE 11 (#1621), Safari 8 (#1929), and PhantomJS (#2236).</span></span><br><span class="line"><span class="keyword">var</span> nodelist = root.document &amp;&amp; root.document.childNodes;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> /./ != <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Int8Array</span> != <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> nodelist != <span class="string">'function'</span>) &#123;</span><br><span class="line">    _.isFunction = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typeof</span> obj == <span class="string">'function'</span> || <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_.functions = _.methods = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> names = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_.isFunction(obj[key])) names.push(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> names.sort();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>混入，并且执行混入<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> _.mixin = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    _.each(_.functions(obj), <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> func = _[name] = obj[name];</span><br><span class="line">        _.prototype[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> args = [<span class="keyword">this</span>._wrapped]; <span class="comment">//_ 保存的数据obj</span></span><br><span class="line">            push.apply(args, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="comment">//原型方法中的数据和args合并到一个数组中</span></span><br><span class="line">            <span class="keyword">return</span> chainResult(<span class="keyword">this</span>, func.apply(_, args));</span><br><span class="line">            <span class="comment">//见第`4`部分</span></span><br><span class="line">            <span class="comment">//将_.prototype[name]的this指向 _ 【func.apply(_,args)已经</span></span><br><span class="line">            <span class="comment">//将func的this指向了 _ ,并且传了参数】,返回带链式的obj，即是 _ </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> _;</span><br><span class="line">&#125;;</span><br><span class="line">_.mixin(_);</span><br></pre></td></tr></table></figure></p>
<p>将<code>_.*</code>形式的方法放入到原型中<br>对于<code>_(obj).*</code>的方法，已经将数据（[this._wrapped]）传入到函数中（var func = _[name] = obj[name]）。当然包括原型中的方法。</p>
<p><code>_mixin</code>是支持用户自己扩展方法的。如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_.mixin(&#123;</span><br><span class="line">  capitalize: <span class="function"><span class="keyword">function</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> string.charAt(<span class="number">0</span>).toUpperCase() +                   string.substring(<span class="number">1</span>).toLowerCase();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">_(<span class="string">"fabio"</span>).capitalize();</span><br><span class="line">=&gt; <span class="string">"Fabio"</span></span><br></pre></td></tr></table></figure>
<h1 id="4-链式"><a href="#4-链式" class="headerlink" title="4.链式"></a>4.链式</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_.chain = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> instance = _(obj);</span><br><span class="line">    instance._chain = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_.chain(arr)</span><br><span class="line">    .each(<span class="function"><span class="keyword">function</span>(<span class="params">ele</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(ele);</span><br><span class="line">    &#125;)<span class="comment">//可以继续链式</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chainResult = <span class="function"><span class="keyword">function</span>(<span class="params">instance, obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> instance._chain ? _(obj).chain() : obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="5-支持形如-obj-each方式逻辑"><a href="#5-支持形如-obj-each方式逻辑" class="headerlink" title="5. 支持形如_(obj).each方式逻辑"></a>5. 支持形如<code>_(obj).each</code>方式逻辑</h1><p>使用形式如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> _([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]).each(<span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(n * <span class="number">2</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们看到第<code>2.2</code>部分初始化的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">    <span class="keyword">this</span>._wrapped = obj;  <span class="comment">//存放数据</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>执行的逻辑会是</p>
<ul>
<li>1.<code>if (!(this instanceof _)) return new _(obj);</code>再次调用构造函数，这个时候的this从window已经指向了<code>_</code>;</li>
<li>2.<code>this._wrapped = obj;  //存放数据</code></li>
</ul>
<p>初始化函数中<code>console.log(this)</code>的结果是：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/underscorejs/1-3.png" alt=""></p>
<h2 id="6-避免冲突"><a href="#6-避免冲突" class="headerlink" title="6.避免冲突"></a>6.避免冲突</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> previousUnderscore = root._;</span><br><span class="line">_.noConflict = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    root._ = previousUnderscore;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> $$ = _.noConflict();<span class="comment">//previousUnderscore</span></span><br><span class="line">$$.each([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="function"><span class="keyword">function</span>(<span class="params">ele, idx</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.info(idx + <span class="string">" : "</span> + ele);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>全部代码贴在这里，可以在我的<a href="https://github.com/zrysmt/DIY-underscorejs" target="_blank" rel="noopener">github</a>查看具体的所有代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DIY 一个underscore库1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//在浏览器上是window(self),服务器上是global</span></span><br><span class="line">    <span class="keyword">var</span> root = <span class="keyword">typeof</span> self == <span class="string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||</span><br><span class="line">        <span class="keyword">typeof</span> global == <span class="string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||</span><br><span class="line">        <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> previousUnderscore = root._;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">        <span class="keyword">this</span>._wrapped = obj; <span class="comment">//存放数据</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    root._ = _;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ArrayProto = <span class="built_in">Array</span>.prototype,</span><br><span class="line">        ObjProto = <span class="built_in">Object</span>.prototype;</span><br><span class="line">    <span class="keyword">var</span> push = ArrayProto.push,</span><br><span class="line">        toString = ObjProto.toString,</span><br><span class="line">        hasOwnProperty = ObjProto.hasOwnProperty;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> nativeIsArray = <span class="built_in">Array</span>.isArray,</span><br><span class="line">        nativeKeys = <span class="built_in">Object</span>.keys;</span><br><span class="line">    <span class="comment">//判断是不是对象/函数</span></span><br><span class="line">    _.isObject = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> type = <span class="keyword">typeof</span> obj;</span><br><span class="line">        <span class="keyword">return</span> type === <span class="string">'function'</span> || type === <span class="string">'object'</span> &amp;&amp; !!obj;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> optimizeCb = <span class="function"><span class="keyword">function</span>(<span class="params">func, context, argCount</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//void 0 === undefined 返回ture</span></span><br><span class="line">        <span class="keyword">if</span> (context === <span class="keyword">void</span> <span class="number">0</span>) <span class="keyword">return</span> func;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> func.apply(context, <span class="built_in">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    _.VERSION = <span class="string">'0.0.1'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> property = <span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> obj == <span class="literal">null</span> ? <span class="keyword">void</span> <span class="number">0</span> : obj[key];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> MAX_ARRAY_INDEX = <span class="built_in">Math</span>.pow(<span class="number">2</span>, <span class="number">53</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> getLength = property(<span class="string">'length'</span>);</span><br><span class="line">    <span class="keyword">var</span> isArrayLike = <span class="function"><span class="keyword">function</span>(<span class="params">collection</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> length = getLength(collection);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typeof</span> length == <span class="string">'number'</span> &amp;&amp; length &gt;= <span class="number">0</span> &amp;&amp; length &lt;= MAX_ARRAY_INDEX;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _.each = _.forEach = <span class="function"><span class="keyword">function</span>(<span class="params">obj, iteratee, context</span>) </span>&#123;</span><br><span class="line">        iteratee = optimizeCb(iteratee, context);</span><br><span class="line">        <span class="keyword">var</span> i, length;</span><br><span class="line">        <span class="keyword">if</span> (isArrayLike(obj)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>, length = obj.length; i &lt; length; i++) &#123;</span><br><span class="line">                iteratee(obj[i], i, obj); <span class="comment">//(element, index, list)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> keys = _.keys(obj);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>, length = keys.length; i &lt; length; i++) &#123;</span><br><span class="line">                iteratee(obj[keys[i]], keys[i], obj); <span class="comment">//(value, key, list)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj; <span class="comment">//返回obj方便链式调用</span></span><br><span class="line">    &#125;;</span><br><span class="line">    _.keys = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//不是对象/函数,返回空数组</span></span><br><span class="line">        <span class="keyword">if</span> (!_.isObject(obj)) <span class="keyword">return</span> [];</span><br><span class="line">        <span class="comment">//使用ES5中的方法，返回属性（数组）</span></span><br><span class="line">        <span class="keyword">if</span> (nativeKeys) <span class="keyword">return</span> nativeKeys(obj);</span><br><span class="line">        <span class="keyword">var</span> keys = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj)</span><br><span class="line">            <span class="keyword">if</span> (_.has(obj, key)) keys.push(key);</span><br><span class="line">            <span class="comment">//兼容IE&lt; 9</span></span><br><span class="line">    &#125;;</span><br><span class="line">    _.has = <span class="function"><span class="keyword">function</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obj != <span class="literal">null</span> &amp;&amp; hasOwnProperty.call(obj, key);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/*链式*/</span></span><br><span class="line">    _.chain = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> instance = _(obj);</span><br><span class="line">        instance._chain = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    _.chain(arr)</span></span><br><span class="line"><span class="comment">        .each(function(ele) &#123;</span></span><br><span class="line"><span class="comment">            console.log(ele);</span></span><br><span class="line"><span class="comment">        &#125;)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> chainResult = <span class="function"><span class="keyword">function</span>(<span class="params">instance, obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance._chain ? _(obj).chain() : obj;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法放入原型中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    _.each([<span class="string">'Arguments'</span>, <span class="string">'Function'</span>, <span class="string">'String'</span>, <span class="string">'Number'</span>, <span class="string">'Date'</span>, <span class="string">'RegExp'</span>, <span class="string">'Error'</span>, <span class="string">'Symbol'</span>, <span class="string">'Map'</span>, <span class="string">'WeakMap'</span>, <span class="string">'Set'</span>, <span class="string">'WeakSet'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">        _[<span class="string">'is'</span> + name] = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> toString.call(obj) === <span class="string">'[object '</span> + name + <span class="string">']'</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// IE 11 (#1621), Safari 8 (#1929), and PhantomJS (#2236).</span></span><br><span class="line">    <span class="keyword">var</span> nodelist = root.document &amp;&amp; root.document.childNodes;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> /./ != <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Int8Array</span> != <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> nodelist != <span class="string">'function'</span>) &#123;</span><br><span class="line">        _.isFunction = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">typeof</span> obj == <span class="string">'function'</span> || <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _.functions = _.methods = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> names = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_.isFunction(obj[key])) names.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> names.sort();</span><br><span class="line">    &#125;;</span><br><span class="line">    _.mixin = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        _.each(_.functions(obj), <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> func = _[name] = obj[name];</span><br><span class="line">            _.prototype[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> args = [<span class="keyword">this</span>._wrapped]; <span class="comment">//_ 保存的数据obj</span></span><br><span class="line">                push.apply(args, <span class="built_in">arguments</span>);</span><br><span class="line">                <span class="comment">//原型方法中的数据和args合并到一个数组中</span></span><br><span class="line">                <span class="keyword">return</span> chainResult(<span class="keyword">this</span>, func.apply(_, args));</span><br><span class="line">                <span class="comment">//将_.prototype[name]的this指向 _ (func.apply(_,args)已经</span></span><br><span class="line">                <span class="comment">//将func的this指向了 _ ,并且传了参数),返回带链式的obj，即是 _ </span></span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> _;</span><br><span class="line">    &#125;;</span><br><span class="line">    _.mixin(_);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 避免冲突</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    _.noConflict = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        root._ = previousUnderscore;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure></p>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="http://underscorejs.org/" target="_blank" rel="noopener">http://underscorejs.org/</a></li>
<li><a href="http://www.bootcss.com/p/underscore/" target="_blank" rel="noopener">underscorejs中文：http://www.bootcss.com/p/underscore/</a></li>
<li><a href="http://blog.fens.me/nodejs-underscore/" target="_blank" rel="noopener">UnderscoreJS精巧而强大工具包</a></li>
<li><a href="http://www.imooc.com/article/1566" target="_blank" rel="noopener">JS高手进阶之路：underscore源码经典</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/13/PHP爬虫最全总结2-phpQuery，PHPcrawer，snoopy框架中文介绍/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/13/PHP爬虫最全总结2-phpQuery，PHPcrawer，snoopy框架中文介绍/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">PHP爬虫最全总结2-phpQuery，PHPcrawer，snoopy框架中文介绍</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-13 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-13T00:00:00+08:00">2016-10-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:01:38" itemprop="dateModified" datetime="2018-11-30T11:01:38+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>第一篇文章介绍了使用原生的PHP和PHP的扩展库实现了爬虫技术。本文尝试使用PHP爬虫框架来写，首先对三种爬虫技术<a href="https://github.com/punkave/phpQuery" target="_blank" rel="noopener">phpQuery</a>，<a href="http://phpcrawl.cuab.de/" target="_blank" rel="noopener">PHPcrawer</a>， snoopy进行对比，然后分析模拟浏览器行为的方式，重点介绍下snoopy</p>
<blockquote>
<p>所有代码挂在我的<a href="https://github.com/zrysmt/PHPSpider" target="_blank" rel="noopener">github</a>上</p>
</blockquote>
<h1 id="1-几种常用的PHP爬虫框架对比"><a href="#1-几种常用的PHP爬虫框架对比" class="headerlink" title="1.几种常用的PHP爬虫框架对比"></a>1.几种常用的PHP爬虫框架对比</h1><h2 id="1-1-phpQuery"><a href="#1-1-phpQuery" class="headerlink" title="1.1 phpQuery"></a>1.1 <a href="https://github.com/punkave/phpQuery" target="_blank" rel="noopener">phpQuery</a></h2><p><strong>优势：</strong>类似jquery的强大搜索DOM的能力。<br>pq()是一个功能强大的搜索DOM的方法，跟jQuery的$()如出一辙，jQuery的选择器基本上都能使用在phpQuery上，只要把“.”变成“-&gt;”,Demo如下(对应我的github的Demo5)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"> <span class="keyword">require</span>(<span class="string">'phpQuery/phpQuery.php'</span>);</span><br><span class="line"> phpQuery::newDocumentFile(<span class="string">'http://www.baidu.com/'</span>); </span><br><span class="line"> $menu_a = pq(<span class="string">"a"</span>); </span><br><span class="line"> <span class="keyword">foreach</span>($menu_a <span class="keyword">as</span> $a)&#123;</span><br><span class="line">    <span class="keyword">echo</span> pq($a)-&gt;html().<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">foreach</span>($menu_a <span class="keyword">as</span> $a)&#123;</span><br><span class="line">    <span class="keyword">echo</span> pq($a)-&gt;attr(<span class="string">"href"</span>).<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"> &#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-2-PHPcrawer"><a href="#1-2-PHPcrawer" class="headerlink" title="1.2 PHPcrawer"></a>1.2 <a href="http://phpcrawl.cuab.de/" target="_blank" rel="noopener">PHPcrawer</a></h2><p><strong>优势：</strong>过滤能力比较强。<br>官方给的Demo如下（我的github中对应demo4）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="keyword">include</span>(<span class="string">"PHPCrawl/libs/PHPCrawler.class.php"</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyCrawler</span> <span class="keyword">extends</span> <span class="title">PHPCrawler</span> </span></span><br><span class="line"><span class="class">    </span>&#123; </span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">handleDocumentInfo</span><span class="params">(PHPCrawlerDocumentInfo $PageInfo)</span> </span></span><br><span class="line"><span class="function">      </span>&#123; <span class="comment">// As example we just print out the URL of the document </span></span><br><span class="line">        <span class="keyword">echo</span> $PageInfo-&gt;url.<span class="string">"&lt;br&gt;"</span>; </span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    $crawler = <span class="keyword">new</span> MyCrawler(); </span><br><span class="line">    $crawler-&gt;setURL(<span class="string">"www.baidu.com"</span>); </span><br><span class="line">    $crawler-&gt;addURLFilterRule(<span class="string">"#\.(jpg|gif)$# i"</span>);</span><br><span class="line">    <span class="comment">//过滤到含有这些图片格式的URL</span></span><br><span class="line">    $crawler-&gt;go();</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-3-snoopy"><a href="#1-3-snoopy" class="headerlink" title="1.3 snoopy"></a>1.3 snoopy</h2><p><strong>优势：</strong>提交表单，设置代理等<br>Snoopy是一个php类，用来模拟浏览器的功能，可以获取网页内容，发送表单，<br>demo如下（对应github中的demo3）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">'Snoopy/Snoopy.class.php'</span>;</span><br><span class="line">$snoopy = <span class="keyword">new</span> Snoopy();</span><br><span class="line">$url = <span class="string">"http://www.baidu.com"</span>;</span><br><span class="line"><span class="comment">// $snoopy-&gt;fetch($url);</span></span><br><span class="line"><span class="comment">// $snoopy-&gt;fetchtext($url);//去除HTML标签和其他的无关数据</span></span><br><span class="line">$snoopy-&gt;fetchform($url);<span class="comment">//只获取表单</span></span><br><span class="line"><span class="comment">//只返回网页中链接 默认情况下，相对链接将自动补全，转换成完整的URL。</span></span><br><span class="line"><span class="comment">// $snoopy-&gt;fetchlinks($url);</span></span><br><span class="line">var_dump($snoopy-&gt;results);</span><br></pre></td></tr></table></figure>
<h2 id="1-4-phpspider"><a href="#1-4-phpspider" class="headerlink" title="1.4 phpspider"></a>1.4 <a href="http://www.sphider.eu/" target="_blank" rel="noopener">phpspider</a></h2><p><strong>优势：</strong>安装配置到数据库<br>提供了安装配置，能够直接连接mysql数据库，使用也是比较广泛，这里我们暂时不单独介绍。</p>
<h1 id="2-模拟用户行为"><a href="#2-模拟用户行为" class="headerlink" title="2.模拟用户行为"></a>2.模拟用户行为</h1><h2 id="2-1-file-get-contents"><a href="#2-1-file-get-contents" class="headerlink" title="2.1 file_get_contents"></a>2.1 file_get_contents</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$opts = <span class="keyword">array</span>(</span><br><span class="line">  <span class="string">'http'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'method'</span>=&gt;<span class="string">"GET"</span>,</span><br><span class="line">    <span class="string">'header'</span>=&gt;<span class="string">"Accept-language: en\r\n"</span> .</span><br><span class="line">              <span class="string">"Cookie: foo=bar\r\n"</span></span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$context = stream_context_create($opts);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Sends an http request to www.example.com</span></span><br><span class="line"><span class="comment">   with additional headers shown above */</span></span><br><span class="line">$fp = fopen(<span class="string">'http://www.example.com'</span>, <span class="string">'r'</span>, <span class="keyword">false</span>, $context);</span><br><span class="line">fpassthru($fp);</span><br><span class="line">fclose($fp);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-2-curl"><a href="#2-2-curl" class="headerlink" title="2.2 curl"></a>2.2 curl</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ch=curl_init();  <span class="comment">//初始化一个cURL会话</span></span><br><span class="line">curl_setopt($ch,CURLOPT_URL,$url);<span class="comment">//设置需要获取的 URL 地址</span></span><br><span class="line"><span class="comment">// 设置浏览器的特定header</span></span><br><span class="line">curl_setopt($ch, CURLOPT_HTTPHEADER, <span class="keyword">array</span>(</span><br><span class="line">  <span class="string">"Host: www.baidu.com"</span>,</span><br><span class="line">  <span class="string">"Connection: keep-alive"</span>,</span><br><span class="line">  <span class="string">"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>,</span><br><span class="line">  <span class="string">"Upgrade-Insecure-Requests: 1"</span>,</span><br><span class="line">  <span class="string">"DNT:1"</span>,</span><br><span class="line">  <span class="string">"Accept-Language: zh-CN,zh;q=0.8,en-GB;q=0.6,en;q=0.4,en-US;q=0.2"</span>,</span><br><span class="line">  <span class="string">"Cookie:_za=4540d427-eee1-435a-a533-66ecd8676d7d;"</span>    </span><br><span class="line">));</span><br><span class="line">$result=curl_exec($ch);<span class="comment">//执行一个cURL会话</span></span><br></pre></td></tr></table></figure>
<h2 id="2-3-snoopy"><a href="#2-3-snoopy" class="headerlink" title="2.3 snoopy"></a>2.3 snoopy</h2><ul>
<li>表单提交</li>
</ul>
<p>我们的一个例子<br>form-demo.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>form-demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"./form-demo.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"userName"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        密 码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>form-demo.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    $userName = $_POST[<span class="string">'userName'</span>];</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    <span class="keyword">if</span>($userName===<span class="string">"admin"</span>&amp;&amp;$password===<span class="string">"admin"</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"hello admin"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"login error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>提交表单<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'Snoopy/Snoopy.class.php'</span>;</span><br><span class="line">$snoopy = <span class="keyword">new</span> Snoopy();</span><br><span class="line">$formvars[<span class="string">"userName"</span>] = <span class="string">"admin"</span>;</span><br><span class="line"><span class="comment">//userName 与服务器端/表单的name属性一致</span></span><br><span class="line">$formvars[<span class="string">"password"</span>] = <span class="string">"admin"</span>;</span><br><span class="line">$action = <span class="string">"http://localhost:8000/spider/demo3/form-demo.php"</span>;<span class="comment">//表单提交地址</span></span><br><span class="line">$snoopy-&gt;submit($action,$formvars);</span><br><span class="line"><span class="keyword">echo</span> $snoopy-&gt;results;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>问题1：openssl extension required for HTTPS 增加对https的支持</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php.in ==&gt; ;extension=php_openssl.dll 去除注释</span><br></pre></td></tr></table></figure>
<blockquote>
<p>问题2：405 Not Allowed增加</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$snoopy-&gt;agent = <span class="string">"(compatible; MSIE 4.01; MSN 2.5; AOL 4.0; Windows 98)"</span>; <span class="comment">//伪装浏览器</span></span><br><span class="line">$snoopy-&gt;referer = <span class="string">"http://www.icultivator.com"</span>; <span class="comment">//伪装来源页地址 http_referer</span></span><br><span class="line">$snoopy-&gt;rawheaders[<span class="string">"Pragma"</span>] = <span class="string">"no-cache"</span>; <span class="comment">//cache 的http头信息</span></span><br><span class="line">$snoopy-&gt;rawheaders[<span class="string">"X_FORWARDED_FOR"</span>] = <span class="string">"122.0.74.166"</span>; <span class="comment">//伪装ip</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>问题3 : snoopy使用代理</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$snoopy-&gt;proxy_host = <span class="string">"http://www.icultivator.com"</span>;</span><br><span class="line"><span class="comment">// HTTPS connections over proxy are currently not supported</span></span><br><span class="line">$snoopy-&gt;proxy_port = <span class="string">"8080"</span>; <span class="comment">//使用代理</span></span><br><span class="line">$snoopy-&gt;maxredirs = <span class="number">2</span>; <span class="comment">//重定向次数</span></span><br><span class="line">$snoopy-&gt;expandlinks = <span class="keyword">true</span>; <span class="comment">//是否补全链接 在采集的时候经常用到</span></span><br><span class="line">$snoopy-&gt;maxframes = <span class="number">5</span>; <span class="comment">//允许的最大框架数</span></span><br></pre></td></tr></table></figure>
<p><strong>问题：</strong><br>其实尝试了网站进行提交表单是有问题的。这样简单的处理是不能提交表单的，使用代理也是有问题<br>的。snoopy框架确实会有很多问题，后面有解决思路了再说。</p>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="https://my.oschina.net/junn/blog/147936" target="_blank" rel="noopener">cURL、file_get_contents、snoopy.class.php 优缺点</a></li>
<li><a href="http://www.oschina.net/project/lang/22?tag=64&amp;show=news" target="_blank" rel="noopener">开源中国-PHP爬虫框架列表</a></li>
<li><a href="http://blog.johnsonlu.org/phpphpquery/" target="_blank" rel="noopener">phpQuery</a></li>
<li><a href="https://sourceforge.net/projects/snoopy/" target="_blank" rel="noopener">Snoopy下载地址</a></li>
<li><a href="http://www.thinksaas.cn/topics/0/558/558466.html" target="_blank" rel="noopener">Snoopy —— 强大的PHP采集类使用详解及示例：采集、模拟登录及伪装浏览器</a></li>
<li><a href="https://www.oschina.net/search?scope=blog&amp;q=Snoopy" target="_blank" rel="noopener">开源中国-snoopy博客列表</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/11/前端自动化测试工具--使用karma进行javascript单元测试/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/11/前端自动化测试工具--使用karma进行javascript单元测试/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">前端自动化测试工具--使用karma进行javascript单元测试</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-11 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-11T00:00:00+08:00">2016-10-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:10:15" itemprop="dateModified" datetime="2018-11-30T11:10:15+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前面我写了一篇博客是《前端自动化测试工具PhantomJS+CasperJS结合使用教程》其中使用CasperJS不仅可以进行单元测试，还可以进行浏览器测试，是个很不错的工具，今天介绍的工具是Karma+Jasmine+PhantomJS组合的前端javascript单元测试工具。</p>
<h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h1><p>Karma是由Google团队开发的一套前端测试运行框架，karma会启动一个web服务器，将js源代码和测试脚本放到PhantomJS或者Chrome上执行。</p>
<h1 id="2-安装"><a href="#2-安装" class="headerlink" title="2.安装"></a>2.安装</h1><ul>
<li>包管理package.json</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br></pre></td></tr></table></figure>
<p>一路回车下去即可</p>
<ul>
<li>在项目中安装karma包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i karma --save-dev</span><br></pre></td></tr></table></figure>
<ul>
<li>karma初始化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">karma init</span><br></pre></td></tr></table></figure>
<p>按照下面的选择好</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">E:\javascript\auto-test\karma-demo&gt;karma init</span><br><span class="line"></span><br><span class="line">Which testing framework <span class="keyword">do</span> you want to use ?</span><br><span class="line">Press tab to list possible options. Enter to move to the next question.</span><br><span class="line">&gt; jasmine</span><br><span class="line"></span><br><span class="line">Do you want to use Require.js ?</span><br><span class="line">This will add Require.js plugin.</span><br><span class="line">Press tab to list possible options. Enter to move to the next question.</span><br><span class="line">&gt; no</span><br><span class="line"></span><br><span class="line">Do you want to capture any browsers automatically ?</span><br><span class="line">Press tab to list possible options. Enter empty string to move to the next question.</span><br><span class="line">&gt; PhantomJS</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">What is the location of your <span class="built_in">source</span> and <span class="built_in">test</span> files ?</span><br><span class="line">You can use glob patterns, eg. <span class="string">"js/*.js"</span> or <span class="string">"test/**/*Spec.js"</span>.</span><br><span class="line">Enter empty string to move to the next question.</span><br><span class="line">&gt; src/**/*.js</span><br><span class="line">&gt; <span class="built_in">test</span>/**/*.js</span><br><span class="line">14 10 2016 10:49:43.958:WARN [init]: There is no file matching this pattern.</span><br><span class="line"></span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">Should any of the files included by the previous patterns be excluded ?</span><br><span class="line">You can use glob patterns, eg. <span class="string">"**/*.swp"</span>.</span><br><span class="line">Enter empty string to move to the next question.</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">Do you want Karma to watch all the files and run the tests on change ?</span><br><span class="line">Press tab to list possible options.</span><br><span class="line">&gt; yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Config file generated at <span class="string">"E:\javascript\auto-test\karma-demo\karma.conf.js"</span>.</span><br></pre></td></tr></table></figure>
<p>上图是选项的示例，这里使用jasmine测试框架，PhantomJS作为代码运行的环境（也可以选择其他浏览器作为运行环境，比如Chrome，IE等）。最后在项目中生成karma.conf.js文件</p>
<ul>
<li>安装jasmine-core</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i jasmine-core --save-dev</span><br></pre></td></tr></table></figure>
<h1 id="3-demo1–ES5"><a href="#3-demo1–ES5" class="headerlink" title="3.demo1–ES5"></a>3.demo1–ES5</h1><p>目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">karma-example</span><br><span class="line">    ├──  src</span><br><span class="line">         ├──  index.js</span><br><span class="line">    ├──  test</span><br><span class="line">    ├──  package.json</span><br></pre></td></tr></table></figure></p>
<p>源码：src–index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isNum</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> num === <span class="string">'number'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试：test–index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'index.js: '</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'isNum() should work fine.'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(isNum(<span class="number">1</span>)).toBe(<span class="literal">true</span>)</span><br><span class="line">    expect(isNum(<span class="string">'1'</span>)).toBe(<span class="literal">false</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>运行，执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">karma start</span><br></pre></td></tr></table></figure></p>
<p>命令行结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">14 10 2016 10:56:13.038:WARN [karma]: No captured browser, open http://localhost:9876/</span><br><span class="line">14 10 2016 10:56:13.067:INFO [karma]: Karma v1.3.0 server started at http://localhost:9876/</span><br><span class="line">14 10 2016 10:56:13.101:INFO [launcher]: Launching browser PhantomJS with unlimited concurrency</span><br><span class="line">14 10 2016 10:56:13.119:INFO [launcher]: Starting browser PhantomJS</span><br><span class="line">14 10 2016 10:56:16.207:INFO [PhantomJS 2.1.1 (Windows 8 0.0.0)]: Connected on socket /<span class="comment">#JoOdYxAeCS4xvhHHAAAA with id 87859111</span></span><br><span class="line">PhantomJS 2.1.1 (Windows 8 0.0.0): Executed 1 of 1 SUCCESS (0.009 secs / 0.004 secs)</span><br></pre></td></tr></table></figure>
<h1 id="4-demo2-ES6"><a href="#4-demo2-ES6" class="headerlink" title="4.demo2-ES6"></a>4.demo2-ES6</h1><p>安装<strong>使用Webpack+Babel</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i  karma-webpack --save-dev</span><br><span class="line">npm i  babel-loader babel-core babel-preset-es2015 --save-dev</span><br></pre></td></tr></table></figure></p>
<p>源码src–index2.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isNum</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> num === <span class="string">'number'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> &#123;isNum&#125;;</span><br><span class="line"><span class="comment">// export default isNum;</span></span><br></pre></td></tr></table></figure></p>
<p>测试test–index2.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;isNum&#125; <span class="keyword">from</span> <span class="string">'../src/index2'</span>;</span><br><span class="line"><span class="comment">// import isNum from '../src/index2';</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'index2.js:'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'isNum() should work fine.'</span>, () =&gt; &#123;</span><br><span class="line">    expect(isNum(<span class="number">1</span>)).toBe(<span class="literal">true</span>);</span><br><span class="line">    expect(isNum(<span class="string">'1'</span>)).toBe(<span class="literal">false</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>修改配置文件<code>karma.conf.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">config.set(&#123;</span><br><span class="line">        basePath: <span class="string">''</span>,</span><br><span class="line">        frameworks: [<span class="string">'jasmine'</span>],</span><br><span class="line">        <span class="comment">//修改</span></span><br><span class="line">        files: [</span><br><span class="line">            <span class="comment">// 'src/**/*.js',</span></span><br><span class="line">            <span class="string">'test/**/*.js'</span></span><br><span class="line">        ],</span><br><span class="line">        exclude: [],</span><br><span class="line">        preprocessors: &#123;</span><br><span class="line">            <span class="string">'test/**/*.js'</span>: [<span class="string">'webpack'</span>, <span class="string">'coverage'</span>] <span class="comment">//新增</span></span><br><span class="line">            <span class="comment">//coverage为覆盖率测试，这里不再介绍</span></span><br><span class="line">        &#125;,</span><br><span class="line">        reporters: [<span class="string">'progress'</span>, <span class="string">'coverage'</span>],</span><br><span class="line">        <span class="comment">// 新增--覆盖率测试</span></span><br><span class="line">        coverageReporter: &#123;</span><br><span class="line">            type: <span class="string">'html'</span>,</span><br><span class="line">            dir: <span class="string">'coverage/'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        port: <span class="number">9876</span>,</span><br><span class="line">        colors: <span class="literal">true</span>，</span><br><span class="line">        logLevel: config.LOG_INFO,</span><br><span class="line">        autoWatch: <span class="literal">true</span>,</span><br><span class="line">        browsers: [<span class="string">'PhantomJS'</span>],</span><br><span class="line">        singleRun: <span class="literal">false</span>,</span><br><span class="line">        concurrency: <span class="literal">Infinity</span>,</span><br><span class="line">        <span class="comment">//新增</span></span><br><span class="line">        webpack: &#123;</span><br><span class="line">            <span class="built_in">module</span>: &#123;</span><br><span class="line">                loaders: [&#123;</span><br><span class="line">                    test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                    loader: <span class="string">'babel'</span>,</span><br><span class="line">                    exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                    query: &#123;</span><br><span class="line">                        presets: [<span class="string">'es2015'</span>]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="http://karma-runner.github.io/" target="_blank" rel="noopener">http://karma-runner.github.io/</a></li>
<li><a href="https://github.com/karma-runner/karma" target="_blank" rel="noopener">https://github.com/karma-runner/karma</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzAxODE2MjM1MA==&amp;mid=2651551281&amp;idx=2&amp;sn=a2c7e0c5ce40d3c76a77878bb059b247&amp;chksm=8025a1f0b75228e69ba643cba44872120d8a54c5ec240c36fd37f2d8b5a24d2e980464df651e&amp;scene=1&amp;srcid=0921IND89Hz7S81VX0ZCtsGf#rd" target="_blank" rel="noopener">前端单元测试之Karma环境搭建</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/11/前端自动化测试工具PhantomJS+CasperJS结合使用教程/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/11/前端自动化测试工具PhantomJS+CasperJS结合使用教程/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">前端自动化测试工具PhantomJS+CasperJS结合使用教程</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-11 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-11T00:00:00+08:00">2016-10-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:10:15" itemprop="dateModified" datetime="2018-11-30T11:10:15+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>下面的安装测试基于window系统（win10）</p>
</blockquote>
<h1 id="1-PhantomJS"><a href="#1-PhantomJS" class="headerlink" title="1.PhantomJS"></a>1.PhantomJS</h1><p><a href="http://phantomjs.org/" title=" phantomjs " target="_blank" rel="noopener"><strong>PhantomJS</strong> </a>是一个基于 <strong>WebKit</strong> 的服务器端JavaScript API,它全面支持web而不需浏览器支持，其快速，原生支持各种Web标准： DOM 处理, CSS 选择器, JSON, Canvas, 和 SVG。 PhantomJS 可以用于 页面自动化， 网络监测 ， 网页截屏 ，以及 无界面测试 等</p>
<h2 id="1-1-安装"><a href="#1-1-安装" class="headerlink" title="1.1 安装"></a>1.1 安装</h2><p>下载地址为：<a href="http://phantomjs.org/download.html" target="_blank" rel="noopener">http://phantomjs.org/download.html</a> 解压之后，可以加到环境变量中</p>
<h2 id="1-2-使用"><a href="#1-2-使用" class="headerlink" title="1.2 使用"></a>1.2 使用</h2><ul>
<li>示例demo1.js–截图：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'webpage'</span>).create();</span><br><span class="line">page.viewportSize = &#123;</span><br><span class="line">    width: <span class="number">1366</span>,</span><br><span class="line">    height: <span class="number">800</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> urls = [<span class="string">"https://www.baidu.com/"</span>, <span class="string">"https://zrysmt.github.io/"</span>];</span><br><span class="line">page.open(urls[<span class="number">0</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'welcome!'</span>);</span><br><span class="line">    page.render(<span class="string">'screen.png'</span>);</span><br><span class="line">    phantom.exit();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>命令行输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phantomjs demo1.js</span><br></pre></td></tr></table></figure></p>
<ul>
<li>示例demo2.js–DOM操作</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'webpage'</span>).create();</span><br><span class="line">phantom.outputEncoding = <span class="string">"gbk"</span>; <span class="comment">//解决中文乱码</span></span><br><span class="line">page.open(<span class="string">"https://www.baidu.com/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">status</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(status);</span><br><span class="line">    page.render(<span class="string">'screen.png'</span>);</span><br><span class="line">    <span class="keyword">var</span> title = page.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>.title;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Page title: '</span> + title);</span><br><span class="line">    phantom.exit();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>执行命令同上，得到结果是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">success</span><br><span class="line">Page title: 百度一下，你就知道</span><br></pre></td></tr></table></figure></p>
<p>所执行的DOM操作要在<code>page.evaluate</code>中，</p>
<ul>
<li>示例demo3.js–读取文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> system = <span class="built_in">require</span>(<span class="string">'system'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">phantom.outputEncoding = <span class="string">"gbk"</span>; <span class="comment">//解决中文乱码</span></span><br><span class="line"><span class="keyword">var</span> filePath = <span class="string">"url-02.txt"</span>;</span><br><span class="line"><span class="keyword">var</span> content = fs.read(filePath);</span><br><span class="line"><span class="built_in">console</span>.log(content);</span><br></pre></td></tr></table></figure>
<p>url-02.txt中如果是很多url，一个一个访问url的话，可能会这样实现<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">page.open(urlArr[<span class="number">0</span>], <span class="function"><span class="keyword">function</span>(<span class="params">status</span>) </span>&#123;</span><br><span class="line">    page.open(urlArr[<span class="number">1</span>], <span class="function"><span class="keyword">function</span>(<span class="params">status</span>) </span>&#123;</span><br><span class="line">       page.open(urlArr[<span class="number">2</span>], <span class="function"><span class="keyword">function</span>(<span class="params">status</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//... ...</span></span><br><span class="line">        &#125;); </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这样写法就有很大的不方便，于是我们就引入了CasperJS</p>
<h1 id="2-CasperJS"><a href="#2-CasperJS" class="headerlink" title="2.CasperJS"></a>2.CasperJS</h1><h2 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i casperjs --save-dev</span><br></pre></td></tr></table></figure>
<p>为方便使用也可以加入到环境变量中</p>
<h2 id="2-2-使用"><a href="#2-2-使用" class="headerlink" title="2.2 使用"></a>2.2 使用</h2><ul>
<li>示例demo:casper-test.js–打开网页截图</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> casper = <span class="built_in">require</span>(<span class="string">'casper'</span>).create();</span><br><span class="line">casper.start();</span><br><span class="line">casper.thenOpen(<span class="string">'http://www.baidu.com/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    casper.captureSelector(<span class="string">'baidu.png'</span>, <span class="string">'html'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">casper.run();</span><br></pre></td></tr></table></figure>
<p>执行命令如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">casperjs casper-test.js</span><br></pre></td></tr></table></figure></p>
<ul>
<li>示例demo:casper-test2.js–操作DOM，访问网页</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> casper = <span class="built_in">require</span>(<span class="string">'casper'</span>).create();</span><br><span class="line"><span class="keyword">var</span> links;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLinks</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">// Scrape the links from top-right nav of the website</span></span><br><span class="line">    <span class="keyword">var</span> links = <span class="built_in">document</span>.querySelectorAll(<span class="string">'ul.navigation li a'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.map.call(links, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> e.getAttribute(<span class="string">'href'</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Opens casperjs homepage</span></span><br><span class="line">casper.start(<span class="string">'http://casperjs.org/'</span>);</span><br><span class="line"></span><br><span class="line">casper.then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    links = <span class="keyword">this</span>.evaluate(getLinks);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">casper.run(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> links) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(links[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    casper.done();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>执行命令类比同上</p>
<ul>
<li>示例demo:casper-test3.js–单元测试</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mowed = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.moo = <span class="function"><span class="keyword">function</span> <span class="title">moo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mowed = <span class="literal">true</span>; <span class="comment">// mootable state: don't do that at home</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'moo!'</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">casper.test.begin(<span class="string">'Cow can moo'</span>, <span class="number">2</span>, <span class="function"><span class="keyword">function</span> <span class="title">suite</span>(<span class="params">test</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cow = <span class="keyword">new</span> Cow();</span><br><span class="line">    test.assertEquals(cow.moo(), <span class="string">'moo!'</span>);</span><br><span class="line">    test.assert(cow.mowed);</span><br><span class="line">    test.done();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">casperjs test casper-test3.js</span><br></pre></td></tr></table></figure></p>
<p>结果是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Test file: casper-test3.js</span><br><span class="line"># Cow can moo</span><br><span class="line">PASS Subject equals the expected value</span><br><span class="line">PASS Subject is strictly true</span><br><span class="line">PASS Cow can moo (2 tests)</span><br><span class="line">PASS 2 tests executed in 0.031s, 2 passed, 0 failed, 0 dubious, 0 skipped.</span><br></pre></td></tr></table></figure></p>
<ul>
<li>示例demo:casper-test4.js–浏览器测试</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">casper.test.begin(<span class="string">'Google search retrieves 10 or more results'</span>, <span class="number">5</span>, <span class="function"><span class="keyword">function</span> <span class="title">suite</span>(<span class="params">test</span>) </span>&#123;</span><br><span class="line">    casper.start(<span class="string">"http://www.google.fr/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        test.assertTitle(<span class="string">"Google"</span>, <span class="string">"google homepage title is the one expected"</span>);</span><br><span class="line">        test.assertExists(<span class="string">'form[action="/search"]'</span>, <span class="string">"main form is found"</span>);</span><br><span class="line">        <span class="keyword">this</span>.fill(<span class="string">'form[action="/search"]'</span>, &#123;</span><br><span class="line">            q: <span class="string">"casperjs"</span></span><br><span class="line">        &#125;, <span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    casper.then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        test.assertTitle(<span class="string">"casperjs - Recherche Google"</span>, <span class="string">"google title is ok"</span>);</span><br><span class="line">        test.assertUrlMatch(<span class="regexp">/q=casperjs/</span>, <span class="string">"search term has been submitted"</span>);</span><br><span class="line">        test.assertEval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> __utils__.findAll(<span class="string">"h3.r"</span>).length &gt;= <span class="number">10</span>;</span><br><span class="line">        &#125;, <span class="string">"google search for \"casperjs\" retrieves 10 or more results"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    casper.run(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        test.done();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>执行命令如demo3类比</p>
<h1 id="3-PhantomJs-CasperJs"><a href="#3-PhantomJs-CasperJs" class="headerlink" title="3.PhantomJs+CasperJs"></a>3.PhantomJs+CasperJs</h1><p>实现异步操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> casper = <span class="built_in">require</span>(<span class="string">'casper'</span>).create(); <span class="comment">//新建一个页面</span></span><br><span class="line"></span><br><span class="line">casper.start(url1); <span class="comment">//添加第一个URL</span></span><br><span class="line">casper.thenOpen(url2); <span class="comment">//添加第二个URL,依次类推</span></span><br><span class="line">casper.thenOpen(url3);</span><br><span class="line">casper.thenOpen(url4);</span><br><span class="line"></span><br><span class="line">casper.run(); <span class="comment">//开始导航</span></span><br></pre></td></tr></table></figure>
<p>demo(casper-phantomjs.js)如下–一次访问三十几个url：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> casper = <span class="built_in">require</span>(<span class="string">'casper'</span>).create();</span><br><span class="line">phantom.outputEncoding = <span class="string">"gbk"</span>; <span class="comment">//解决中文乱码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> filePath = <span class="string">"url-02.txt"</span>;</span><br><span class="line"><span class="keyword">var</span> content = fs.read(filePath);</span><br><span class="line"><span class="keyword">var</span> urlArr = content.split(<span class="string">'\n'</span>);</span><br><span class="line">casper.start();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; urlArr.length; i++) &#123;</span><br><span class="line">    casper.thenOpen(urlArr[i], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.echo(<span class="string">'Page title: '</span> + <span class="keyword">this</span>.getTitle());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">casper.run();</span><br><span class="line"><span class="comment">// phantom.exit();</span></span><br></pre></td></tr></table></figure></p>
<p>执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">casperjs casper-phantomjs.js</span><br></pre></td></tr></table></figure></p>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="http://phantomjs.org/" target="_blank" rel="noopener">http://phantomjs.org/</a></li>
<li><a href="http://www.tuicool.com/articles/beeMNj/" target="_blank" rel="noopener">PhantomJS快速入门教程</a></li>
<li><a href="http://casperjs.org/" target="_blank" rel="noopener">http://casperjs.org/</a></li>
<li><a href="http://imweb.io/topic/55e46d8d771670e207a16bdc" target="_blank" rel="noopener">浏览器自动化测试初探 - 使用phantomjs与casperjs</a></li>
<li><a href="http://www.cnblogs.com/ziyunfei/archive/2012/09/27/2706254.html" target="_blank" rel="noopener">CasperJS,基于PhantomJS的工具包</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/10/PHP爬虫最全总结1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/10/PHP爬虫最全总结1/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">PHP爬虫最全总结1</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-10 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-10T00:00:00+08:00">2016-10-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:01:32" itemprop="dateModified" datetime="2018-11-30T11:01:32+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　爬虫是我一直以来跃跃欲试的技术，现在的爬虫框架很多，比较流行的是基于python，nodejs，java，C#，PHP的的框架，其中又以基于python的爬虫流行最为广泛，还有的已经是一套傻瓜式的软件操作，如八爪鱼，火车头等软件。</p>
<p>　今天我们首先尝试的是使用PHP实现一个爬虫程序，首先在不使用爬虫框架的基础上实践也是为了理解爬虫的原理，然后再利用PHP的lib，框架和扩展进行实践。</p>
<blockquote>
<p>所有代码挂在我的<a href="https://github.com/zrysmt/PHPSpider" target="_blank" rel="noopener">github</a>上。</p>
</blockquote>
<h1 id="1-PHP简单的爬虫–原型"><a href="#1-PHP简单的爬虫–原型" class="headerlink" title="1.PHP简单的爬虫–原型"></a>1.PHP简单的爬虫–原型</h1><p><strong>爬虫的原理：</strong></p>
<ul>
<li>给定原始的url；</li>
<li>分析链接，根据设置的正则表达式获取链接中的内容；</li>
<li>有的会更新原始的url再进行分析链接，获取特定内容，周而复始。</li>
<li>将获取的内容保存在数据库中（mysql）或者本地文件中</li>
</ul>
<p>下面是网上一个例子，我们列下来然后分析<br>从<code>main</code>函数开始</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 爬虫程序 -- 原型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 从给定的url获取html内容</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_getUrlContent</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    $handle = fopen($url, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> ($handle) &#123;</span><br><span class="line">        $content = stream_get_contents($handle, <span class="number">-1</span>);</span><br><span class="line">        <span class="comment">//读取资源流到一个字符串,第二个参数需要读取的最大的字节数。默认是-1（读取全部的缓冲数据）</span></span><br><span class="line">        <span class="comment">// $content = file_get_contents($url, 1024 * 1024);</span></span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从html内容中筛选链接</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $web_content </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_filterUrl</span><span class="params">($web_content)</span> </span>&#123;</span><br><span class="line">    $reg_tag_a = <span class="string">'/&lt;[a|A].*?href=[\'\"]&#123;0,1&#125;([^&gt;\'\"\ ]*).*?&gt;/'</span>;</span><br><span class="line">    $result = preg_match_all($reg_tag_a, $web_content, $match_result);</span><br><span class="line">    <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">        <span class="keyword">return</span> $match_result[<span class="number">1</span>];</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修正相对路径</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $base_url </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $url_list </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_reviseUrl</span><span class="params">($base_url, $url_list)</span> </span>&#123;</span><br><span class="line">    $url_info = parse_url($base_url);<span class="comment">//解析url</span></span><br><span class="line">    $base_url = $url_info[<span class="string">"scheme"</span>] . <span class="string">'://'</span>;</span><br><span class="line">    <span class="keyword">if</span> ($url_info[<span class="string">"user"</span>] &amp;&amp; $url_info[<span class="string">"pass"</span>]) &#123;</span><br><span class="line">        $base_url .= $url_info[<span class="string">"user"</span>] . <span class="string">":"</span> . $url_info[<span class="string">"pass"</span>] . <span class="string">"@"</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    $base_url .= $url_info[<span class="string">"host"</span>];</span><br><span class="line">    <span class="keyword">if</span> ($url_info[<span class="string">"port"</span>]) &#123;</span><br><span class="line">        $base_url .= <span class="string">":"</span> . $url_info[<span class="string">"port"</span>];</span><br><span class="line">    &#125; </span><br><span class="line">    $base_url .= $url_info[<span class="string">"path"</span>];</span><br><span class="line">    print_r($base_url);</span><br><span class="line">    <span class="keyword">if</span> (is_array($url_list)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($url_list <span class="keyword">as</span> $url_item) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/^http/'</span>, $url_item)) &#123;</span><br><span class="line">                <span class="comment">// 已经是完整的url</span></span><br><span class="line">                $result[] = $url_item;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 不完整的url</span></span><br><span class="line">                $real_url = $base_url . <span class="string">'/'</span> . $url_item;</span><br><span class="line">                $result[] = $real_url;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 爬虫</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">crawler</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    $content = _getUrlContent($url);</span><br><span class="line">    <span class="keyword">if</span> ($content) &#123;</span><br><span class="line">        $url_list = _reviseUrl($url, _filterUrl($content));</span><br><span class="line">        <span class="keyword">if</span> ($url_list) &#123;</span><br><span class="line">            <span class="keyword">return</span> $url_list;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试用主程序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $file_path = <span class="string">"url-01.txt"</span>;</span><br><span class="line">    $current_url = <span class="string">"http://www.baidu.com/"</span>; <span class="comment">//初始url</span></span><br><span class="line">    <span class="keyword">if</span>(file_exists($file_path))&#123;</span><br><span class="line">        unlink($file_path);</span><br><span class="line">    &#125;</span><br><span class="line">    $fp_puts = fopen($file_path, <span class="string">"ab"</span>); <span class="comment">//记录url列表</span></span><br><span class="line">    $fp_gets = fopen($file_path, <span class="string">"r"</span>); <span class="comment">//保存url列表</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        $result_url_arr = crawler($current_url);</span><br><span class="line">        <span class="keyword">if</span> ($result_url_arr) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($result_url_arr <span class="keyword">as</span> $url) &#123;</span><br><span class="line">                fputs($fp_puts, $url . <span class="string">"\r\n"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">while</span> ($current_url = fgets($fp_gets, <span class="number">1024</span>)); <span class="comment">//不断获得url</span></span><br><span class="line">&#125; </span><br><span class="line">main();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="2-使用crul-lib"><a href="#2-使用crul-lib" class="headerlink" title="2.使用crul lib"></a>2.使用crul lib</h1><p>Curl是比较成熟的一个lib，异常处理、http header、POST之类都做得很好，重要的是PHP下操作MySQL进行入库操作比较省心。关于curl的说明具体可以查看PHP官方文档说明<a href="http://php.net/manual/zh/book.curl.php" target="_blank" rel="noopener">http://php.net/manual/zh/book.curl.php</a><br>不过在多线程Curl（Curl_multi）方面比较麻烦。</p>
<p><strong>开启crul</strong><br>针对winow系统：</p>
<ul>
<li><p>php.in中修改（注释；去掉即可） </p>
<blockquote>
<p>extension=php_curl.dll</p>
</blockquote>
</li>
<li><p>php文件夹下的libeay32.dll, ssleay32.dll, libssh2.dll 还有 php/ext下的php_curl4个文件移入windows/system32</p>
</li>
</ul>
<p>使用crul爬虫的<strong>步骤：</strong></p>
<ul>
<li>使用cURL函数的基本思想是先使用curl_init()初始化一个cURL会话；</li>
<li>接着你可以通过curl_setopt()设置你需要的全部选项；</li>
<li>然后使用curl_exec()来执行会话；</li>
<li>当执行完会话后使用curl_close()关闭会话。</li>
</ul>
<p><strong>例子</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ch = curl_init(<span class="string">"http://www.example.com/"</span>);</span><br><span class="line">$fp = fopen(<span class="string">"example_homepage.txt"</span>, <span class="string">"w"</span>);</span><br><span class="line"></span><br><span class="line">curl_setopt($ch, CURLOPT_FILE, $fp);</span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">curl_exec($ch);</span><br><span class="line">curl_close($ch);</span><br><span class="line">fclose($fp);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>一个完整点的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将demo1-01换成curl爬虫</span></span><br><span class="line"><span class="comment"> * 爬虫程序 -- 原型</span></span><br><span class="line"><span class="comment"> * 从给定的url获取html内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_getUrlContent</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    $ch=curl_init();  <span class="comment">//初始化一个cURL会话</span></span><br><span class="line">    <span class="comment">/*curl_setopt 设置一个cURL传输选项*/</span></span><br><span class="line">    <span class="comment">//设置需要获取的 URL 地址</span></span><br><span class="line">    curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">    <span class="comment">//TRUE 将curl_exec()获取的信息以字符串返回，而不是直接输出</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//启用时会将头文件的信息作为数据流输出</span></span><br><span class="line">    curl_setopt($ch,CURLOPT_HEADER,<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 设置浏览器的特定header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"Host: www.baidu.com"</span>,</span><br><span class="line">        <span class="string">"Connection: keep-alive"</span>,</span><br><span class="line">        <span class="string">"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>,</span><br><span class="line">        <span class="string">"Upgrade-Insecure-Requests: 1"</span>,</span><br><span class="line">        <span class="string">"DNT:1"</span>,</span><br><span class="line">        <span class="string">"Accept-Language: zh-CN,zh;q=0.8,en-GB;q=0.6,en;q=0.4,en-US;q=0.2"</span>,</span><br><span class="line">        <span class="comment">/*'Cookie:_za=4540d427-eee1-435a-a533-66ecd8676d7d; */</span>    </span><br><span class="line">        ));</span><br><span class="line">    $result=curl_exec($ch);<span class="comment">//执行一个cURL会话</span></span><br><span class="line">    $code=curl_getinfo($ch,CURLINFO_HTTP_CODE);<span class="comment">// 最后一个收到的HTTP代码</span></span><br><span class="line">    <span class="keyword">if</span>($code!=<span class="string">'404'</span> &amp;&amp; $result)&#123;</span><br><span class="line">       <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">    curl_close($ch);<span class="comment">//关闭cURL</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从html内容中筛选链接</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $web_content </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_filterUrl</span><span class="params">($web_content)</span> </span>&#123;</span><br><span class="line">    $reg_tag_a = <span class="string">'/&lt;[a|A].*?href=[\'\"]&#123;0,1&#125;([^&gt;\'\"\ ]*).*?&gt;/'</span>;</span><br><span class="line">    $result = preg_match_all($reg_tag_a, $web_content, $match_result);</span><br><span class="line">    <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">        <span class="keyword">return</span> $match_result[<span class="number">1</span>];</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修正相对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $base_url </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $url_list </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_reviseUrl</span><span class="params">($base_url, $url_list)</span> </span>&#123;</span><br><span class="line">    $url_info = parse_url($base_url);<span class="comment">//解析url</span></span><br><span class="line">    $base_url = $url_info[<span class="string">"scheme"</span>] . <span class="string">'://'</span>;</span><br><span class="line">    <span class="keyword">if</span> ($url_info[<span class="string">"user"</span>] &amp;&amp; $url_info[<span class="string">"pass"</span>]) &#123;</span><br><span class="line">        $base_url .= $url_info[<span class="string">"user"</span>] . <span class="string">":"</span> . $url_info[<span class="string">"pass"</span>] . <span class="string">"@"</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    $base_url .= $url_info[<span class="string">"host"</span>];</span><br><span class="line">    <span class="keyword">if</span> ($url_info[<span class="string">"port"</span>]) &#123;</span><br><span class="line">        $base_url .= <span class="string">":"</span> . $url_info[<span class="string">"port"</span>];</span><br><span class="line">    &#125; </span><br><span class="line">    $base_url .= $url_info[<span class="string">"path"</span>];</span><br><span class="line">    print_r($base_url);</span><br><span class="line">    <span class="keyword">if</span> (is_array($url_list)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($url_list <span class="keyword">as</span> $url_item) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/^http/'</span>, $url_item)) &#123;</span><br><span class="line">                <span class="comment">// 已经是完整的url</span></span><br><span class="line">                $result[] = $url_item;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 不完整的url</span></span><br><span class="line">                $real_url = $base_url . <span class="string">'/'</span> . $url_item;</span><br><span class="line">                $result[] = $real_url;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 爬虫</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">crawler</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    $content = _getUrlContent($url);</span><br><span class="line">    <span class="keyword">if</span> ($content) &#123;</span><br><span class="line">        $url_list = _reviseUrl($url, _filterUrl($content));</span><br><span class="line">        <span class="keyword">if</span> ($url_list) &#123;</span><br><span class="line">            <span class="keyword">return</span> $url_list;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试用主程序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $file_path = <span class="string">"./url-03.txt"</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists($file_path))&#123;</span><br><span class="line">        unlink($file_path);</span><br><span class="line">    &#125;</span><br><span class="line">    $current_url = <span class="string">"http://www.baidu.com"</span>; <span class="comment">//初始url</span></span><br><span class="line">    <span class="comment">//记录url列表 　ab- 追加打开一个二进制文件，并在文件末尾写数据</span></span><br><span class="line">    $fp_puts = fopen($file_path, <span class="string">"ab"</span>); </span><br><span class="line">    <span class="comment">//保存url列表 r-只读方式打开，将文件指针指向文件头</span></span><br><span class="line">    $fp_gets = fopen($file_path, <span class="string">"r"</span>); </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        $result_url_arr = crawler($current_url);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;$current_url&lt;/p&gt;"</span>;</span><br><span class="line">        <span class="keyword">if</span> ($result_url_arr) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($result_url_arr <span class="keyword">as</span> $url) &#123;</span><br><span class="line">                fputs($fp_puts, $url . <span class="string">"\r\n"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">while</span> ($current_url = fgets($fp_gets, <span class="number">1024</span>)); <span class="comment">//不断获得url</span></span><br><span class="line">&#125; </span><br><span class="line">main();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>要对https支持，需要在<code>_getUrlContent</code>函数中加入下面的设置：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_BASIC ) ; </span><br><span class="line">curl_setopt($ch, CURLOPT_USERPWD, <span class="string">"username:password"</span>);    </span><br><span class="line">curl_setopt($ch, CURLOPT_SSLVERSION,<span class="number">3</span>); </span><br><span class="line">curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="keyword">FALSE</span>); </span><br><span class="line">curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="number">2</span>);</span><br></pre></td></tr></table></figure></p>
<p><strong>结果疑惑：</strong><br>我们通过1和2部分得到的结果差异很大，第1部分能得到四千多条url数据，而第2部分却一直是45条数据。</p>
<p>还有我们获得url数据可能会有重复的，这部分处理在我的<a href="https://github.com/zrysmt/PHPSpider" target="_blank" rel="noopener">github</a>上，对应demo2-01.php，或者demo2-02.php</p>
<h1 id="3-file-get-contents-stream-get-contents与curl对比"><a href="#3-file-get-contents-stream-get-contents与curl对比" class="headerlink" title="3.file_get_contents/stream_get_contents与curl对比"></a>3.file_get_contents/stream_get_contents与curl对比</h1><h2 id="3-1-file-get-contents-stream-get-contents对比"><a href="#3-1-file-get-contents-stream-get-contents对比" class="headerlink" title="3.1 file_get_contents/stream_get_contents对比"></a>3.1 file_get_contents/stream_get_contents对比</h2><ul>
<li>stream_get_contents — 读取资源流到一个字符串<br>与 [file_get_contents()]一样，但是 <strong>stream_get_contents()</strong> 是对一个已经打开的资源流进行操作，并将其内容写入一个字符串返回</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$handle = fopen($url, <span class="string">"r"</span>);</span><br><span class="line">$content = stream_get_contents($handle, <span class="number">-1</span>);<span class="comment">//读取资源流到一个字符串,第二个参数需要读取的最大的字节数。默认是-1（读取全部的缓冲数据）</span></span><br></pre></td></tr></table></figure>
<ul>
<li>file_get_contents — 将整个文件读入一个字符串</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = file_get_contents($url, <span class="number">1024</span> * <span class="number">1024</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>【注】 如果要打开有特殊字符的 URL （比如说有空格），就需要使用进行 URL 编码。</p>
</blockquote>
<h2 id="3-2-file-get-contents-stream-get-contents与curl对比"><a href="#3-2-file-get-contents-stream-get-contents与curl对比" class="headerlink" title="3.2 file_get_contents/stream_get_contents与curl对比"></a>3.2 file_get_contents/stream_get_contents与curl对比</h2><p><a href="http://www.jb51.net/article/57238.htm" target="_blank" rel="noopener">php中file_get_contents与curl性能比较分析</a>一文中有详细的对比分析，主要的对比现在列下来：</p>
<ul>
<li><p>fopen /file_get_contents 每次请求都会重新做DNS查询，并不对 DNS信息进行缓存。但是CURL会自动对DNS信息进行缓存。对同一域名下的网页或者图片的请求只需要一次DNS查询。这大大减少了DNS查询的次数。所以CURL的性能比fopen /file_get_contents 好很多。</p>
</li>
<li><p>fopen /file_get_contents 在请求HTTP时，使用的是http_fopen_wrapper，不会keeplive。而curl却可以。这样在多次请求多个链接时，curl效率会好一些。</p>
</li>
<li><p>fopen / file_get_contents 函数会受到php.ini文件中allow_url_open选项配置的影响。如果该配置关闭了，则该函数也就失效了。而curl不受该配置的影响。</p>
</li>
<li><p>curl 可以模拟多种请求，例如：POST数据，表单提交等，用户可以按照自己的需求来定制请求。而fopen / file_get_contents只能使用get方式获取数据。</p>
</li>
</ul>
<h1 id="4-使用框架"><a href="#4-使用框架" class="headerlink" title="4.使用框架"></a>4.使用框架</h1><p>使用框架这一块打算以后单独研究，并拿出来单写一篇博客</p>
<blockquote>
<p>所有代码挂在我的<a href="https://github.com/zrysmt/PHPSpider" target="_blank" rel="noopener">github</a>上。</p>
</blockquote>
<p><strong>参考阅读：</strong></p>
<ul>
<li><a href="http://www.epooll.com/archives/806/" target="_blank" rel="noopener">我用爬虫一天时间“偷了”知乎一百万用户，只为证明PHP是世界上最好的语言</a></li>
<li><a href="https://www.zhihu.com/question/23643061" target="_blank" rel="noopener">知乎 – PHP, Python, Node.js 哪个比较适合写爬虫？</a></li>
<li><a href="http://qoofan.com/read/Pndwa54e8J.html" target="_blank" rel="noopener">最近关于对网络爬虫技术总结</a></li>
<li><a href="https://www.oschina.net/code/snippet_258733_12343" target="_blank" rel="noopener">PHP实现简单爬虫   (http://www.oschina.net/code/snippet_258733_12343)</a>]</li>
<li><a href="http://www.jb51.net/article/69108.htm" target="_blank" rel="noopener">一个PHP实现的轻量级简单爬虫</a></li>
<li><a href="http://www.jb51.net/article/57238.htm" target="_blank" rel="noopener">php中file_get_contents与curl性能比较分析</a></li>
<li><a href="http://www.cnblogs.com/freephp/p/4861184.html" target="_blank" rel="noopener">PHP curl之爬虫初步</a></li>
<li><a href="http://www.oschina.net/project/lang/22?tag=64&amp;show=news" target="_blank" rel="noopener">开源中国-PHP爬虫框架列表</a></li>
<li><a href="http://www.ido321.com/1158.html" target="_blank" rel="noopener">网页抓取：PHP实现网页爬虫方式小结，抓取爬虫</a></li>
<li><a href="http://phpcrawl.cuab.de/" target="_blank" rel="noopener">PHP爬虫框架–PHPCrawl</a></li>
<li><a href="http://www.chhua.com/web-note5277" title="链接到 php安装pcntl扩展实现多进程" target="_blank" rel="noopener">php安装pcntl扩展实现多进程</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/09/javascript数据结构6-字典-散列-集合/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/09/javascript数据结构6-字典-散列-集合/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">javascript数据结构6-字典 散列 集合</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-09 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-09T00:00:00+08:00">2016-10-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:57:44" itemprop="dateModified" datetime="2018-11-30T10:57:44+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/数据结构/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="6-1-字典"><a href="#6-1-字典" class="headerlink" title="6.1 字典"></a>6.1 字典</h2><p>字典是一种以键- 值对形式存储数据的数据结构，就像电话号码簿里的名字和电话号码一</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;字典sample&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function Dictionary()&#123;</span><br><span class="line">	   this.add = add;</span><br><span class="line">	   this.datastore = new Array();</span><br><span class="line">	   this.find = find;</span><br><span class="line">	   this.remove = remove;</span><br><span class="line">	   this.showAll = showAll;</span><br><span class="line">	   this.count = count;</span><br><span class="line">	   this.clear = clear;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function add(key, value) &#123;</span><br><span class="line">	   this.datastore[key] = value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function find(key) &#123;</span><br><span class="line">	   return this.datastore[key];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function remove(key) &#123;</span><br><span class="line">	   delete this.datastore[key];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function showAll() &#123;</span><br><span class="line">	if(this.datastore!=null)&#123;</span><br><span class="line">	   var datakeys=Array.prototype.slice.call(Object.keys(this.datastore));</span><br><span class="line">	   for (var key in datakeys) &#123;</span><br><span class="line">	      document.write(datakeys[key] + &quot; -&gt; &quot; + this.datastore[datakeys[key]]+&quot; &quot;);</span><br><span class="line">	      // console.log(Object.keys(this.datastore));</span><br><span class="line">	      console.log(key);</span><br><span class="line">	   &#125;</span><br><span class="line">	 &#125;else&#123;</span><br><span class="line">	 	document.write(&quot;字典为空&quot;);</span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function count() &#123;</span><br><span class="line">	   var n = 0;</span><br><span class="line">	   for  (var key in Object.keys(this.datastore)) &#123;</span><br><span class="line">	      ++n;</span><br><span class="line">	   &#125;</span><br><span class="line">	   return n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function clear() &#123;</span><br><span class="line">	   // for  (var key in Object.keys(this.datastore)) &#123;</span><br><span class="line">	   //    delete this.datastore[key];</span><br><span class="line">	   // &#125; </span><br><span class="line">	   delete this.datastore;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//测试</span><br><span class="line">	var dic=new Dictionary();</span><br><span class="line">	dic.add(&quot;123&quot;,&quot;R&quot;);</span><br><span class="line">	dic.add(&quot;456&quot;,&quot;Python&quot;);</span><br><span class="line">	dic.add(&quot;789&quot;,&quot;JavaScipt&quot;);</span><br><span class="line">	document.write(&quot;&lt;/br&gt;**************字典数目**************&lt;/br&gt;&quot;);</span><br><span class="line">	var n=dic.count();</span><br><span class="line">	document.write(n);</span><br><span class="line">	document.write(&quot;&lt;/br&gt;**************全部显示**************&lt;/br&gt;&quot;);</span><br><span class="line">	dic.showAll();</span><br><span class="line">	document.write(&quot;&lt;/br&gt;**************删除123---&gt;R*************&lt;/br&gt;&quot;);</span><br><span class="line">	dic.remove(&quot;123&quot;);</span><br><span class="line">	dic.showAll();</span><br><span class="line">	document.write(&quot;&lt;/br&gt;**************清除**************&lt;/br&gt;&quot;);</span><br><span class="line">	dic.clear();</span><br><span class="line">	dic.showAll();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-散列（HashTable）"><a href="#6-2-散列（HashTable）" class="headerlink" title="6.2 散列（HashTable）"></a>6.2 散列（HashTable）</h2><p>它通过把关键码值映射到表中一个位置来访问记录，以加快查找的速度<br>使用：MD5 和 SHA-1 可以说是目前应用最广泛的Hash算法<br>    java中已经实现<br><img src="http://img.blog.csdn.net/20151110094955099" alt="这里写图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;HashTable散列表&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function HashTable() &#123;</span><br><span class="line">	   this.table = new Array(137); //为了避免碰撞，首先要确保散列表中用来存储数据的数组其大小是个质数。这一点很关</span><br><span class="line">键，这和计算散列值时使用的取余运算有关。</span><br><span class="line">	   this.simpleHash = simpleHash;   //简单的散列表</span><br><span class="line">	   this.betterHash = betterHash;   //更好的HashTable，避免碰撞</span><br><span class="line">	   this.showDistro = showDistro;</span><br><span class="line">	   this.put = put;</span><br><span class="line">	   //this.get = get;</span><br><span class="line">	&#125;</span><br><span class="line">	function put(data) &#123;</span><br><span class="line">	   var pos = this.simpleHash(data);</span><br><span class="line">	   this.table[pos] = data;</span><br><span class="line">	&#125;</span><br><span class="line">	   </span><br><span class="line">	function simpleHash(data) &#123;</span><br><span class="line">	   var total = 0;</span><br><span class="line">	   for (var i = 0; i &lt; data.length; ++i) &#123;</span><br><span class="line">	      total += data.charCodeAt(i);</span><br><span class="line">	   &#125;</span><br><span class="line">	   document.write(&quot;Hash value: &quot; + data + &quot; -&gt; &quot; + total+&quot;&lt;br/&gt;&quot;);</span><br><span class="line">	   return total % this.table.length;</span><br><span class="line">	&#125;</span><br><span class="line">	function showDistro() &#123;</span><br><span class="line">	   var n = 0;</span><br><span class="line">	   for (var i = 0; i &lt; this.table.length; ++i) &#123;</span><br><span class="line">	      if (this.table[i] != undefined) &#123;</span><br><span class="line">	         document.write(i + &quot;: &quot; + this.table[i]+&quot;&lt;br/&gt;&quot;);</span><br><span class="line">	      &#125;</span><br><span class="line">	   &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	function betterHash(string) &#123;</span><br><span class="line">	   const H = 31;  //较小的质数  书上37不行 </span><br><span class="line">	   var total = 0;</span><br><span class="line">	   for (var i = 0; i &lt; string.length; ++i) &#123;</span><br><span class="line">	      total += H * total + string.charCodeAt(i);</span><br><span class="line">	   &#125;</span><br><span class="line">	   total = total % this.table.length;</span><br><span class="line">	   if (total &lt; 0) &#123;</span><br><span class="line">	      total += this.table.length-1;</span><br><span class="line">	   &#125;</span><br><span class="line">	   return parseInt(total);</span><br><span class="line">	&#125;</span><br><span class="line">	var someNames = [&quot;David&quot;, &quot;Jennifer&quot;, &quot;Donnie&quot;, &quot;Raymond&quot;,</span><br><span class="line">                 &quot;Cynthia&quot;, &quot;Mike&quot;, &quot;Clayton&quot;, &quot;Danny&quot;, &quot;Jonathan&quot;];</span><br><span class="line">	var hTable = new HashTable();</span><br><span class="line">	</span><br><span class="line">	for (var i = 0; i &lt; someNames.length; ++i) &#123;</span><br><span class="line">  		 hTable.put(someNames[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	hTable.showDistro();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20151110095013990" alt="这里写图片描述"><br>这就是碰撞，为避免碰撞，使用betterHash<br>修改：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">	   <span class="comment">// var pos = this.simpleHash(data);</span></span><br><span class="line">	   <span class="keyword">var</span> pos = <span class="keyword">this</span>.betterHash(data);</span><br><span class="line">	   <span class="keyword">this</span>.table[pos] = data;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/09/javascript数据结构8-图（Graph）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/09/javascript数据结构8-图（Graph）/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">javascript数据结构8-图（Graph）</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-09 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-09T00:00:00+08:00">2016-10-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:57:44" itemprop="dateModified" datetime="2018-11-30T10:57:44+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/数据结构/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> <strong>图（graph）</strong><br>图由边的集合及顶点的集合组成<br><strong>有向图：</strong><br><img src="http://img.blog.csdn.net/20151208125116430" alt="有向图"><br><strong>无向图：</strong><br><img src="http://img.blog.csdn.net/20151208125202948" alt="这里写图片描述"><br><strong>代码：</strong>        </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;Graph&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function Graph(v)&#123;</span><br><span class="line">      	this.vertices=v;</span><br><span class="line">      	this.edges=0;</span><br><span class="line">      	this.adj=[];</span><br><span class="line">     	for(var i=0;i&lt;this.vertices;++i)&#123;</span><br><span class="line">        	this.adj[i]=[];</span><br><span class="line">          // this.adj[i].push(&quot;&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      	this.addEdge=addEdge;</span><br><span class="line">      	this.showGraph=showGraph;</span><br><span class="line">      </span><br><span class="line">      //深度优先搜索</span><br><span class="line">      this.dfs=dfs;</span><br><span class="line">      this.marked=[];</span><br><span class="line">      for(var i=0;i&lt;this.vertices;++i)&#123;</span><br><span class="line">        	this.marked[i]=false;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 广度搜索</span><br><span class="line">      this.bfs=bfs;</span><br><span class="line">      	</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">	//   增加顶点</span><br><span class="line">  	function addEdge(v,w)&#123;</span><br><span class="line">      	this.adj[v].push(w);</span><br><span class="line">      	this.adj[w].push(v);</span><br><span class="line">		    this.edges++;      </span><br><span class="line">    &#125;</span><br><span class="line">  	</span><br><span class="line">  	//遍历</span><br><span class="line">  	function showGraph()&#123;</span><br><span class="line">      	for(var i=0;i&lt;this.vertices;++i)&#123;</span><br><span class="line">          	document.write(&apos;&lt;br/&gt;&apos;);</span><br><span class="line">          	document.write(i+&quot;--&gt;&quot;);</span><br><span class="line">          	for(var j=0;j&lt;this.vertices;++j)&#123;</span><br><span class="line">              	if(this.adj[i][j]!=undefined)&#123;</span><br><span class="line">                  	document.write(this.adj[i][j]+&apos; &apos;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	//深度优先搜索</span><br><span class="line">  	function dfs(v)&#123;</span><br><span class="line">  		//var w;</span><br><span class="line">  		this.marked[v]=true;</span><br><span class="line">    	if(this.adj[v]!=undefined)&#123;</span><br><span class="line">        	document.write(&quot;&lt;br/&gt;访问的节点:&quot;+v);</span><br><span class="line">      &#125;</span><br><span class="line">      // for(var w in this.adj[v])&#123;</span><br><span class="line">      //console.log(this.adj[0].length);    </span><br><span class="line">          var w=this.adj[v].shift();</span><br><span class="line">          while(w!=undefined)&#123;</span><br><span class="line">              if(!this.marked[w])&#123;</span><br><span class="line">              	this.dfs(w);</span><br><span class="line">              &#125;</span><br><span class="line">              w=this.adj[v].shift();</span><br><span class="line">          &#125;</span><br><span class="line">     </span><br><span class="line">          //console.log(w);</span><br><span class="line">          //console.log(this.adj[v]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 广度搜索</span><br><span class="line">    function bfs(s)&#123;</span><br><span class="line">        var queue=[];</span><br><span class="line">        this.marked[s]=true;</span><br><span class="line">        queue.push(s);//添加到队尾</span><br><span class="line">        var w;  //存放邻接表</span><br><span class="line">        while(queue.length&gt;0)&#123;</span><br><span class="line"></span><br><span class="line">           var v=queue.shift();//从队首删除</span><br><span class="line">           if(v!=undefined)&#123;</span><br><span class="line">              document.write(&quot;&lt;br/&gt;访问的节点:&quot;+v);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">             w=this.adj[v].shift();</span><br><span class="line">             while(w!=undefined)&#123;</span><br><span class="line">                if(!this.marked[w])&#123;</span><br><span class="line">                    this.marked[w]=true;</span><br><span class="line">                    queue.push(w);</span><br><span class="line">                &#125;</span><br><span class="line">                 w=this.adj[v].shift();</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  	//测试</span><br><span class="line">  	var  graph=new Graph(5);</span><br><span class="line">  	graph.addEdge(0,1);  </span><br><span class="line">  	graph.addEdge(0,2);  </span><br><span class="line">  	graph.addEdge(1,3);  </span><br><span class="line">  	graph.addEdge(2,4);  </span><br><span class="line">    //console.log(graph);</span><br><span class="line">  	//console.log(graph.adj);</span><br><span class="line">  	graph.showGraph();</span><br><span class="line">    document.write(&quot;&lt;br/&gt;&quot;);</span><br><span class="line">    document.write(&quot;======深度度优先搜索=====&quot;);</span><br><span class="line">    graph.dfs(0);</span><br><span class="line">    document.write(&quot;&lt;br/&gt;&quot;);</span><br><span class="line">    document.write(&quot;======广度优先搜索=====&quot;);</span><br><span class="line">    var  graph1=new Graph(5);</span><br><span class="line">    graph1.addEdge(0,1);  </span><br><span class="line">    graph1.addEdge(0,2);  </span><br><span class="line">    graph1.addEdge(1,3);  </span><br><span class="line">    graph1.addEdge(2,4);  </span><br><span class="line">    graph1.bfs(0);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><strong>运行结果：</strong></p>
<blockquote>
</blockquote>
<p>0–&gt;1 2<br>1–&gt;0 3<br>2–&gt;0 4<br>3–&gt;1<br>4–&gt;2<br>======深度度优先搜索=====<br>访问的节点:0<br>访问的节点:1<br>访问的节点:3<br>访问的节点:2<br>访问的节点:4<br>======广度优先搜索=====<br>访问的节点:0<br>访问的节点:1<br>访问的节点:2<br>访问的节点:3<br>访问的节点:4            </p>
<p>深度搜索的含义：<br><img src="http://img.blog.csdn.net/20151208125306927" alt="深度搜索"><br>广度搜索的含义：<br><img src="http://img.blog.csdn.net/20151208125325697" alt="广度搜索"></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/10/09/javascript数据结构7-二叉搜索树（BST）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/09/javascript数据结构7-二叉搜索树（BST）/" class="post-title-link" itemprop="https://zrysmt.github.io/page/4/index.html">javascript数据结构7-二叉搜索树（BST）</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-09 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-09T00:00:00+08:00">2016-10-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:57:44" itemprop="dateModified" datetime="2018-11-30T10:57:44+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/数据结构/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="二叉树-："><a href="#二叉树-：" class="headerlink" title="二叉树 ："></a>二叉树 ：</h2><p><img src="http://img.blog.csdn.net/20151110101942285" alt="这里写图片描述"></p>
<p>闲话少说，直接上代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;BST&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  //结点</span><br><span class="line">    function Node(data,left,right)&#123;</span><br><span class="line">        this.data=data;</span><br><span class="line">        this.left=left;</span><br><span class="line">        this.right=right;</span><br><span class="line">        this.floor=floor;  //层数</span><br><span class="line">        this.show=show;</span><br><span class="line">    &#125;</span><br><span class="line">    function floor()&#123;</span><br><span class="line">      return this.floor;</span><br><span class="line">    &#125;</span><br><span class="line">    function show()&#123;</span><br><span class="line">        return this.data;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    function BST()&#123;</span><br><span class="line">        this.root=null;</span><br><span class="line">        this.insert=insert; //插入数据</span><br><span class="line">        this.inOrder=inOrder; //中序排列，详细见后面解释</span><br><span class="line">        this.preOrder=preOrder; //先序排序</span><br><span class="line">        this.postOrder=postOrder; //后续排序</span><br><span class="line">        this.getMax=getMax; //得到最大值</span><br><span class="line">      	this.getMin=getMin; //得到最小值</span><br><span class="line">      	this.find=find; //查找</span><br><span class="line">      	this.remove=remove; //删除节点</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function insert(data)&#123;</span><br><span class="line">       var n=new Node(data,null,null);</span><br><span class="line">        if(this.root==null)&#123;</span><br><span class="line">            this.root=n;</span><br><span class="line">            this.root.floor=1;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            var current=this.root;</span><br><span class="line">            var parent;</span><br><span class="line">                var c=1;    </span><br><span class="line">            while(true)&#123;</span><br><span class="line">                parent=current;  </span><br><span class="line">                if(data&lt;current.data)&#123;</span><br><span class="line">                        current=current.left;</span><br><span class="line">                        c++;  //计算层数的计数器加1</span><br><span class="line">                    if(current==null)&#123;</span><br><span class="line">                        parent.left=n;</span><br><span class="line">                        parent.left.floor=c;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    current=current.right;</span><br><span class="line">                        c++;   //加1</span><br><span class="line">                    if(current==null)&#123;</span><br><span class="line">                        parent.right=n;</span><br><span class="line">                        //rHeight++;</span><br><span class="line">                        // console.log(&quot;**&quot;+rHeight+&quot;**&quot;);</span><br><span class="line">                        parent.right.floor=c;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  //中序遍历</span><br><span class="line">  function inOrder(node)&#123;</span><br><span class="line">      if(!(node==null))&#123;</span><br><span class="line">          inOrder(node.left);</span><br><span class="line">          document.write(node.show()+&quot; &quot;);</span><br><span class="line">          document.write(&quot;层数&quot;+node.floor+&quot;&lt;br/&gt;&quot;);</span><br><span class="line">          inOrder(node.right);</span><br><span class="line">      &#125;</span><br><span class="line">       //console.count(&quot;inOrder被执行的次数&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  //先序遍历</span><br><span class="line">   function preOrder(node)&#123;</span><br><span class="line">      if(!(node==null))&#123;</span><br><span class="line">          document.write(node.show()+&quot; &quot;);</span><br><span class="line">          preOrder(node.left);</span><br><span class="line">          preOrder(node.right);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //后序遍历</span><br><span class="line">   function postOrder(node)&#123;</span><br><span class="line">      if(!(node==null))&#123;</span><br><span class="line">          postOrder(node.left);        </span><br><span class="line">          postOrder(node.right);</span><br><span class="line">            document.write(node.show()+&quot; &quot;);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //查找最大值</span><br><span class="line">  function getMax()&#123;</span><br><span class="line">     	var current=this.root;</span><br><span class="line">    	while(!(current.right==null))&#123;</span><br><span class="line">          	current=current.right;</span><br><span class="line">        &#125;</span><br><span class="line">    	return current.data;</span><br><span class="line">  &#125;</span><br><span class="line">  //查找最小值</span><br><span class="line">   function getMin()&#123;</span><br><span class="line">     	var current=this.root;</span><br><span class="line">    	while(!(current.left==null))&#123;</span><br><span class="line">          	current=current.left;</span><br><span class="line">        &#125;</span><br><span class="line">    	return current.data;</span><br><span class="line">  &#125;</span><br><span class="line">  //带参数---查找最小值</span><br><span class="line">  function getSmallest(node)&#123;</span><br><span class="line">  		while(!(node.left==null))&#123;</span><br><span class="line">  			node=node.left;</span><br><span class="line">  		&#125;</span><br><span class="line">  	 return node;</span><br><span class="line">  &#125;</span><br><span class="line">  //查找</span><br><span class="line">  function find(data)&#123;</span><br><span class="line">    	var current=this.root;</span><br><span class="line">    	while(current!=null)&#123;</span><br><span class="line">          	if(current.data==data)&#123;</span><br><span class="line">              document.write(&quot;&lt;br/&gt;找到【&quot;+data+&quot;】节点&lt;br/&gt;&quot;);</span><br><span class="line">              return current;</span><br><span class="line">            &#125;else if(data&lt;current.data)&#123;</span><br><span class="line">               current=current.left;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">               current=current.right;</span><br><span class="line">            &#125;</span><br><span class="line">         </span><br><span class="line">        &#125;</span><br><span class="line">     document.write(&quot;&lt;br/&gt;没有找到【&quot;+data+&quot;】 节点&lt;br/&gt;&quot;);</span><br><span class="line">//     	return current;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //删除节点-详细解释见后后面</span><br><span class="line">     function remove(data) &#123;</span><br><span class="line">			root = removeNode(this.root, data);</span><br><span class="line">       		//其实root=没有用处，只是保留了函数执行的地址</span><br><span class="line">	&#125;</span><br><span class="line">	function removeNode(node, data) &#123;</span><br><span class="line">          if (node == null) &#123;</span><br><span class="line">				return null;</span><br><span class="line">			&#125;</span><br><span class="line">		if (data == node.data) &#123;</span><br><span class="line">			// 没有子节点的节点</span><br><span class="line">			if (node.left == null &amp;&amp; node.right == null) &#123;</span><br><span class="line">					return null;</span><br><span class="line">			&#125;</span><br><span class="line">			// 没有左子节点的节点</span><br><span class="line">			if (node.left == null) &#123;</span><br><span class="line">					return node.right;</span><br><span class="line">			&#125;</span><br><span class="line">			// 没有右子节点的节点</span><br><span class="line">			if (node.right == null) &#123;</span><br><span class="line">					return node.left;</span><br><span class="line">			&#125;</span><br><span class="line">			// 有两个子节点的节点</span><br><span class="line">			var tempNode = getSmallest(node.right);</span><br><span class="line">			node.data = tempNode.data;</span><br><span class="line">			node.right = removeNode(node.right, tempNode.data);</span><br><span class="line">					return node;</span><br><span class="line">			&#125;</span><br><span class="line">			else if (data &lt; node.data) &#123;</span><br><span class="line">				node.left = removeNode(node.left, data);</span><br><span class="line">               </span><br><span class="line">				return node;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				node.right = removeNode(node.right, data);</span><br><span class="line">              // console.log(node);</span><br><span class="line">				return node;</span><br><span class="line">			&#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  //测试</span><br><span class="line">      var nums=new BST();</span><br><span class="line">      nums.insert(56);</span><br><span class="line">      nums.insert(22);  </span><br><span class="line">      nums.insert(81);</span><br><span class="line">      nums.insert(10);</span><br><span class="line">      nums.insert(30);</span><br><span class="line">      nums.insert(77);</span><br><span class="line">      nums.insert(92);</span><br><span class="line">      nums.insert(100);</span><br><span class="line">      document.write(&quot;*****************中序遍历***************&lt;/br&gt;&quot;);</span><br><span class="line">      inOrder(nums.root);</span><br><span class="line">      document.write(&quot;&lt;/br&gt;***************先序遍历***************&lt;/br&gt;&quot;);</span><br><span class="line">      preOrder(nums.root);</span><br><span class="line">      document.write(&quot;&lt;/br&gt;***************后序遍历***************&lt;/br&gt;&quot;);</span><br><span class="line">      postOrder(nums.root);</span><br><span class="line">      //nums.show();</span><br><span class="line">      //console.log(nums);  </span><br><span class="line">      document.write(&quot;&lt;/br&gt;***************最大值/最小值************&lt;/br&gt;&quot;);</span><br><span class="line">      document.write(nums.getMax()+&quot;/&quot;+nums.getMin());</span><br><span class="line">      document.write(&quot;&lt;/br&gt;***************查找************&lt;/br&gt;&quot;);</span><br><span class="line">  	  nums.find(100);</span><br><span class="line">      document.write(&quot;&lt;/br&gt;***************删除节点81后************&lt;/br&gt;&quot;);</span><br><span class="line">      nums.remove(81);</span><br><span class="line">      console.log(nums);</span><br><span class="line">      preOrder(nums.root);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>结果：<br><img src="http://img.blog.csdn.net/20151110102901708" alt="这里写图片描述"></p>
<h2 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h2><p>中序遍历：<br><img src="http://img.blog.csdn.net/20151110102019745" alt="这里写图片描述"><br>理解双层递归</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inOrder</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(node == <span class="literal">null</span>)) &#123;</span><br><span class="line">        inOrder(node.left);                             <span class="comment">//@1</span></span><br><span class="line">        <span class="built_in">document</span>.document(node.show() + <span class="string">" "</span>);           <span class="comment">//@2</span></span><br><span class="line">        inOrder(node.right);                            <span class="comment">//@3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inOrder(nums.root);    <span class="comment">//开始执行</span></span><br></pre></td></tr></table></figure>
<p>从根节点开始：<br><img src="http://img.blog.csdn.net/20151110102238331" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20151110102715132" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20151110102731867" alt="这里写图片描述"></p>
<h2 id="删除节点："><a href="#删除节点：" class="headerlink" title="删除节点："></a>删除节点：</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">		root = removeNode(<span class="keyword">this</span>.root, data);  </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>简单接受待删除的数据，具体执行是removeNode函数；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeNode</span>(<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><strong>待删除的节点是：</strong><br><strong>1.叶子结点</strong>，只需要将从父节点只想它的链接指向null；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (node.left == <span class="literal">null</span> &amp;&amp; node.right == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;   </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (node.left == <span class="literal">null</span> &amp;&amp; node.right == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;   <span class="comment">//递归，找到节点置为空即可</span></span><br><span class="line">			&#125;</span><br><span class="line">			   <span class="comment">//其他情况</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (data &lt; node.data) &#123;</span><br><span class="line">				node.left = removeNode(node.left, data);  <span class="comment">//#1            </span></span><br><span class="line">				<span class="keyword">return</span> node; <span class="comment">//#2</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				node.right = removeNode(node.right, data);<span class="comment">//#3</span></span><br><span class="line">				<span class="keyword">return</span> node; <span class="comment">//#4</span></span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<p>通过if else逻辑找到node节点</p>
<hr>
<pre><code>//#1  node.left=null(后面的函数递归后返回的值)
//#3  node.right=null(后面的函数递归后返回的值)
</code></pre><hr>
<p><strong>2.只包含一个子节点</strong>，原本指向它的节点指向它的子节点。<br><strong>3.左右子树都有的时候</strong>。两种做法：找到左子树的最大值或者右子树的最小值。这里我们用第二种。</p>
<ul>
<li>查找右子树的最小值，创建一个临时的节点tempNode。</li>
<li>将临时节点的值赋值给待删除节点</li>
<li>删除临时节点</li>
</ul>
<p>注意：</p>
<hr>
<p>//#2 //#4必须有，如果没有，则删除节点下面的所有子树都将被删除。<br>真个过程举个形象的说明，遍历的时候把节点之间的链条解开进行查询，return node；递归查询到最后一级后，由下向上对链条进行缝合。</p>
<hr>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ruyi Zhao</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">70</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">52</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ruyi Zhao</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
