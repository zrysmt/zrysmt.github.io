<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="漫漫技术路">
<meta property="og:url" content="https://zrysmt.github.io/page/7/index.html">
<meta property="og:site_name" content="漫漫技术路">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="漫漫技术路">






  <link rel="canonical" href="https://zrysmt.github.io/page/7/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>漫漫技术路</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">漫漫技术路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/28/WebRTC1-原理探究/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/28/WebRTC1-原理探究/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">WebRTC1-原理探究</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-28 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-28T00:00:00+08:00">2016-09-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:06:50" itemprop="dateModified" datetime="2018-11-30T11:06:50+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-抛砖引玉"><a href="#1-抛砖引玉" class="headerlink" title="1.抛砖引玉"></a>1.抛砖引玉</h3><p><code>WebRTC (Web Real-Time Communications)</code> 是一项实时通讯技术，它允许网络应用或者站点，在不借助中间媒介的情况下，建立浏览器之间点对点（Peer-to-Peer）的连接，实现视频流或/和音频流或者其他任意数据的传输<br>实时查看WebRTC在浏览器中的支持情况： <a href="http://caniuse.com/#search=webRTC" target="_blank" rel="noopener">http://caniuse.com/#search=webRTC</a><br>FirFox 45+,Chrome 29+,Oprea 36+,Edge 14+,Android Brower 50+支持，其余支持情况有问题。   </p>
<p>备注：有的时候会使用<code>adapter.js</code>，这个js文件是为了提高兼容性，可以直接使用API 不用加前缀<br>使用：  </p>
<ul>
<li>下载  </li>
<li>引用 <code>&lt;script src=&quot;adapter.js&quot;&gt;</code><blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/adapter.js" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/adapter.js</a>  </p>
</blockquote>
</li>
</ul>
<p><strong>几个概念</strong>   </p>
<ul>
<li><em>SDP(Session Description Protocol)</em><br>SDP是一种会话描述协议，用来描述双方的IP地址和端口号，通信所使用的带宽，会话的名称、标识符、激活时间，双方所要传输的媒体类型（视频、音频、文本）、媒体格式等等。该协议仅包含所要传递的媒体的描述信息，而不直接传递媒体内容。             </li>
<li><em>ICE（Interactive Connectivity Establishment）</em><br>ICE是一种以UDP为基础用于实现穿越NAT网管或者防火墙的协议。              </li>
<li><em>TURN&amp;&amp;STUN</em><br>两种协议都是用来明确自己的外网地址的，差别是如果要服务器辅助进行数据交换则设置TURN服务器，不需要则设置STUN服务。           </li>
</ul>
<p><strong>核心API</strong>    </p>
<ul>
<li><em>Navigator.getUserMedia</em><br>用来获取视频和音频，在浏览器装有摄像头和麦克风的情况下使用.<code>navigator.getUserMedia(constraints, successCallback, errorCallback)</code>；constraints是用来控制视频和音频是否获取，一般设为{video:true,audio: true}，即视频和音频都获取。      </li>
<li><em>RTCPeerConnection</em><br>RTCPeerConnection是一个表示两个浏览器端的连接的对象，其含有关于这个连接的所有信息和相关方法，是WebRTC的核心API，负责制作建立连接的SDP、ICE等报文，管理连接状态等等。      </li>
<li><em>RTCDataChannel</em><br>RTCDataChannel由RTCPeerConnection创建，需要传递视频、音频以外的数据时使用，它代表浏览器两端间的一个数据通道，和这个数据通道有关的属性和方法都记录在这个对象里。 </li>
</ul>
<h3 id="2-按图索骥"><a href="#2-按图索骥" class="headerlink" title="2.按图索骥"></a>2.按图索骥</h3><p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webRTC.png" alt=""><br> <strong>过程:</strong>    </p>
<ol>
<li>首先双方都建立一个RTCPeerConnection的实例，其中一方（称为offer方）用<code>RTCPeerConnection.createOffer()</code>创建一个会话描述<code>sessionDescription</code>，该会话描述包含SDP报文信息和该sessionDescription的类型(type)    </li>
<li>接下来调用<code>RTCPeerConnection.setLocalDescription()</code>方法将本地的<code>localDescription</code>设置为刚才创建的<code>sessionDescription</code>。之后将创建的<code>sessionDescription</code>发送给对方（称为answer方），发送方式没有规定，可以通过服务器中转，可以通过IM软件发送(这里使用WebSocket信令服务器)。    </li>
<li>answer端接收到<code>sessionDescription</code>后调用<code>RTCPeerConnection. setRemoteDescription</code>方法设置,然后调用<code>RTCPeerConnection. createAnswer</code>方法产生自己的<code>sessionDescription</code>。    </li>
<li>再将创建的<code>sessionDescription</code>发送给offfer方，同样发送方式没有规定。offer方接收到<code>sessionDescrip</code>后调用<code>RTCPeerConnection. setRemoteDescription</code>方法设置，这样双方的SDP信息就交换完成了。   </li>
<li>在完成SDP的交换后双方还要交换ICE candidate信息。双方首先设置<code>RTCPeerConnection.onicecandidate</code>回调函数，当candidate可用时，双方中的一方将所有<code>icecandidate</code>发送给对方，发送方式同样没有规定，接收方调用<code>RTCPeerConnection.addIceCandidate</code>方法接收candidate信息。经过这些步骤后双方连接就建立完成了。   </li>
</ol>
<h3 id="3-纸上可谈兵"><a href="#3-纸上可谈兵" class="headerlink" title="3.纸上可谈兵"></a>3.纸上可谈兵</h3><h4 id="3-1-由简入繁"><a href="#3-1-由简入繁" class="headerlink" title="3.1.由简入繁"></a>3.1.由简入繁</h4><p>html文件<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"keywords"</span> <span class="attr">content</span>=<span class="string">"JavaScript, WebRTC"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"WebRTC"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>获取本地视频<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"simpleVideo.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;video /&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'../lib/adapter.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"simpleVideo.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>js文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> constraints = &#123;</span><br><span class="line">    video: <span class="literal">true</span>,</span><br><span class="line">    audio:<span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">successCallback</span>(<span class="params">stream</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">window</span>.stream = stream; <span class="comment">// stream available to console</span></span><br><span class="line">    <span class="built_in">console</span>.log(stream);</span><br><span class="line">    <span class="built_in">console</span>.log(stream.getVideoTracks());</span><br><span class="line">    <span class="built_in">console</span>.log(stream.getAudioTracks());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> video = <span class="built_in">document</span>.querySelector(<span class="string">"video"</span>);</span><br><span class="line">    video.src = <span class="built_in">window</span>.URL.createObjectURL(stream);</span><br><span class="line">    video.play();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">errorCallback</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"getUserMedia error: "</span>, error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getUserMedia(constraints, successCallback, errorCallback);</span><br></pre></td></tr></table></figure></p>
<h4 id="3-2-顺藤摸瓜"><a href="#3-2-顺藤摸瓜" class="headerlink" title="3.2.顺藤摸瓜"></a>3.2.顺藤摸瓜</h4><p>这是个完整的例子，参照<code>2.按图索骥</code>部分理解<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"keywords"</span> <span class="attr">content</span>=<span class="string">"JavaScript, WebRTC"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"WebRTC codelab"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebRTC codelab: step 2<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"css/index.css"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- css可以使用一些滤镜效果 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'js/lib/adapter.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">"localVideo"</span> <span class="attr">autoplay</span> <span class="attr">muted</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">"remoteVideo"</span> <span class="attr">autoplay</span> <span class="attr">muted</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"startButton"</span>&gt;</span>Start<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"callButton"</span>&gt;</span>Call<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"hangupButton"</span>&gt;</span>Hang Up<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"index.js"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p><code>index.js</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   <span class="keyword">var</span> localStream, localPeerConnection, remotePeerConnection;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> localVideo = <span class="built_in">document</span>.getElementById(<span class="string">"localVideo"</span>);</span><br><span class="line">   <span class="keyword">var</span> remoteVideo = <span class="built_in">document</span>.getElementById(<span class="string">"remoteVideo"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> startButton = <span class="built_in">document</span>.getElementById(<span class="string">"startButton"</span>);</span><br><span class="line">   <span class="keyword">var</span> callButton = <span class="built_in">document</span>.getElementById(<span class="string">"callButton"</span>);</span><br><span class="line">   <span class="keyword">var</span> hangupButton = <span class="built_in">document</span>.getElementById(<span class="string">"hangupButton"</span>);</span><br><span class="line">   startButton.disabled = <span class="literal">false</span>;</span><br><span class="line">   callButton.disabled = <span class="literal">true</span>;</span><br><span class="line">   hangupButton.disabled = <span class="literal">true</span>;</span><br><span class="line">   startButton.onclick = start;</span><br><span class="line">   callButton.onclick = call;</span><br><span class="line">   hangupButton.onclick = hangup;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">trace</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log((performance.now() / <span class="number">1000</span>).toFixed(<span class="number">3</span>) + <span class="string">": "</span> + text);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">gotStream</span>(<span class="params">stream</span>) </span>&#123;</span><br><span class="line">       trace(<span class="string">"Received local stream"</span>);</span><br><span class="line">       localVideo.src = URL.createObjectURL(stream);</span><br><span class="line">       localStream = stream;</span><br><span class="line">       callButton.disabled = <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       trace(<span class="string">"Requesting local stream"</span>);</span><br><span class="line">       startButton.disabled = <span class="literal">true</span>;</span><br><span class="line">       getUserMedia(&#123;</span><br><span class="line">               audio: <span class="literal">true</span>,</span><br><span class="line">               video: <span class="literal">true</span></span><br><span class="line">           &#125;, gotStream,</span><br><span class="line">           <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">               trace(<span class="string">"getUserMedia error: "</span>, error);</span><br><span class="line">           &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       callButton.disabled = <span class="literal">true</span>;</span><br><span class="line">       hangupButton.disabled = <span class="literal">false</span>;</span><br><span class="line">       trace(<span class="string">"Starting call"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (localStream.getVideoTracks().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           trace(<span class="string">'Using video device: '</span> + localStream.getVideoTracks()[<span class="number">0</span>].label);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (localStream.getAudioTracks().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           trace(<span class="string">'Using audio device: '</span> + localStream.getAudioTracks()[<span class="number">0</span>].label);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> servers = <span class="literal">null</span>;<span class="comment">//本机测试不用其他服务器</span></span><br><span class="line"></span><br><span class="line">       localPeerConnection = <span class="keyword">new</span> RTCPeerConnection(servers);<span class="comment">//offer方</span></span><br><span class="line">       trace(<span class="string">"Created local peer connection object localPeerConnection"</span>);</span><br><span class="line">       localPeerConnection.onicecandidate = gotLocalIceCandidate;<span class="comment">//offer方发送ICE</span></span><br><span class="line">       remotePeerConnection = <span class="keyword">new</span> RTCPeerConnection(servers);<span class="comment">//answe方</span></span><br><span class="line">       trace(<span class="string">"Created remote peer connection object remotePeerConnection"</span>);</span><br><span class="line">       remotePeerConnection.onicecandidate = gotRemoteIceCandidate;<span class="comment">//answer方发送ICE</span></span><br><span class="line">       remotePeerConnection.onaddstream = gotRemoteStream;<span class="comment">//设置视频流</span></span><br><span class="line"></span><br><span class="line">       localPeerConnection.addStream(localStream);</span><br><span class="line">       trace(<span class="string">"Added localStream to localPeerConnection"</span>);</span><br><span class="line">       localPeerConnection.createOffer(gotLocalDescription, handleError);<span class="comment">//作为offer，产生自己的SessionDescription【SD】信息</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">gotLocalDescription</span>(<span class="params">description</span>) </span>&#123;<span class="comment">//description是offer方的SD</span></span><br><span class="line">       localPeerConnection.setLocalDescription(description);</span><br><span class="line">       trace(<span class="string">"Offer from localPeerConnection: \n"</span> + description.sdp);</span><br><span class="line">       remotePeerConnection.setRemoteDescription(description);<span class="comment">//answer方接收offer的SD</span></span><br><span class="line">       remotePeerConnection.createAnswer(gotRemoteDescription, handleError);<span class="comment">//answer方发送自己的SD</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">gotRemoteDescription</span>(<span class="params">description</span>) </span>&#123;</span><br><span class="line">       remotePeerConnection.setLocalDescription(description);<span class="comment">//anwer方设置本身自己的SD</span></span><br><span class="line">       trace(<span class="string">"Answer from remotePeerConnection: \n"</span> + description.sdp);</span><br><span class="line">       localPeerConnection.setRemoteDescription(description);<span class="comment">//offer接收answer方的SD</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">hangup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       trace(<span class="string">"Ending call"</span>);</span><br><span class="line">       localPeerConnection.close();</span><br><span class="line">       remotePeerConnection.close();</span><br><span class="line">       localPeerConnection = <span class="literal">null</span>;</span><br><span class="line">       remotePeerConnection = <span class="literal">null</span>;</span><br><span class="line">       hangupButton.disabled = <span class="literal">true</span>;</span><br><span class="line">       callButton.disabled = <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">gotRemoteStream</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">       remoteVideo.src = URL.createObjectURL(event.stream);</span><br><span class="line">       trace(<span class="string">"Received remote stream"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">gotLocalIceCandidate</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (event.candidate) &#123;</span><br><span class="line">           remotePeerConnection.addIceCandidate(<span class="keyword">new</span> RTCIceCandidate(event.candidate));<span class="comment">//answer方接收ICE</span></span><br><span class="line">           trace(<span class="string">"Local ICE candidate: \n"</span> + event.candidate.candidate);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">gotRemoteIceCandidate</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (event.candidate) &#123;</span><br><span class="line">           localPeerConnection.addIceCandidate(<span class="keyword">new</span> RTCIceCandidate(event.candidate));<span class="comment">//offer方接收ICE</span></span><br><span class="line">           trace(<span class="string">"Remote ICE candidate: \n "</span> + event.candidate.candidate);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">   &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>另外加一些CSS可以很容易实现滤镜效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	<span class="selector-tag">video</span> &#123;</span><br><span class="line">    <span class="attribute">filter</span>: <span class="built_in">hue-rotate</span>(180deg) <span class="built_in">saturate</span>(200%);</span><br><span class="line">    <span class="attribute">-moz-filter</span>: <span class="built_in">hue-rotate</span>(180deg) <span class="built_in">saturate</span>(200%);</span><br><span class="line">    <span class="attribute">-webkit-filter</span>: <span class="built_in">hue-rotate</span>(180deg) <span class="built_in">saturate</span>(200%);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行这两段代码，就可以调出来本地视频窗口   </p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://bitbucket.org/webrtc/codelab" target="_blank" rel="noopener">强烈推荐的WebRTC入门教程</a><br><a href="https://sites.google.com/site/webrtc/" target="_blank" rel="noopener">google webRTC</a><br><a href="https://webrtc.org/" target="_blank" rel="noopener">WebRTC官网</a><br><a href="http://w3c.github.io/webrtc-pc/" target="_blank" rel="noopener">WebRTC-W3School</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API" target="_blank" rel="noopener">MDN-WebRTC</a></p>
<p><a href="https://segmentfault.com/a/1190000000436544" target="_blank" rel="noopener">WebRTC实践教程</a><br><a href="http://www.tuicool.com/articles/eYJvee" target="_blank" rel="noopener">使用WebRTC搭建前端视频聊天室——信令篇</a><br><a href="https://www.zhihu.com/question/25497090" target="_blank" rel="noopener">可以用WebRTC来做视频直播吗？-知乎</a><br><a href="https://shishimao.com/" target="_blank" rel="noopener">实时猫–WebRTC服务商</a>  </p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/28/openlayers 3实践与原理探究4.1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/28/openlayers 3实践与原理探究4.1/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">OpenLayers 3实践与原理探究4.1-ol3源码分析-底层基础</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-28 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-28T00:00:00+08:00">2016-09-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:01:09" itemprop="dateModified" datetime="2018-11-30T11:01:09+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/WebGIS/" itemprop="url" rel="index"><span itemprop="name">WebGIS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为下面的内容会分模块介绍源码，所以这里为了方便，首先介绍源码的目录结构<br>在OpenLayers 3官网的<a href="http://openlayers.org/download/" target="_blank" rel="noopener">下载页面</a>下载我们在开发工程中需要的文件(如：v3.17.1.zip)，注意如果需要编译源代码，需要下载包含编译功能的文件包：<a href="https://github.com/openlayers/ol3/releases" target="_blank" rel="noopener">https://github.com/openlayers/ol3/releases</a> 下载指定release版本的源码，注意是Source code (zip)或者Source code (tar.gz)。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/ol/ol3%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" alt="ol3源码目录结构.png"></p>
<ul>
<li><code>apidoc</code>是ol3的api文档，打开<code>ol.html</code>就可以在浏览器中离线使用，当然也可以在官网中查看api；</li>
<li><code>build</code>是ol3编译过的文件，工程开发中可以直接使用，下部分的案例是基于离线的源码的；</li>
<li><code>closure-library</code>是google的closure库文件夹；</li>
<li><code>css</code>里面只有<code>ol.css</code>一个文件，是定义ol3的全局样式，项目开发中需要引入；</li>
<li><code>doc</code>提供给我们一些的案例，打开<code>quickstart.html</code>即可看到快速开始的案例；</li>
<li><code>examples</code>是比较丰富的例子，和官网中的examples一样；</li>
<li><code>ol</code>就是我们要分析的源码文件夹；</li>
<li><code>ol.ext</code>是ol3所要使用的js库。</li>
</ul>
<p><code>ol/ol</code>文件夹下是我们分析的源码，分析基本思路：文件夹下的文件是公用的部分(A部分)，文件夹是分部分写的(B部分)。</p>
<h1 id="0-底层基础"><a href="#0-底层基础" class="headerlink" title="0.底层基础"></a>0.底层基础</h1><h2 id="0-1-ol-js"><a href="#0-1-ol-js" class="headerlink" title="0.1 ol.js"></a>0.1 <code>ol.js</code></h2><p>第一行就可以看出，<code>ol.js</code>提供全局的第一命名空间<code>ol</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goog.provide(<span class="string">'ol'</span>);</span><br></pre></td></tr></table></figure>
<p>唯一的一个方法是：继承</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ol.inherits = <span class="function"><span class="keyword">function</span>(<span class="params">childCtor, parentCtor</span>) </span>&#123;</span><br><span class="line">  childCtor.prototype = <span class="built_in">Object</span>.create(parentCtor.prototype);</span><br><span class="line">  childCtor.prototype.constructor = childCtor;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="0-2-object-js"><a href="#0-2-object-js" class="headerlink" title="0.2 object.js"></a>0.2 <code>object.js</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">goog.provide(<span class="string">'ol.Object'</span>);</span><br><span class="line">goog.provide(<span class="string">'ol.ObjectEvent'</span>);</span><br><span class="line">goog.provide(<span class="string">'ol.ObjectEventType'</span>);</span><br><span class="line"></span><br><span class="line">goog.require(<span class="string">'ol.Observable'</span>);</span><br><span class="line">goog.require(<span class="string">'ol.events'</span>);</span><br><span class="line">goog.require(<span class="string">'ol.events.Event'</span>);</span><br><span class="line">goog.require(<span class="string">'ol.object'</span>);</span><br></pre></td></tr></table></figure>
<p>ol命名空间下所有的基本对象，比如<code>map</code>对象，<code>feature</code>矢量地图对象，都应该建立在<code>ol.Object</code>基础上。如：</p>
<hr>
<p><code>map.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ol.Object.call(<span class="keyword">this</span>);</span><br><span class="line">ol.inherits(ol.Map, ol.Object);</span><br></pre></td></tr></table></figure>
<p><code>feature.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ol.Object.call(<span class="keyword">this</span>);</span><br><span class="line">ol.inherits(ol.Feature, ol.Object);</span><br></pre></td></tr></table></figure>
<hr>
<p>通过这行代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ol.inherits(ol.Object, ol.Observable);</span><br></pre></td></tr></table></figure></p>
<p>我们发现<code>ol.Object</code>继承<code>ol.Observable</code><br><code>Observable.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ol.inherits(ol.Observable, ol.events.EventTarget);</span><br></pre></td></tr></table></figure>
<p>我们发现<code>ol.Observable</code>继承<code>ol.EventTarget</code>；<br>这样，我们可以知道继承<code>ol.Object</code>后也就继承了基础事件<code>ol.events</code>。</p>
<h2 id="0-3-events-js"><a href="#0-3-events-js" class="headerlink" title="0.3 events.js"></a>0.3 <code>events.js</code></h2><p>ol3的基础事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">goog.provide(<span class="string">'ol.events'</span>);</span><br><span class="line">goog.provide(<span class="string">'ol.events.EventType'</span>);</span><br><span class="line">goog.provide(<span class="string">'ol.events.KeyCode'</span>);</span><br><span class="line"></span><br><span class="line">goog.require(<span class="string">'ol.object'</span>);</span><br></pre></td></tr></table></figure>
<p>提供的所有基础事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ol.events.EventType = &#123;</span><br><span class="line">  CHANGE: <span class="string">'change'</span>,</span><br><span class="line">  CLICK: <span class="string">'click'</span>,</span><br><span class="line">  DBLCLICK: <span class="string">'dblclick'</span>,</span><br><span class="line">  DRAGENTER: <span class="string">'dragenter'</span>,</span><br><span class="line">  DRAGOVER: <span class="string">'dragover'</span>,</span><br><span class="line">  DROP: <span class="string">'drop'</span>,</span><br><span class="line">  ERROR: <span class="string">'error'</span>,</span><br><span class="line">  KEYDOWN: <span class="string">'keydown'</span>,</span><br><span class="line">  KEYPRESS: <span class="string">'keypress'</span>,</span><br><span class="line">  LOAD: <span class="string">'load'</span>,</span><br><span class="line">  MOUSEDOWN: <span class="string">'mousedown'</span>,</span><br><span class="line">  MOUSEMOVE: <span class="string">'mousemove'</span>,</span><br><span class="line">  MOUSEOUT: <span class="string">'mouseout'</span>,</span><br><span class="line">  MOUSEUP: <span class="string">'mouseup'</span>,</span><br><span class="line">  MOUSEWHEEL: <span class="string">'mousewheel'</span>,</span><br><span class="line">  MSPOINTERDOWN: <span class="string">'mspointerdown'</span>,</span><br><span class="line">  RESIZE: <span class="string">'resize'</span>,</span><br><span class="line">  TOUCHSTART: <span class="string">'touchstart'</span>,</span><br><span class="line">  TOUCHMOVE: <span class="string">'touchmove'</span>,</span><br><span class="line">  TOUCHEND: <span class="string">'touchend'</span>,</span><br><span class="line">  WHEEL: <span class="string">'wheel'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们分析一下提供的几个方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ol.events.bindListener_ = <span class="function"><span class="keyword">function</span>(<span class="params">listenerObj</span>) </span>&#123;&#125;;</span><br><span class="line">ol.events.listen = <span class="function"><span class="keyword">function</span>(<span class="params">target, type, listener, opt_this, opt_once</span>) </span>&#123;&#125;;</span><br><span class="line">ol.events.unlisten = <span class="function"><span class="keyword">function</span>(<span class="params">target, type, listener, opt_this</span>) </span>&#123;&#125;;</span><br><span class="line">ol.events.unlistenAll = <span class="function"><span class="keyword">function</span>(<span class="params">target</span>) </span>&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>其中方法名末尾带有”_”为私有方法，不带的为提供出去的共有方法。</p>
<h2 id="0-4-math-js"><a href="#0-4-math-js" class="headerlink" title="0.4 math.js"></a>0.4 <code>math.js</code></h2><p>提供基础的数学运算方法，角度转化弧度函数如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ol.math.toRadians = <span class="function"><span class="keyword">function</span>(<span class="params">angleInDegrees</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> angleInDegrees * <span class="built_in">Math</span>.PI / <span class="number">180</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="0-5-animation-js"><a href="#0-5-animation-js" class="headerlink" title="0.5 animation.js"></a>0.5 <code>animation.js</code></h2><p>提供bounce、pan、rotate、zoom四种方法</p>
<h2 id="0-6-collection-js"><a href="#0-6-collection-js" class="headerlink" title="0.6 collection.js"></a>0.6 <code>collection.js</code></h2><p>对ol命名空间下的对象集合的操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">goog.provide(<span class="string">'ol.Collection'</span>);</span><br><span class="line">goog.provide(<span class="string">'ol.CollectionEvent'</span>);</span><br><span class="line">goog.provide(<span class="string">'ol.CollectionEventType'</span>);</span><br><span class="line"></span><br><span class="line">goog.require(<span class="string">'ol.events.Event'</span>);</span><br><span class="line">goog.require(<span class="string">'ol.Object'</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ol.CollectionEventType = &#123;</span><br><span class="line">  ADD: <span class="string">'add'</span></span><br><span class="line">  REMOVE: <span class="string">'remove'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>继承</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ol.inherits(ol.CollectionEvent, ol.events.Event);</span><br><span class="line">ol.inherits(ol.Collection, ol.Object);</span><br></pre></td></tr></table></figure>
<p>方法举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ol.Collection.prototype.remove = <span class="function"><span class="keyword">function</span>(<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = <span class="keyword">this</span>.array_;</span><br><span class="line">  <span class="keyword">var</span> i, ii;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, ii = arr.length; i &lt; ii; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (arr[i] === elem) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.removeAt(i);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="0-7-uri-js"><a href="#0-7-uri-js" class="headerlink" title="0.7 uri.js"></a>0.7 <code>uri.js</code></h2><p>通过url加载地图，其中<code>params</code>包含请求地图的宽、高、分辨率、地图范围</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ol.uri.appendParams = <span class="function"><span class="keyword">function</span>(<span class="params">uri, params</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> qs = <span class="built_in">Object</span>.keys(params).map(<span class="function"><span class="keyword">function</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> k + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(params[k]);</span><br><span class="line">  &#125;).join(<span class="string">'&amp;'</span>);</span><br><span class="line">  <span class="comment">// remove any trailing ? or &amp;</span></span><br><span class="line">  uri = uri.replace(<span class="regexp">/[?&amp;]$/</span>, <span class="string">''</span>);</span><br><span class="line">  <span class="comment">// append ? or &amp; depending on whether uri has existing parameters</span></span><br><span class="line">  uri = uri.indexOf(<span class="string">'?'</span>) === <span class="number">-1</span> ? uri + <span class="string">'?'</span> : uri + <span class="string">'&amp;'</span>;</span><br><span class="line">  <span class="keyword">return</span> uri + qs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/28/openlayers 3实践与原理探究4.4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/28/openlayers 3实践与原理探究4.4/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">OpenLayers 3实践与原理探究4.4-ol3源码分析-render</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-28 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-28T00:00:00+08:00">2016-09-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:01:09" itemprop="dateModified" datetime="2018-11-30T11:01:09+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/WebGIS/" itemprop="url" rel="index"><span itemprop="name">WebGIS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前面几节的内容介绍了<code>Map</code>,<code>View</code>,<code>Source</code>,<code>Layer</code>,这些其实我们都是要么在对象属性中设置 ，要么是通过方法设置，实质上是通过共享的全局变量设置地图包含的图层，地图的显示效果，但是如果真正上绘制在浏览器上，需要渲染在canvas(ol3常用的渲染方式).</p>
<p>由于源码代码量比较大，这里只是从大部分介绍流程。<br>网上有人(OpenLayers 3源码那些事)总结一张图的不错，这里拿来用一下<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/ol/ol3%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B.png" alt="ol3渲染流程"></p>
<h1 id="0-从map-js开始"><a href="#0-从map-js开始" class="headerlink" title="0.从map.js开始"></a>0.从<code>map.js</code>开始</h1><ul>
<li><strong>1) render/renderSync</strong><br>具体流程用注释的形式标出</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//renderSync是异步的，同样道理</span></span><br><span class="line">ol.Map.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.animationDelayKey_ === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.animationDelayKey_ = ol.global.requestAnimationFrame(</span><br><span class="line">        <span class="keyword">this</span>.animationDelay_);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>2) animationDelay_</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.animationDelay_ = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.animationDelayKey_ = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">this</span>.renderFrame_.call(<span class="keyword">this</span>, <span class="built_in">Date</span>.now());</span><br><span class="line">  &#125;.bind(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>3) renderFrame_</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">ol.Map.prototype.renderFrame_ = <span class="function"><span class="keyword">function</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> i, ii, viewState;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> size = <span class="keyword">this</span>.getSize();</span><br><span class="line">  <span class="keyword">var</span> view = <span class="keyword">this</span>.getView();</span><br><span class="line">  <span class="keyword">var</span> extent = ol.extent.createEmpty();</span><br><span class="line">  <span class="comment">/** @type &#123;?olx.FrameState&#125; */</span></span><br><span class="line">  <span class="keyword">var</span> frameState = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (size !== <span class="literal">undefined</span> &amp;&amp; ol.size.hasArea(size) &amp;&amp; view &amp;&amp; view.isDef()) &#123;</span><br><span class="line">    <span class="keyword">var</span> viewHints = view.getHints(<span class="keyword">this</span>.frameState_ ? <span class="keyword">this</span>.frameState_.viewHints : <span class="literal">undefined</span>);</span><br><span class="line">    <span class="keyword">var</span> layerStatesArray = <span class="keyword">this</span>.getLayerGroup().getLayerStatesArray();</span><br><span class="line">    <span class="keyword">var</span> layerStates = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, ii = layerStatesArray.length; i &lt; ii; ++i) &#123;</span><br><span class="line">      layerStates[goog.getUid(layerStatesArray[i].layer)] = layerStatesArray[i];</span><br><span class="line">    &#125;</span><br><span class="line">    viewState = view.getState();</span><br><span class="line">    frameState = <span class="comment">/** @type &#123;olx.FrameState&#125; */</span> (&#123;      <span class="comment">//1.准备frameState</span></span><br><span class="line">      animate: <span class="literal">false</span>,</span><br><span class="line">      attributions: &#123;&#125;,</span><br><span class="line">      coordinateToPixelMatrix: <span class="keyword">this</span>.coordinateToPixelMatrix_,</span><br><span class="line">      extent: extent,</span><br><span class="line">      focus: !<span class="keyword">this</span>.focus_ ? viewState.center : <span class="keyword">this</span>.focus_,</span><br><span class="line">      index: <span class="keyword">this</span>.frameIndex_++,</span><br><span class="line">      layerStates: layerStates,<span class="comment">//layer的常量属性，通过共享作为全局变量</span></span><br><span class="line">      layerStatesArray: layerStatesArray,</span><br><span class="line">      logos: ol.object.assign(&#123;&#125;, <span class="keyword">this</span>.logos_),</span><br><span class="line">      pixelRatio: <span class="keyword">this</span>.pixelRatio_,</span><br><span class="line">      pixelToCoordinateMatrix: <span class="keyword">this</span>.pixelToCoordinateMatrix_,</span><br><span class="line">      postRenderFunctions: [],</span><br><span class="line">      size: size,</span><br><span class="line">      skippedFeatureUids: <span class="keyword">this</span>.skippedFeatureUids_,</span><br><span class="line">      tileQueue: <span class="keyword">this</span>.tileQueue_,</span><br><span class="line">      time: time,</span><br><span class="line">      usedTiles: &#123;&#125;,</span><br><span class="line">      viewState: viewState,<span class="comment">//view的常量属性，通过共享作为全局变量</span></span><br><span class="line">      viewHints: viewHints,</span><br><span class="line">      wantedTiles: &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (frameState) &#123;</span><br><span class="line">    <span class="keyword">var</span> preRenderFunctions = <span class="keyword">this</span>.preRenderFunctions_;<span class="comment">//2.渲染前</span></span><br><span class="line">    <span class="keyword">var</span> n = <span class="number">0</span>, preRenderFunction;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, ii = preRenderFunctions.length; i &lt; ii; ++i) &#123;</span><br><span class="line">      preRenderFunction = preRenderFunctions[i];</span><br><span class="line">      <span class="keyword">if</span> (preRenderFunction(<span class="keyword">this</span>, frameState)) &#123;</span><br><span class="line">        preRenderFunctions[n++] = preRenderFunction;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    preRenderFunctions.length = n;</span><br><span class="line"></span><br><span class="line">    frameState.extent = ol.extent.getForViewAndSize(viewState.center,</span><br><span class="line">        viewState.resolution, viewState.rotation, frameState.size, extent);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.frameState_ = frameState;</span><br><span class="line">  <span class="keyword">this</span>.renderer_.renderFrame(frameState);                <span class="comment">//3.渲染</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (frameState) &#123;</span><br><span class="line">    <span class="keyword">if</span> (frameState.animate) &#123;</span><br><span class="line">      <span class="keyword">this</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Array</span>.prototype.push.apply(</span><br><span class="line">        <span class="keyword">this</span>.postRenderFunctions_, frameState.postRenderFunctions);<span class="comment">//4.渲染后</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> idle = <span class="keyword">this</span>.preRenderFunctions_.length === <span class="number">0</span> &amp;&amp;</span><br><span class="line">        !frameState.viewHints[ol.ViewHint.ANIMATING] &amp;&amp;</span><br><span class="line">        !frameState.viewHints[ol.ViewHint.INTERACTING] &amp;&amp;</span><br><span class="line">        !ol.extent.equals(frameState.extent, <span class="keyword">this</span>.previousExtent_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (idle) &#123;</span><br><span class="line">      <span class="keyword">this</span>.dispatchEvent(</span><br><span class="line">          <span class="keyword">new</span> ol.MapEvent(ol.MapEventType.MOVEEND, <span class="keyword">this</span>, frameState));</span><br><span class="line">      ol.extent.clone(frameState.extent, <span class="keyword">this</span>.previousExtent_);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.dispatchEvent(</span><br><span class="line">      <span class="keyword">new</span> ol.MapEvent(ol.MapEventType.POSTRENDER, <span class="keyword">this</span>, frameState));</span><br><span class="line"></span><br><span class="line">  goog.async.nextTick(<span class="keyword">this</span>.handlePostRender, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>下面讲诉的渲染的第3步 <code>renderFrame(frameState)</code></strong><br>有关渲染的源代码在<code>ol/ol/render</code>,<code>ol/ol/renderer</code>下。<br><code>ol/ol/render</code>文件夹下是渲染的基本属性和方法，利用设计模式中的工厂模式，用来构造<code>ol/ol/renderer</code>。</p>
<h1 id="1-渲染Map"><a href="#1-渲染Map" class="headerlink" title="1.渲染Map"></a>1.渲染Map</h1><p><code>ol/ol/renderer/maprenderer.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ol.renderer.Map = <span class="function"><span class="keyword">function</span>(<span class="params">container, map</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这只是个父类，具体实现类位置在：<br><code>ol/ol/renderer/canvas/canvasmaprenderer.js</code>–ol.render.canvas.Map(默认)<br><code>ol/ol/renderer/canvas/webglmaprenderer.js</code>–ol.render.webgl.Map<br><code>ol/ol/renderer/canvas/dommaprenderer.js</code>–ol.render.dom.Map</p>
<p>主要介绍第一种<code>ol/ol/renderer/canvas/canvasmaprenderer.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ol.renderer.canvas.Map = <span class="function"><span class="keyword">function</span>(<span class="params">container, map</span>) </span>&#123;</span><br><span class="line">	ol.renderer.Map.call(<span class="keyword">this</span>, container, map);</span><br><span class="line">	<span class="keyword">this</span>.context_ = ol.dom.createCanvasContext2D();</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">this</span>.canvas_ = <span class="keyword">this</span>.context_.canvas;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">this</span>.canvas_.style.width = <span class="string">'100%'</span>;</span><br><span class="line">	  <span class="keyword">this</span>.canvas_.style.height = <span class="string">'100%'</span>;</span><br><span class="line">	  <span class="keyword">this</span>.canvas_.className = ol.css.CLASS_UNSELECTABLE;</span><br><span class="line">	  container.insertBefore(<span class="keyword">this</span>.canvas_, container.childNodes[<span class="number">0</span>] || <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>渲染逻辑<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ol.renderer.canvas.Map.prototype.renderFrame = <span class="function"><span class="keyword">function</span>(<span class="params">frameState</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-渲染Layer"><a href="#2-渲染Layer" class="headerlink" title="2.渲染Layer"></a>2.渲染Layer</h1><p><code>ol/ol/renderer/layerrenderer.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ol.renderer.Layer = <span class="function"><span class="keyword">function</span>(<span class="params">layer</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  ol.Observable.call(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.layer_ = layer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这只是个父类，具体实现类位置在：<br><code>ol/ol/renderer/canvas/canvaslayerrenderer.js</code>–ol.render.canvas.Layer(默认)<br><code>ol/ol/renderer/canvas/webgllayerrenderer.js</code>–ol.render.webgl.Layer<br><code>ol/ol/renderer/canvas/domlayerrenderer.js</code>–ol.render.dom.Layer</p>
<p>主要介绍第一种ol.render.canvas.Layer(默认)：<br>这个类又分为三种类型：</p>
<ul>
<li>ol.render.canvas.TileLayer</li>
<li>ol.render.canvas.VectorLayer</li>
<li>ol.render.canvas.VectorTileLayer</li>
</ul>
<p><code>ol.render.canvas.TileLayer</code>渲染逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ol.renderer.canvas.TileLayer.prototype.prepareFrame = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    frameState, layerState</span>) </span>&#123;&#125;    <span class="comment">//第一步</span></span><br><span class="line">ol.renderer.canvas.TileLayer.prototype.composeFrame = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="regexp">//</span>第二步</span></span></span><br><span class="line"><span class="function"><span class="params">    frameState, layerState, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> transform = <span class="keyword">this</span>.getTransform(frameState, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">this</span>.dispatchPreComposeEvent(context, frameState, transform);</span><br><span class="line">  <span class="keyword">this</span>.renderTileImages(context, frameState, layerState);</span><br><span class="line">  <span class="keyword">this</span>.dispatchPostComposeEvent(context, frameState, transform);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ol.renderer.canvas.TileLayer.prototype.renderTileImages = <span class="function"><span class="keyword">function</span>(<span class="params">context, frameState, layerState</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>参考文献：</p>
<ul>
<li><a href="http://www.jianshu.com/p/573cde18575a" target="_blank" rel="noopener">OpenLayers 3源码解析视频</a></li>
<li><a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=4&amp;ved=0ahUKEwjV852YrvDNAhVEQo8KHbbAAzwQFgg0MAM&amp;url=%68%74%74%70%3a%2f%2f%77%65%69%6c%69%6e%2e%6d%65%2f%64%6f%63%2f%4f%70%65%6e%4c%61%79%65%72%73%25%32%30%33%25%45%36%25%42%41%25%39%30%25%45%37%25%41%30%25%38%31%25%45%39%25%38%32%25%41%33%25%45%34%25%42%41%25%39%42%25%45%34%25%42%41%25%38%42%28%25%45%34%25%42%38%25%38%41%29%2e%64%6f%63%78&amp;usg=AFQjCNHRsX5ZW6MBpwJUCSEZgOuR7NL4Rw" target="_blank" rel="noopener">OpenLayers 3源码那些事(上)</a></li>
<li><a href="http://weilin.me/ol3-shares/source-explain-2/" target="_blank" rel="noopener">OpenLayers 3源码那些事(下)</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/28/webpack基础实践1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/28/webpack基础实践1/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">webpack基础实践1</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-28 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-28T00:00:00+08:00">2016-09-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 11:06:50" itemprop="dateModified" datetime="2018-11-30T11:06:50+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是个webpack的入门教程，看到网上blog大多是配置好了再解释，这样来的不太直观。本文从第一步开始慢慢做起，一步一步走下来，最后再总结，这样直观看到每个配置行代表什么含义。<br>webpack的作用是什么？现在说太多可能对于入门的同学来说也不好理解，索性这里就记住一句话，一张图得了<br><strong>一张图</strong><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/webpack.png" alt=""><br><strong>一句话</strong><br>webpack是能把各种资源，例如JS(JSX),coffee,样式(CSS/SASS/LESS),图片作为模块来进行打包和处理。</p>
<h1 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h1><h2 id="1-1-安装全局webpack"><a href="#1-1-安装全局webpack" class="headerlink" title="1.1 安装全局webpack"></a>1.1 安装全局webpack</h2><p>前提是在本地先安装了<code>node.js</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install webpack -g</span><br></pre></td></tr></table></figure>
<h2 id="1-2-将依赖写入package-json"><a href="#1-2-将依赖写入package-json" class="headerlink" title="1.2 将依赖写入package.json"></a>1.2 将依赖写入package.json</h2><p>新建的话：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br></pre></td></tr></table></figure>
<p>一路回车就可以，其实这些都是项目的描述信息和git地址等信息，这些信息我们可以后面再文件中直接修改<br>如果是clone的项目，已经有package.json文件了，就运行命令(忽略步骤<code>1.3</code>,<code>2.3</code>引入css加载器部分)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure></p>
<h2 id="1-3-安装局部webpack"><a href="#1-3-安装局部webpack" class="headerlink" title="1.3 安装局部webpack"></a>1.3 安装局部webpack</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack --save-dev</span><br></pre></td></tr></table></figure>
<h1 id="2-开始使用"><a href="#2-开始使用" class="headerlink" title="2.开始使用"></a>2.开始使用</h1><h2 id="2-1-起步"><a href="#2-1-起步" class="headerlink" title="2.1 起步"></a>2.1 起步</h2><p><code>entry.js</code>作为我们的入口文件，其中会包含其他模块(js)或者是CSS    </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.write(<span class="string">"入口entry.js"</span>);</span><br></pre></td></tr></table></figure>
<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"bundle.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行webpack命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ webpack ./entry.js bundle.js</span><br></pre></td></tr></table></figure></p>
<p>然后index.html就可以work了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">入口entry.js</span><br></pre></td></tr></table></figure></p>
<h2 id="2-2-引入其他模块"><a href="#2-2-引入其他模块" class="headerlink" title="2.2 引入其他模块"></a>2.2 引入其他模块</h2><p><code>content.js</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="string">"模块content.js"</span>;</span><br></pre></td></tr></table></figure></p>
<p><code>entry.js</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.write(<span class="built_in">require</span>(<span class="string">"./content.js"</span>));</span><br></pre></td></tr></table></figure></p>
<p>编译命令同上<br>运行index.html结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">模块content.js</span><br></pre></td></tr></table></figure></p>
<h2 id="2-3-引入CSS"><a href="#2-3-引入CSS" class="headerlink" title="2.3 引入CSS"></a>2.3 引入CSS</h2><p>引入css加载器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install css-loader --save-dev</span><br><span class="line">npm install style-loader --save-dev</span><br></pre></td></tr></table></figure>
<p>style.css</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: yellow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>entry.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"!style!css!./style.css"</span>);</span><br><span class="line"><span class="built_in">document</span>.write(<span class="built_in">require</span>(<span class="string">"./content.js"</span>));</span><br></pre></td></tr></table></figure>
<p>最后编译，就是这么简单随意完成了，如果我们想这样<code>require(&quot;./style.css&quot;);</code>引入css，岂不是更加完美<br>使用编译命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack ./entry.js bundle.js --module-bind <span class="string">'css=style!css'</span></span><br></pre></td></tr></table></figure>
<h2 id="2-4-引入SASS文件"><a href="#2-4-引入SASS文件" class="headerlink" title="2.4 引入SASS文件"></a>2.4 引入SASS文件</h2><p>引入sass加载器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install node-sass --save-dev</span><br><span class="line">npm install sass-loader --save-dev</span><br></pre></td></tr></table></figure>
<p>index.scss<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同css一样<br>entry.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"!style!css!sass!./index.scss"</span>);</span><br></pre></td></tr></table></figure>
<p>当然我们还不是很满意。简单点，编译命令的方式简单点。所以我们来到了配置文件</p>
<h1 id="3-配置文件"><a href="#3-配置文件" class="headerlink" title="3.配置文件"></a>3.配置文件</h1><p>新建文件<code>webpack.config.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: <span class="string">"./entry.js"</span>,</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: __dirname,</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        loaders: [</span><br><span class="line">            &#123; <span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">loader</span>: <span class="string">"style!css"</span> &#125;,<span class="comment">//css加载器</span></span><br><span class="line">            &#123; <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">loader</span>: <span class="string">"style!css!sass"</span> &#125;<span class="comment">//sass加载器</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>编译命令就剩下这样的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack</span><br></pre></td></tr></table></figure></p>
<h1 id="5-图片的打包"><a href="#5-图片的打包" class="headerlink" title="5.图片的打包"></a>5.图片的打包</h1><p>图片是用url-loader加载的。css中的url属性，其实就是一种封装过的require操作。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install url-loader --save-dev</span><br><span class="line">npm install file-loader --save-dev</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">test</span>: <span class="regexp">/\.(jpg|png)$/</span>, <span class="attr">loader</span>: <span class="string">"url?limit=8192"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>在js中 entry.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>); </span><br><span class="line">img.src = <span class="built_in">require</span>(<span class="string">"./img/webpack.png"</span>); </span><br><span class="line"><span class="built_in">document</span>.body.appendChild(img);</span><br></pre></td></tr></table></figure>
<p>或者直接在css中写<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span><span class="selector-class">.img</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    background: url("./img/font-icon.png");//小于8kb的图片会打包处理成Base64的图片</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="6-常用webpack编译命令"><a href="#6-常用webpack编译命令" class="headerlink" title="6.常用webpack编译命令"></a>6.常用webpack编译命令</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">webpack //基本命令</span><br><span class="line">webpack --progress --colors //显示打包过程</span><br><span class="line">webpack -w //实时进行打包更新，文件改变时候，自动打包</span><br><span class="line">webpack -p // 对打包后的文件进行压缩，提供production</span><br><span class="line">webpack -d // 提供<span class="built_in">source</span> map，方便调试。</span><br></pre></td></tr></table></figure>
<p>关于对图片打包 AMD/CommonJS/ES6的使用在下一篇博客中<code>webpack基础实践2</code><br>参考文章</p>
<ul>
<li><a href="http://webpack.github.io/docs/tutorials/getting-started/" target="_blank" rel="noopener">webpack官网-getting-start</a>    </li>
<li><a href="http://www.cnblogs.com/YikaJ/p/4586703.html" target="_blank" rel="noopener">webpack前端模块加载工具</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/27/EChart 2升级EChart 3注意事项/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/27/EChart 2升级EChart 3注意事项/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">EChart 2升级EChart 3注意事项</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-27 19:28:35" itemprop="dateCreated datePublished" datetime="2016-09-27T19:28:35+08:00">2016-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:54:24" itemprop="dateModified" datetime="2018-11-30T10:54:24+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文是根据自己的实践进行总结过来的，是不完全的所有升级注意事项。<br>如果想直接看结果，请移步到第4部分内容</p>
<h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h1><p><a href="http://echarts.baidu.com/index.html" target="_blank" rel="noopener">EChart 3</a>是在2015年12月发布的新版本,相比较<a href="http://echarts.baidu.com/echarts2/" target="_blank" rel="noopener">EChart 2</a>,主要的变化总结如下：</p>
<ul>
<li>1) 支持了直角坐标系（catesian，同 grid）、极坐标系（polar）、地理坐标系（geo）</li>
<li>2) 移动端的优化,说明白就是将源码体积减小</li>
<li>3) 新增更多图表类型，增加了一些动态效果</li>
<li>4) 更丰富的交互模式</li>
<li>5) EChart 2推荐使用模块化单文件引入，EChart 3可以选择独立文件或者在webpack中使用模块化(在第2部分说明)</li>
<li>6) 异步数据加载与更新(在第3部分说明)。</li>
</ul>
<h1 id="2-模块-非模块"><a href="#2-模块-非模块" class="headerlink" title="2 模块/非模块"></a>2 模块/非模块</h1><h2 id="2-1-EChart-2模块化引入"><a href="#2-1-EChart-2模块化引入" class="headerlink" title="2.1 EChart 2模块化引入"></a>2.1 EChart 2模块化引入</h2><p>EChart 2自带有模块化机制，不用使用其它AMD/CMD库就可以require进来echarts提供的模块<br>EChart 2 引入进来的目录结构：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/echart%202%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" alt=""><br>示例代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ECharts<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 为ECharts准备一个具备大小（宽高）的Dom --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">style</span>=<span class="string">"height:400px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ECharts单文件引入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://echarts.baidu.com/build/dist/echarts.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 路径配置</span></span><br><span class="line"><span class="undefined">        require.config(&#123;</span></span><br><span class="line"><span class="undefined">            paths: &#123;</span></span><br><span class="line"><span class="undefined">                echarts: 'http://echarts.baidu.com/build/dist'</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="undefined">        // 使用</span></span><br><span class="line"><span class="undefined">        require(</span></span><br><span class="line"><span class="undefined">            [</span></span><br><span class="line"><span class="undefined">                'echarts',</span></span><br><span class="line"><span class="undefined">                'echarts/chart/bar' // 使用柱状图就加载bar模块，按需加载</span></span><br><span class="line"><span class="undefined">            ],</span></span><br><span class="line"><span class="undefined">            function (ec) &#123;</span></span><br><span class="line"><span class="undefined">                // 基于准备好的dom，初始化echarts图表</span></span><br><span class="line"><span class="undefined">                var myChart = ec.init(document.getElementById('main')); </span></span><br><span class="line"><span class="undefined">                </span></span><br><span class="line"><span class="undefined">                var option = &#123;</span></span><br><span class="line"><span class="undefined">                    tooltip: &#123;</span></span><br><span class="line"><span class="undefined">                        show: true</span></span><br><span class="line"><span class="undefined">                    &#125;,</span></span><br><span class="line"><span class="undefined">                    legend: &#123;</span></span><br><span class="line"><span class="undefined">                        data:['销量']</span></span><br><span class="line"><span class="undefined">                    &#125;,</span></span><br><span class="line"><span class="undefined">                    xAxis : [</span></span><br><span class="line"><span class="undefined">                        &#123;</span></span><br><span class="line"><span class="undefined">                            type : 'category',</span></span><br><span class="line"><span class="undefined">                            data : ["衬衫","羊毛衫","雪纺衫","裤子","高跟鞋","袜子"]</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    ],</span></span><br><span class="line"><span class="undefined">                    yAxis : [</span></span><br><span class="line"><span class="undefined">                        &#123;</span></span><br><span class="line"><span class="undefined">                            type : 'value'</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    ],</span></span><br><span class="line"><span class="undefined">                    series : [</span></span><br><span class="line"><span class="undefined">                        &#123;</span></span><br><span class="line"><span class="undefined">                            "name":"销量",</span></span><br><span class="line"><span class="undefined">                            "type":"bar",</span></span><br><span class="line"><span class="undefined">                            "data":[5, 20, 40, 10, 10, 20]</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    ]</span></span><br><span class="line"><span class="undefined">                &#125;;</span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="undefined">                // 为echarts对象加载数据 </span></span><br><span class="line"><span class="undefined">                myChart.setOption(option); </span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        );</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-2-EChart-2非模块化引入"><a href="#2-2-EChart-2非模块化引入" class="headerlink" title="2.2 EChart 2非模块化引入"></a>2.2 EChart 2非模块化引入</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ECharts<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 为ECharts准备一个具备大小（宽高）的Dom --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">style</span>=<span class="string">"height:400px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ECharts单文件引入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://echarts.baidu.com/build/dist/echarts-all.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 基于准备好的dom，初始化echarts图表</span></span><br><span class="line"><span class="undefined">        var myChart = echarts.init(document.getElementById('main')); </span></span><br><span class="line"><span class="undefined">        </span></span><br><span class="line"><span class="undefined">        var option = &#123;</span></span><br><span class="line"><span class="undefined">            tooltip: &#123;</span></span><br><span class="line"><span class="undefined">                show: true</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            legend: &#123;</span></span><br><span class="line"><span class="undefined">                data:['销量']</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            xAxis : [</span></span><br><span class="line"><span class="undefined">                &#123;</span></span><br><span class="line"><span class="undefined">                    type : 'category',</span></span><br><span class="line"><span class="undefined">                    data : ["衬衫","羊毛衫","雪纺衫","裤子","高跟鞋","袜子"]</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            ],</span></span><br><span class="line"><span class="undefined">            yAxis : [</span></span><br><span class="line"><span class="undefined">                &#123;</span></span><br><span class="line"><span class="undefined">                    type : 'value'</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            ],</span></span><br><span class="line"><span class="undefined">            series : [</span></span><br><span class="line"><span class="undefined">                &#123;</span></span><br><span class="line"><span class="undefined">                    "name":"销量",</span></span><br><span class="line"><span class="undefined">                    "type":"bar",</span></span><br><span class="line"><span class="undefined">                    "data":[5, 20, 40, 10, 10, 20]</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            ]</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        // 为echarts对象加载数据 </span></span><br><span class="line"><span class="undefined">        myChart.setOption(option); </span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-3-EChart-3模块化引入"><a href="#2-3-EChart-3模块化引入" class="headerlink" title="2.3 EChart 3模块化引入"></a>2.3 EChart 3模块化引入</h2><p><strong>通过npm命令安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install echarts --save</span><br></pre></td></tr></table></figure>
<p><strong>按需引入 ECharts 图表和组件</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 ECharts 主模块</span></span><br><span class="line"><span class="keyword">var</span> echarts = <span class="built_in">require</span>(<span class="string">'echarts/lib/echarts'</span>);</span><br><span class="line"><span class="comment">// 引入柱状图</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'echarts/lib/chart/bar'</span>);</span><br><span class="line"><span class="comment">// 引入提示框和标题组件</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'echarts/lib/component/tooltip'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'echarts/lib/component/title'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于准备好的dom，初始化echarts实例</span></span><br><span class="line"><span class="keyword">var</span> myChart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">'main'</span>));</span><br><span class="line"><span class="comment">// 绘制图表</span></span><br><span class="line">myChart.setOption(&#123;</span><br><span class="line">    title: &#123; <span class="attr">text</span>: <span class="string">'ECharts 入门示例'</span> &#125;,</span><br><span class="line">    tooltip: &#123;&#125;,</span><br><span class="line">    xAxis: &#123;</span><br><span class="line">        data: [<span class="string">"衬衫"</span>,<span class="string">"羊毛衫"</span>,<span class="string">"雪纺衫"</span>,<span class="string">"裤子"</span>,<span class="string">"高跟鞋"</span>,<span class="string">"袜子"</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    yAxis: &#123;&#125;,</span><br><span class="line">    series: [&#123;</span><br><span class="line">        name: <span class="string">'销量'</span>,</span><br><span class="line">        type: <span class="string">'bar'</span>,</span><br><span class="line">        data: [<span class="number">5</span>, <span class="number">20</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">20</span>]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="2-4-EChart-3非模块化引入"><a href="#2-4-EChart-3非模块化引入" class="headerlink" title="2.4 EChart 3非模块化引入"></a>2.4 EChart 3非模块化引入</h2><p>同2.2类似</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"echarts.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="3-异步数据加载与更新"><a href="#3-异步数据加载与更新" class="headerlink" title="3.异步数据加载与更新"></a>3.异步数据加载与更新</h1><p>由于地图模块分辨率变高，为了不增大源码的体积，地图模块采用按照需要下载引入<br>在<a href="http://echarts.baidu.com/download-map.html" target="_blank" rel="noopener">地图下载页面</a>,下载需要的世界地图/中国地图/中国分省地图，下载后的格式有js和json两种。<br>对应js格式的，引入的方式是通过script标签</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"echarts.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"map/js/china.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> chart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">'main'</span>));</span></span><br><span class="line"><span class="undefined">chart.setOption(&#123;</span></span><br><span class="line"><span class="undefined">    series: [&#123;</span></span><br><span class="line"><span class="javascript">        type: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="javascript">        map: <span class="string">'china'</span></span></span><br><span class="line"><span class="undefined">    &#125;]</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过JSON格式引入就可以实现异步数据加载与更新</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$.get(<span class="string">'map/json/china.json'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chinaJson</span>) </span>&#123;</span><br><span class="line">    echarts.registerMap(<span class="string">'china'</span>, chinaJson);</span><br><span class="line">    <span class="keyword">var</span> chart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">'main'</span>));</span><br><span class="line">    chart.setOption(&#123;</span><br><span class="line">        series: [&#123;</span><br><span class="line">            type: <span class="string">'map'</span>,</span><br><span class="line">            map: <span class="string">'china'</span></span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="4-升级总结"><a href="#4-升级总结" class="headerlink" title="4.升级总结"></a>4.升级总结</h1><h2 id="4-1-配置变化举例"><a href="#4-1-配置变化举例" class="headerlink" title="4.1 配置变化举例"></a>4.1 配置变化举例</h2><table>
<thead>
<tr>
<th>EChart 2</th>
<th style="text-align:center">EChart 3</th>
</tr>
</thead>
<tbody>
<tr>
<td>option.series.mapLocation</td>
<td style="text-align:center">删去，使用left，top，bottom，right定义位置</td>
</tr>
<tr>
<td>option.series.textFixed</td>
<td style="text-align:center">删去地区的名称文本位置修正</td>
</tr>
<tr>
<td>dataRange颜色标识属性(示例4.1-1)</td>
<td style="text-align:center">visualMap</td>
</tr>
<tr>
<td>单个echarts 实例中最多只能存在一个 grid 组件</td>
<td style="text-align:center">ECharts 3 中可以存在任意个 grid 组件</td>
</tr>
</tbody>
</table>
<p>一个网格中(示例4.1-2)|<br>| addData , setSeries 方法设置配置项|统一使用setOption(示例4.1-3)|<br>|级联this.myChart = ec.init(dom).showLoading({effect:’bubble’}).hideLoading();|不支持|<br>| myChart.component.tooltip.showTip 这种形式调用相应的接口触发图表行为|dispatchAction(示例4.1-4)|<br>示例4.1-1</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">     dataRange: &#123;</span><br><span class="line">         realtime: <span class="literal">false</span>,</span><br><span class="line">         itemHeight: <span class="number">80</span>,</span><br><span class="line">         splitNumber:<span class="number">6</span>,</span><br><span class="line">         borderWidth:<span class="number">1</span>, </span><br><span class="line">         textStyle: &#123; <span class="attr">color</span>: <span class="string">'#333333'</span> &#125;,</span><br><span class="line">         text: [<span class="string">'高'</span>, <span class="string">'低'</span>],</span><br><span class="line">         calculable: <span class="literal">true</span></span><br><span class="line">     &#125;,</span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line">    visualMap: &#123;</span><br><span class="line">        min: <span class="number">0</span>,</span><br><span class="line">        max: <span class="number">1000000</span>,</span><br><span class="line">        text: [<span class="string">'High'</span>, <span class="string">'Low'</span>],</span><br><span class="line">        realtime: <span class="literal">false</span>,</span><br><span class="line">        calculable: <span class="literal">true</span>,</span><br><span class="line">        inRange: &#123;</span><br><span class="line">            color: [<span class="string">'lightskyblue'</span>, <span class="string">'yellow'</span>, <span class="string">'orangered'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>示例4.1-2<br>图略，官网例子：<a href="http://echarts.baidu.com/gallery/editor.html?c=scatter-anscombe-quartet" target="_blank" rel="noopener">http://echarts.baidu.com/gallery/editor.html?c=scatter-anscombe-quartet</a><br>部分配置属性变化，需要修改</p>
<p>示例4.1-3</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">myChart.setOption(&#123;</span><br><span class="line">    visualMap: &#123;</span><br><span class="line">        inRange: &#123;</span><br><span class="line">            color: ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)<span class="comment">//注意最后一定要再次setOption(option);option是配置对象</span></span><br></pre></td></tr></table></figure>
<p>示例4.1-4</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">myChart.on(<span class="string">'brushselected'</span>, renderBrushed);</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    self.myChart.dispatchAction(&#123;</span><br><span class="line">        type: <span class="string">'brush'</span>,</span><br><span class="line">        areas: [&#123;</span><br><span class="line">            geoIndex: <span class="number">0</span>,</span><br><span class="line">            brushType: <span class="string">'polygon'</span>,</span><br><span class="line">            coordRange: [</span><br><span class="line">                [<span class="number">119.72</span>, <span class="number">34.85</span>],</span><br><span class="line">                [<span class="number">117.05</span>, <span class="number">34.06</span>],</span><br><span class="line">                [<span class="number">117.49</span>, <span class="number">33.75</span>],</span><br><span class="line">                [<span class="number">123.16</span>, <span class="number">29.92</span>],</span><br><span class="line">                [<span class="number">121.64</span>, <span class="number">34.08</span>]</span><br><span class="line">            ]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderBrushed</span>(<span class="params">params</span>) </span>&#123; <span class="comment">//... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-第2部分的模块与非模块更改时候需要注意"><a href="#4-2-第2部分的模块与非模块更改时候需要注意" class="headerlink" title="4.2 第2部分的模块与非模块更改时候需要注意"></a>4.2 第2部分的模块与非模块更改时候需要注意</h2><h2 id="4-3-地图模块"><a href="#4-3-地图模块" class="headerlink" title="4.3 地图模块"></a>4.3 地图模块</h2><p>EChart 2:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chart.setOption(&#123;</span><br><span class="line">    series: [&#123;</span><br><span class="line">        type: <span class="string">'map'</span>,</span><br><span class="line">        map: <span class="string">'china'</span><span class="comment">//'world'</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>EChart 3，需要下载地图，使用方式见第3部分。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/27/CSS3--font-face使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/27/CSS3--font-face使用/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">CSS3--font-face使用</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-27 19:27:49" itemprop="dateCreated datePublished" datetime="2016-09-27T19:27:49+08:00">2016-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:52:25" itemprop="dateModified" datetime="2018-11-30T10:52:25+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h1><ul>
<li>@font-face是CSS3中的一个模块，他主要是把自己定义的Web字体嵌入到你的网页中，不用担心兼容性，@font-face在IE4中都支持。</li>
<li>如果是用字体做logo，英文的话字体和图片占用大小差不多，但是中文的字体包一般比较大，最好还是使用图片的形式。</li>
</ul>
<h1 id="2-快速实践"><a href="#2-快速实践" class="headerlink" title="2.快速实践"></a>2.快速实践</h1><ul>
<li><a href="http://www.dafont.com/" target="_blank" rel="noopener">下载字体</a>需要格式为.tff格式的字体文件</li>
<li>搜索Webfont Generator，或者直接使用<a href="https://www.web-font-generator.com/" target="_blank" rel="noopener">该网站</a>提供的服务。这很简单，进入网站后选择.tff字体文件上传，勾选同意的复选框，点击<code>Generate web font</code>，点击<code>Download Package</code>下载，解压缩文件。</li>
<li>使用<br>新建index.css</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">font-face</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">'Happy-Camper-Regular'</span>;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">'../fonts2/Happy-Camper-Regular.eot'</span>);</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">'../fonts2/Happy-Camper-Regular.eot?#iefix'</span>) <span class="built_in">format</span>(<span class="string">'embedded-opentype'</span>), <span class="built_in">url</span>(<span class="string">'../fonts2/Happy-Camper-Regular.woff'</span>) <span class="built_in">format</span>(<span class="string">'woff'</span>), <span class="built_in">url</span>(<span class="string">'../fonts2/Happy-Camper-Regular.ttf'</span>) <span class="built_in">format</span>(<span class="string">'truetype'</span>), <span class="built_in">url</span>(<span class="string">'../fonts2/Happy-Camper-Regular.svg#SingleMaltaRegular'</span>) <span class="built_in">format</span>(<span class="string">'svg'</span>);</span><br><span class="line">    <span class="attribute">font-weight</span>: normal;</span><br><span class="line">    <span class="attribute">font-style</span>: normal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">h2</span><span class="selector-class">.demo</span> &#123;</span><br><span class="line">	<span class="attribute">font-size</span>: <span class="number">100px</span>;</span><br><span class="line">   <span class="attribute">font-family</span>: <span class="string">'Happy-Camper-Regular'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>字体<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"index.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"demo"</span>&gt;</span>hello world!You are my Destiny<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="3-字体icon"><a href="#3-字体icon" class="headerlink" title="3.字体icon"></a>3.字体icon</h1><p>使用某些字体，如：<code>WebSymbols-Regular</code><a href="http://pan.baidu.com/s/1jIO0Y2q" target="_blank" rel="noopener">百度云下载地址</a>，<code>Guifx</code>字体，包括现在开源的比较流行的<code>Font Awesome</code>,使用方法同上。在html文件中如下示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>A<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>B<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>C<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>D<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>F<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>每一行显示的是其对应的图标<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/font-icon.png" alt=""><br>参考文献：</p>
<ul>
<li><a href="http://www.dafont.com/" target="_blank" rel="noopener">下载字体的地方</a></li>
<li><a href="http://www.w3cplus.com/content/css3-font-face" target="_blank" rel="noopener">CSS3 @font-face</a></li>
<li><a href="http://www.w3cplus.com/css3/web-icon-with-font-face" target="_blank" rel="noopener">@font-face制作Web Icon</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/27/javascript面向对象和面向委托/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/27/javascript面向对象和面向委托/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">javascript面向对象和面向委托</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-27 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-27T00:00:00+08:00">2016-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:58:46" itemprop="dateModified" datetime="2018-11-30T10:58:46+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>昨天看了一本书《你不知道的javascript(上)》关于这方面的内容，体会颇深，其中书中讲到的把javascript当作是面向委托的语言比面向对象的解释更加贴切，下面我就简单结合自己的理解，书写阐述一下，也可以作为一种笔记记录。     </p>
<h3 id="1-提取精华——几个重要的方法"><a href="#1-提取精华——几个重要的方法" class="headerlink" title="1. 提取精华——几个重要的方法"></a>1. 提取精华——几个重要的方法</h3><h4 id="1-1-原型链关联"><a href="#1-1-原型链关联" class="headerlink" title="1.1 原型链关联"></a>1.1 原型链关联</h4><ul>
<li>Bar.prototype = Foo.prototype;</li>
<li>Bar.prototype = new Foo();</li>
<li>Bar.prototype = Object.create(Foo.prototype);<br>第一种方式，没有创建Bar.prototype的新对象Bar.prototype直接引用了Foo.prototype，修改Bar.prototype会影响Foo.prototype<br>第二种方式，创建了一个关联Bar.prototype的新对象，new其实是调用Foo的“构造函数”，有些东西会影响到Bar()的后代。<br>第三种方式，Object.create() 方法创建一个拥有指定原型和若干个指定属性的对象。<br>语法：<code>Object.create(proto, [ propertiesObject ])</code><br>参数:proto 一个对象，作为新创建对象的原型。<br>   propertiesObject 可选。该参数对象是一组属性与值，该对象的属性名称将是新创建的对象的属性名称，值是属性描述符（这些属性描述符的结构与Object.defineProperties()的第二个参数一样）<blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="noopener">MDN</a>  </p>
</blockquote>
</li>
</ul>
<p>ES5之前Object.create Poyfill代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">Object</span>.create)&#123;</span><br><span class="line">	<span class="built_in">Object</span>.create = <span class="function"><span class="keyword">function</span>(<span class="params">o</span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line">		F.prototype = o;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> F();  <span class="comment">//new的作用参见上述 第二种方式</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ES5:<code>Object.setPrototypeOf(Bar.prototype,Foo.prototype)</code>更加标准可靠</p>
<h4 id="1-2-ES6-class"><a href="#1-2-ES6-class" class="headerlink" title="1.2 ES6 class"></a>1.2 ES6 class</h4><p>内部也是通过原型链实现的，只是一种语法糖。</p>
<h3 id="2-针尖麦芒——面向对象-OO-VS-面向委托-对象关联-OLOO"><a href="#2-针尖麦芒——面向对象-OO-VS-面向委托-对象关联-OLOO" class="headerlink" title="2.针尖麦芒——面向对象(OO) VS 面向委托(对象关联 OLOO)"></a>2.针尖麦芒——面向对象(OO) VS 面向委托(对象关联 OLOO)</h3><ul>
<li><p>OO：类的继承是复制行为，简单说关系是父子关系<br>OLOO： 只是对象的关联(基于原型/原型链)，简单说关系是兄弟关系，互相关联。</p>
</li>
<li><p>代码<br>OO风格：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params">who</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.name = who;</span><br><span class="line">&#125;</span><br><span class="line">Foo.prototype.identity = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"I am "</span>+<span class="keyword">this</span>.name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Bar</span>(<span class="params">who</span>)</span>&#123;</span><br><span class="line">	Foo.call(<span class="keyword">this</span>,who);</span><br><span class="line">&#125;</span><br><span class="line">Bar.prototype = <span class="built_in">Object</span>.create(Foo.prototype);</span><br><span class="line"></span><br><span class="line">Bar.prototype.speak = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	alert(<span class="string">"hello,"</span>+<span class="keyword">this</span>.identity()+<span class="string">" ."</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b1 = <span class="keyword">new</span> Bar(<span class="string">'b1'</span>);</span><br><span class="line"><span class="keyword">var</span> b2 = <span class="keyword">new</span> Bar(<span class="string">'b2'</span>);</span><br><span class="line">b1.speak();</span><br><span class="line">b2.speak();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>OLOO风格：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Foo = &#123;</span><br><span class="line">       init: <span class="function"><span class="keyword">function</span>(<span class="params">who</span>) </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.name = who;</span><br><span class="line">       &#125;,</span><br><span class="line">       identity: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"I am "</span> + <span class="keyword">this</span>.name;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   Bar = <span class="built_in">Object</span>.create(Foo);</span><br><span class="line">   Bar.speak = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       alert(<span class="string">"hello,"</span> + <span class="keyword">this</span>.identity() + <span class="string">" ."</span>);</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> b1 = <span class="built_in">Object</span>.create(Bar);</span><br><span class="line">   b1.init(<span class="string">'b1'</span>);</span><br><span class="line">   <span class="keyword">var</span> b2 = <span class="built_in">Object</span>.create(Bar);</span><br><span class="line">   b2.init(<span class="string">'b2'</span>);</span><br><span class="line">   b1.speak();</span><br><span class="line">   b2.speak();</span><br></pre></td></tr></table></figure></p>
<h3 id="3-问题探究"><a href="#3-问题探究" class="headerlink" title="3.问题探究"></a>3.问题探究</h3><p><strong>内省：</strong>我们想看Foo和Bar之间的关系<br>OO:对比的是Bar.prototype与Foo的关系，并不是Bar和Foo的关系<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(Bar.prototype <span class="keyword">instanceof</span> Foo);  <span class="comment">//true</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getPrototypeOf(Bar.prototype) === Foo.prototype);<span class="comment">//true</span></span><br><span class="line"><span class="built_in">console</span>.log(Foo.prototype.isPrototypeOf(Bar.prototype));<span class="comment">//true</span></span><br></pre></td></tr></table></figure></p>
<p>OLOO:是Bar和Foo的关系<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getPrototypeOf(Bar) === Foo);</span><br><span class="line"><span class="built_in">console</span>.log(Foo.isPrototypeOf(Bar));</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/27/HTTP协议实践篇--使用fiddle与后台php交互/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/27/HTTP协议实践篇--使用fiddle与后台php交互/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">HTTP协议实践篇--使用Fiddler与后台php交互</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-27 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-27T00:00:00+08:00">2016-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:56:19" itemprop="dateModified" datetime="2018-11-30T10:56:19+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HTTP-TCP-IP/" itemprop="url" rel="index"><span itemprop="name">HTTP/TCP/IP</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>工具：</p>
<ul>
<li>PHP、Apache服务器，端口号这里设置为8000,如果本机没有安装php环境，可以选择wamp或者xampp集成的php环境开发器</li>
<li><a href="http://www.telerik.com/fiddler" target="_blank" rel="noopener">fiddler</a>是比较好用的抓包工具，它是免费的，具体使用我们不单独介绍。</li>
</ul>
<h1 id="1-模拟form表单提交数据"><a href="#1-模拟form表单提交数据" class="headerlink" title="1.模拟form表单提交数据"></a>1.模拟form表单提交数据</h1><p><strong>html表单写法</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1:8000/test.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>method改为<code>post</code>,<code>get</code>去体会它们的区别</p>
<ul>
<li>最大的区别是<code>get</code>方式，提交的话会将提交的数据放在url中，如<code>http://127.0.0.1:8000/test.php?name=hello</code><br><code>post</code>请求提交的name=hello会放在header请求体内，具体位置在【<strong>报文主体</strong>】<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/1/http1.jpg" alt=""></li>
<li>get传送的数据量较小，不能大于2KB。post传送的数据量较大，一般被默认为不受限制。但理论上，IIS4中最大量为80KB，IIS5中为100KB</li>
<li>其实，两种方式都可以向服务器传送数据，向服务器上获取数据。<br><strong>test.php</strong></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    $name1 = $_POST[<span class="string">'name'</span>];</span><br><span class="line">    $name2 = $_GET[<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$name1"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$name2"</span>;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>完整的请求头是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST http://127.0.0.1:8000/test.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8000</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 10</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: null</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line"></span><br><span class="line">name=hello</span><br></pre></td></tr></table></figure>
<p>最后的结果，分别两种方式提交，总会有一个会显示没有定义,一个显示出请求的数据</p>
<p>下面就用Fiddler模拟</p>
<ul>
<li>使用<code>post</code>方式<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/1/http2.jpg" alt=""><br><code>Content-Type</code>不能忽略<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 10</span><br><span class="line">Host: 127.0.0.1:8000</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>点击右上角【Execute】，就能模拟一个form表单提交数据了。<br>右边会显示一条我们刚刚的HTTP请求。</p>
<ul>
<li>使用<code>get</code>方式<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/1/http3.jpg" alt=""><br>【Execute】执行</li>
</ul>
<h1 id="2-模拟文件操作"><a href="#2-模拟文件操作" class="headerlink" title="2.模拟文件操作"></a>2.模拟文件操作</h1><h2 id="2-1-上传文件"><a href="#2-1-上传文件" class="headerlink" title="2.1 上传文件"></a>2.1 上传文件</h2><p>post方式提交请求，很少会用get方式去请求文件<br><strong>html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1:8000/test/upload_file.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"file"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>php</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    $name = $_POST[<span class="string">'name'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$name"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];<span class="comment">//$_FILES["file"]通过 HTTP POST 方式上传到当前脚本的项目的数组。</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file_exists(<span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>])) &#123;</span><br><span class="line">      <span class="keyword">echo</span> $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>] . <span class="string">" already exists. "</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>],</span><br><span class="line">      <span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Stored in: "</span> . <span class="string">"upload/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>请求头文件</strong></p>
<ul>
<li>在chrome中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST http://127.0.0.1:8000/test/upload_file.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8000</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 291</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: null</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryC1Pk1uMWXzAMqRMF</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryC1Pk1uMWXzAMqRMF</span><br><span class="line">Content-Disposition: form-data; name=&quot;name&quot;</span><br><span class="line"></span><br><span class="line">wenjian</span><br><span class="line">------WebKitFormBoundaryC1Pk1uMWXzAMqRMF</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">This is a txt.</span><br><span class="line">------WebKitFormBoundaryC1Pk1uMWXzAMqRMF--</span><br></pre></td></tr></table></figure>
<ul>
<li>在Firfox中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST http://127.0.0.1:8000/test/upload_file.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8000</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------31340552315478</span><br><span class="line">Content-Length: 302</span><br><span class="line"></span><br><span class="line">-----------------------------31340552315478</span><br><span class="line">Content-Disposition: form-data; name=&quot;name&quot;</span><br><span class="line"></span><br><span class="line">txt文件</span><br><span class="line">-----------------------------31340552315478</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">This is a txt.</span><br><span class="line">-----------------------------31340552315478--</span><br></pre></td></tr></table></figure>
<p>其中最大的差异也就是<code>boundary</code>分界线<br>分界线里的是上传文件的信息，如果是个图片，我们会看到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;CCGIS2.png&quot;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">//下面这些是图片的信息</span><br></pre></td></tr></table></figure></p>
<p><strong>响应头信息</strong>差别并不大<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Tue, 20 Sep 2016 06:48:58 GMT</span><br><span class="line">Server: Apache/2.4.16 (Win64) PHP/5.6.13</span><br><span class="line">X-Powered-By: PHP/5.6.13</span><br><span class="line">Content-Length: 43</span><br><span class="line">Keep-Alive: timeout=5, max=100</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">wenjian&lt;br&gt;1.txt&lt;br&gt;Stored in: upload/1.txt</span><br></pre></td></tr></table></figure></p>
<p><strong>用Fiddler模拟</strong><br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/1/http4.jpg" alt=""><br>这里的头信息完全是照抄在chrome请求的头信息，其中最重要的是<code>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryC1Pk1uMWXzAMqRMF</code>,我们用这一行就可以去执行，当然Fiddler会自动加入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Host: 127.0.0.1:8000</span><br><span class="line">Content-Length: 295</span><br></pre></td></tr></table></figure></p>
<p>有意思的是我们在<code>Request Body</code>中可以修改<code>filename</code>就可以修改上传后的文件名，我们也可以添加些内容，上传到服务器端。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryC1Pk1uMWXzAMqRMF</span><br><span class="line">Content-Disposition: form-data; name=&quot;name&quot;</span><br><span class="line"></span><br><span class="line">wenjian</span><br><span class="line">------WebKitFormBoundaryC1Pk1uMWXzAMqRMF</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;3.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">This is a txt. 这里是加入的内容 hahahha 哈哈哈</span><br><span class="line">------WebKitFormBoundaryC1Pk1uMWXzAMqRMF--</span><br></pre></td></tr></table></figure></p>
<p>我们甚至可以修改boundary:<code>Content-Type: multipart/form-data; boundary=----123456</code><br>那么<code>Request Body</code>中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">------123456</span><br><span class="line">Content-Disposition: form-data; name=&quot;name&quot;</span><br><span class="line"></span><br><span class="line">wenjian</span><br><span class="line">------123456</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;4.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">This is a txt.hahahha 哈哈哈</span><br><span class="line">------123456</span><br></pre></td></tr></table></figure></p>
<p>值得一提的是，<code>Ruqest Body</code>右边的<code>Upload File</code>可以将选择的文件放在请求体中。注意修改<code>name</code>属性，与php文件的获取字段相同。</p>
<h2 id="2-2-请求文件"><a href="#2-2-请求文件" class="headerlink" title="2.2 请求文件"></a>2.2 请求文件</h2><p>请求文件其实很简单<br>POST/GET <a href="http://127.0.0.1:8000/test/upload/1.txt" target="_blank" rel="noopener">http://127.0.0.1:8000/test/upload/1.txt</a><br>【Excute】执行即可</p>
<p>既然我们是来实践HTTP协议的，那么很重要的文件缓存这方面的我们也可以实践，这些内容我打算单独写一篇博客</p>
<p>———————–华丽的分界线—————————-<br>感觉这些技术很基础，但是也很黑客，我们完全可以使用这些技术去“黑”些网站，哈哈，当然要遵纪守法，当然有这些技术还是不够的。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/27/File Input多次添加文件，用来实现上传等操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/27/File Input多次添加文件，用来实现上传等操作/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">File Input多次添加文件，动态删除文件，用来实现上传等操作</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-27 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-27T00:00:00+08:00">2016-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:55:51" itemprop="dateModified" datetime="2018-11-30T10:55:51+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端技术/" itemprop="url" rel="index"><span itemprop="name">前端技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-需求图示"><a href="#1-需求图示" class="headerlink" title="1.需求图示"></a>1.需求图示</h3><p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/file%20input.png" alt="实现"></p>
<h3 id="2-按图索骥"><a href="#2-按图索骥" class="headerlink" title="2.按图索骥"></a>2.按图索骥</h3><ul>
<li><p>添加 实际上，添加附件就是<code>&lt;input type=&quot;file&quot; id=&quot;myFile&quot;&gt;</code>的控件，<code>var fileList = getElementById(myFile).files</code>就可以得到选择的文件的FileList对象，这个对象是类数组的对象(含义有点像函数参数arguments)。记住这一点很重要。</p>
</li>
<li><p>显示 下面的显示文件名的面板根据上传的文件名<code>name</code>显示</p>
</li>
</ul>
<h3 id="3-刨根问底"><a href="#3-刨根问底" class="headerlink" title="3.刨根问底"></a>3.刨根问底</h3><ul>
<li><p>FileList类数组对象<br> <code>console.log(fileList)</code>打印出来的结果显示：   </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	FileList  </span><br><span class="line">0:File  </span><br><span class="line"> lastModified:1446204650848  </span><br><span class="line"> lastModifiedDate:Fri Oct 30 2015 19:30:50 GMT+0800 (中国标准时间)   </span><br><span class="line"> name:<span class="string">"CCGIS.png"</span>    </span><br><span class="line"> size:809542   </span><br><span class="line"> <span class="built_in">type</span>:<span class="string">"image/png"</span>   </span><br><span class="line"> webkitRelativePath:<span class="string">""</span>   </span><br><span class="line">   __proto__:File   </span><br><span class="line">  length:1  </span><br><span class="line">__proto__:FileList</span><br></pre></td></tr></table></figure>
<p> 思考：我们只需要能动态修改fileList即可，第一想法是将它转化为数组进行操作。<br> <code>files = Array.prototype.slice.call(files);</code></p>
</li>
</ul>
<h3 id="4-付诸行动"><a href="#4-付诸行动" class="headerlink" title="4.付诸行动"></a>4.付诸行动</h3><p>动手编程吧：<br>    html很简单，省略<br>    逻辑代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fileInput = <span class="built_in">document</span>.getElementById(<span class="string">'myFile'</span>);</span><br><span class="line">   <span class="keyword">var</span> files = fileInput.files; <span class="comment">//filelist</span></span><br><span class="line"></span><br><span class="line">   $(<span class="string">'#myFile'</span>).on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       files = fileInput.files; <span class="comment">//应该重新获取</span></span><br><span class="line">       <span class="built_in">console</span>.log(files);</span><br><span class="line">       </span><br><span class="line">       files = <span class="built_in">Array</span>.prototype.slice.call(files); <span class="comment">//全部转化为数组</span></span><br><span class="line">       fileLists = fileLists.concat(files);</span><br><span class="line">       <span class="comment">//显示文件名面板</span></span><br><span class="line">       <span class="keyword">if</span> (files.length !== <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">var</span> html = <span class="string">''</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">               html += <span class="string">"&lt;p&gt;"</span> + files[i].name + <span class="string">"&amp;nbsp&amp;nbsp&lt;img class='icon-remove'&gt;&lt;/p&gt;"</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           $(<span class="string">'.upfile-list-mes'</span>).append(html);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*点击叉号可以删除要上传的文件*/</span></span><br><span class="line">   $(<span class="string">'.upfile-list-mes'</span>).on(<span class="string">'click'</span>, <span class="string">'.icon-remove'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> ind = $(<span class="keyword">this</span>).parent().index();</span><br><span class="line">       $(<span class="keyword">this</span>).parent().css(<span class="string">'display'</span>, <span class="string">'none'</span>);</span><br><span class="line">       fileLists.splice(ind, <span class="number">1</span>);<span class="comment">//修改fileLists</span></span><br><span class="line">       <span class="built_in">console</span>.log(fileLists);</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zrysmt.github.io/2016/09/27/HTTP协议实践篇--浏览器缓存总结、利用Fiddler和apache模拟/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ruyi Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="漫漫技术路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/09/27/HTTP协议实践篇--浏览器缓存总结、利用Fiddler和apache模拟/" class="post-title-link" itemprop="https://zrysmt.github.io/page/7/index.html">HTTP协议实践篇--浏览器缓存总结、利用Fiddler和apache模拟</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-27 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-27T00:00:00+08:00">2016-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-30 10:56:19" itemprop="dateModified" datetime="2018-11-30T10:56:19+08:00">2018-11-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HTTP-TCP-IP/" itemprop="url" rel="index"><span itemprop="name">HTTP/TCP/IP</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-浏览器缓存"><a href="#1-浏览器缓存" class="headerlink" title="1.浏览器缓存"></a>1.浏览器缓存</h1><p>废话少说，我们先了解浏览器缓存的知识。<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-1.png" alt=""><br>其中优先级是：Cache-Control&gt;Expires&gt;协商缓存<br>浏览器访问缓存的顺序是：<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-2.png" alt=""></p>
<h1 id="2-浏览器刷新的几种状态"><a href="#2-浏览器刷新的几种状态" class="headerlink" title="2.浏览器刷新的几种状态"></a>2.浏览器刷新的几种状态</h1><ul>
<li><strong>普通模式</strong> 我们下面的叙述在没有特殊说明的情况下就是这个模式</li>
<li><strong>普通页面跳转</strong>（点击页面链接跳转，window.open，在地址栏敲回车，刷新页面）<ul>
<li>无缓存情况下，请求会返回所有资源结果</li>
<li>设置Expires并且未过期时，浏览器将不会发出http请求</li>
<li>如果Expires过期，则会发送相应请求，并附带上Last-Modifed等信息，供服务器校验</li>
</ul>
</li>
<li><strong>页面刷新(F5)</strong><br> 这种情况一下，一般会看到很多304的请求，就是说即便资源设置了Expires且未过期，浏览器也会发送相应请求，<strong>命中协商缓存</strong>。</li>
<li><strong>强制刷新(Ctrl+F5)</strong><br> 效果和无缓存时候一致，返回200的结果</li>
</ul>
<h1 id="3-强缓存"><a href="#3-强缓存" class="headerlink" title="3.强缓存"></a>3.强缓存</h1><p>返回的http状态为<strong>200</strong>，在chrome的开发者工具的network里面size会显示为from cache</p>
<h2 id="3-1-Cache-Control"><a href="#3-1-Cache-Control" class="headerlink" title="3.1 Cache-Control"></a>3.1 Cache-Control</h2><p>请求指令<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-3.png" alt=""><br>响应指令<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-4.png" alt=""><br>这里需要注意<code>no-cache</code>对客户端和服务器含义是不同的，见下图<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-5.png" alt=""></p>
<h2 id="3-2-Expires"><a href="#3-2-Expires" class="headerlink" title="3.2 Expires"></a>3.2 Expires</h2><p>资源失效的日期<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Expires:  Wed, 21 Sep 2016 12:06:44 GMT</span><br></pre></td></tr></table></figure></p>
<hr>
<p><strong>实践：</strong></p>
<h2 id="实践3-1-html文件中"><a href="#实践3-1-html文件中" class="headerlink" title="实践3-1 html文件中"></a>实践3-1 html文件中</h2><p>在html文件<head><meta name="generator" content="Hexo 3.8.0">中</head></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"cache-control"</span> <span class="attr">content</span>=<span class="string">"no-cache"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"expires"</span> <span class="attr">content</span>=<span class="string">"Wed, 25 Oct 2016 13:19:55 GMT"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这些方法不常用，而且测试不能通过</p>
<h2 id="实践3-2-PHP中设置"><a href="#实践3-2-PHP中设置" class="headerlink" title="实践3-2 PHP中设置"></a>实践3-2 PHP中设置</h2><p>可以使用php设置，当然也可以在apche服务器中进行设置<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">"Cache-Control: public"</span>);</span><br><span class="line">header(<span class="string">"Pragma: cache"</span>);</span><br><span class="line">$offset = <span class="number">30</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>; <span class="comment">// cache 1 month</span></span><br><span class="line">$ExpStr = <span class="string">"Expires: "</span>.gmdate(<span class="string">"D, d M Y H:i:s"</span>, time() + $offset).<span class="string">" GMT"</span>;</span><br><span class="line">header($ExpStr);</span><br></pre></td></tr></table></figure></p>
<p>chrome network工具栏显示<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-6.png" alt=""><br><strong>打开浏览器新窗口的方式测试，而不是F5刷新</strong><br>chrome network工具栏显示<br><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-7.png" alt=""></p>
<h2 id="实践3-3-不需要PHP"><a href="#实践3-3-不需要PHP" class="headerlink" title="实践3-3 不需要PHP"></a>实践3-3 不需要PHP</h2><p>可以像<a href="http://www.cnblogs.com/vajoy/p/5341664.html" target="_blank" rel="noopener">浅谈浏览器http的缓存机制</a>文中所使用的方法</p>
<ul>
<li>在fildder右下角黑色区域–命令行，输入如：bpu localhost:8000 阻断来自localhost:8000的本地http请求      </li>
<li>点击被拦截的请求，可以在右栏直接修改报文内容（上半区域是请求报文，下半区域是响应报文），点击黄色的“Break on Response”按钮可以执行下一步（把请求发给服务器），点击绿色的按钮“Run to Completion”可以直接完成整个请求过程</li>
</ul>
<hr>
<h1 id="4-协商缓存"><a href="#4-协商缓存" class="headerlink" title="4.协商缓存"></a>4.协商缓存</h1><p>当浏览器对某个资源的请求没有命中强缓存，就会发一个请求到服务器，验证协商缓存是否命中，如果协商缓存命中，请求响应返回的http状态为<strong>304</strong>并且会显示一个Not Modified的字符串</p>
<h2 id="4-1-Last-Modified，If-Modified-Since"><a href="#4-1-Last-Modified，If-Modified-Since" class="headerlink" title="4.1 Last-Modified，If-Modified-Since"></a>4.1 Last-Modified，If-Modified-Since</h2><p>这对名词通常是成对出现的<br><code>last-modified</code>：服务端设置的文档的最后的更新日期<br><code>if-modified-since</code>用于指定这个时间以后的服务器资源，GMT格式</p>
<h2 id="4-2-ETag、If-None-Match-if-match"><a href="#4-2-ETag、If-None-Match-if-match" class="headerlink" title="4.2 ETag、If-None-Match/if-match"></a>4.2 ETag、If-None-Match/if-match</h2><p>这对名词通常也是成对出现的<br><code>ETag</code>用于服务器向客户端传送的代表实体内容特征的标记信息<br><code>If-None-Match/if-match</code>服务器给客户机传送网页的时候，可以传递代表实体内容特征的头字段（ETag），这种头字段被叫做实体标签。当客户机再次向服务端发请求的时候，会使用if-match携带实体标签信息</p>
<hr>
<p><strong>实践：</strong><br><strong>php</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">"Last-Modified:"</span>.gmdate(<span class="string">"D, d M Y H:i:s"</span>) . <span class="string">" GMT"</span> );</span><br></pre></td></tr></table></figure></p>
<p><strong>使用fiddler请求</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如：</span><br><span class="line">If-Modified-Since: Wed, 04 Oct 2016 13:32:30 GMT</span><br><span class="line">Last-Modified: Wed, 05 Oct 2016 13:32:30 GMT</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/zrysmt/mdPics/master/HTTP%E5%8D%8F%E8%AE%AE/2/http2-8.png" alt=""><br>测试了几遍，并没有返回 304，原因不明</p>
<hr>
<p><strong>参考阅读:</strong></p>
<ul>
<li><a href="http://www.111cn.net/phper/php/48528.htm" target="_blank" rel="noopener">php header()函数设置页面Cache缓存</a></li>
<li><a href="http://www.lampweb.org/seo/4/11.html" target="_blank" rel="noopener">在php编程中使用header()函数发送文件头，设置浏览器缓存，加快站点的访问速度</a></li>
<li><a href="http://www.cnblogs.com/vajoy/p/5341664.html" target="_blank" rel="noopener">浅谈浏览器http的缓存机制</a></li>
<li><a href="http://www.imooc.com/article/4475" target="_blank" rel="noopener">HTML meta标签总结与属性的使用介绍</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ruyi Zhao</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">70</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">52</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ruyi Zhao</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
